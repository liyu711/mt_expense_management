<div class="sidebar-nav">
    <div class="nav-group">
        <div class="nav-link nav-group-title" id="admin-options-toggle">
            Basic Data Maintenance
        </div>
        <div class="nav-sublinks" id="admin-options-content">
            <a href="/reset" class="nav-link nav-sublink{% if request.path == '/reset' %} active{% endif %}">Delete Data</a>
            <a href="/modify_po" class="nav-link nav-sublink{% if request.path == '/modify_po' %} active{% endif %}">PO Name</a>
            <a href="/modify_department" class="nav-link nav-sublink{% if request.path == '/modify_department' %} active{% endif %}">BU Name</a>
            <a href="/modify_porject_category" class="nav-link nav-sublink{% if request.path == '/modify_porject_category' %} active{% endif %}">Project Category</a>
            <a href="/modify_staff_categories" class="nav-link nav-sublink{% if request.path == '/modify_staff_categories' %} active{% endif %}">Staff categories</a>
            <div class="nav-link nav-subgroup-title">Modify users</div>
            <a href="/add_user" class="nav-link nav-sublink{% if request.path == '/add_user' %} active{% endif %}">Add user</a>
            <a href="/delete_user" class="nav-link nav-sublink{% if request.path == '/delete_user' %} active{% endif %}">Delete user</a>
            <a href="/modify_user_type" class="nav-link nav-sublink{% if request.path == '/modify_user_type' %} active{% endif %}">Modify user type</a>
        </div>
    </div>
    <div class="nav-group">
        <div class="nav-link nav-group-title" id="create-options-toggle">
            Create Forecast
        </div>
        <div class="nav-sublinks" id="create-options-content">
            <a href="/modify_project" class="nav-link nav-sublink{% if request.path == '/modify_project' %} active{% endif %}">Create Project</a>
            <!-- <a href="/modify_io" class="nav-link nav-sublink{% if request.path == '/modify_io' %} active{% endif %}">Create IO</a> -->
            <a href="/manual_input" class="nav-link nav-sublink{% if request.path == '/manual_input' %} active{% endif %}" id="create-forecast-link">Create forecast</a>
            <a href="/capex_forecast" class="nav-link nav-sublink{% if request.path == '/capex_forecast' %} active{% endif %}">Capex forecast</a>
        </div>
    </div>

    <div class="nav-group">
        <div class="nav-link nav-group-title" id="create-funding-toggle">
            Create Funding
        </div>
        <div class="nav-sublinks" id="create-funding-content">
            <a href="/modify_funding" class="nav-link nav-sublink{% if request.path == '/modify_funding' %} active{% endif %}" id="nav-create-funding">Create funding</a>
        </div>
    </div>

    <div class="nav-group">
        <div class="nav-link nav-group-title" id="create-budgets-toggle">
            Create Budgets
        </div>
        <div class="nav-sublinks" id="create-budgets-content">
            <a href="/upload_budget" class="nav-link nav-sublink{% if request.path == '/upload_budget' %} active{% endif %}" id="nav-upload-budget">Create budget</a>
            <!-- <a href="/modify_funding" class="nav-link nav-sublink{% if request.path == '/moidfy_funding' %} active{% endif %}">Create funding</a> -->
            <a href="/capex_budget" class="nav-link nav-sublink{% if request.path == '/capex_budget' %} active{% endif %}">Capex budget</a>
        </div>
    </div>

    <div class="nav-group">
        <div class="nav-link nav-group-title" id="data-visualization-toggle">
            Data Visualization
        </div>
        <div class="nav-sublinks" id="data-visualization-content">
            <a href="/select" class="nav-link nav-sublink{% if request.path == '/select' %} active{% endif %}" id="nav-select">Display Raw Data</a>
            <a href="/data_summary" class="nav-link nav-sublink{% if request.path == '/data_summary' %} active{% endif %}" id="nav-data-summary">Data Summary</a>
            <a href="/project_summary" class="nav-link nav-sublink{% if request.path == '/project_summary' %} active{% endif %}" id="nav-project-summary">Project Summary</a>
            <!-- <a href="/data_vis" class="nav-link nav-sublink{% if request.path == '/data_visualization' %} active{% endif %}">Plot Graphs</a> -->
        </div>
    </div>

    <!-- Remaining links moved to end -->
    <div class="nav-group">
        <div class="nav-link nav-group-title" id="finance-toggle">
            Finance
        </div>
        <div class="nav-sublinks" id="finance-content">
            <a href="/modify_staff_cost" class="nav-link nav-sublink{% if request.path == '/modify_staff_cost' %} active{% endif %}">Modify Staff Cost</a>
            <a href="/file_upload" class="nav-link nav-sublink{% if request.path == '/file_upload' %} active{% endif %}" id="nav-file-upload">Upload actual expenditures or history files</a>
        </div>
    </div>
</div>
<!-- Submenu groups are collapsible with persistent state. -->
<style>
.sidebar-nav {
    position: fixed;
    left: 0;
    top: 0;
    width: 220px;
    height: 100vh;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 32px 0 0 0;
    /* Reserve extra space at the bottom so the last group title (e.g., Finance) never sits flush with the viewport edge */
    padding-bottom: 24px; /* ensure Finance remains fully scrollable & clickable */
    /* Improve scroll behavior, leave room when programmatically scrolled into view */
    scroll-padding-bottom: 120px;
    box-sizing: border-box;
    /* Avoid layout shift when scrollbar appears */
    scrollbar-gutter: stable both-edges;
    border-right: 1px solid #ddd;
    z-index: 100;
    overflow-y: auto;
}
.collapse-arrow { display: none; }
.nav-link {
    display: block;
    width: 100%;
    padding: 16px 16px 16px 32px;
    color: #333;
    text-decoration: none;
    font-size: 1.1em;
    transition: background 0.2s, color 0.2s;
    box-sizing: border-box;
}
.nav-group {
    width: 100%;
}
.nav-group-title {
    font-weight: bold;
    font-size: 1.05em;
    padding: 12px 16px 4px 32px;
    color: #555;
    background: none;
    cursor: pointer;
    user-select: none;
    position: relative;
}
.nav-subgroup-title {
    font-weight: 500;
    font-size: 1em;
    padding: 8px 16px 4px 48px;
    color: #666;
    background: none;
    cursor: default;
}
.nav-sublinks {
    width: 100%;
}
.nav-sublinks.collapsed { display: none; }
.nav-sublink {
    padding-left: 64px;
    font-size: 1em;
}
.nav-link:hover, .nav-link.active {
    background: #007bff;
    color: #fff;
}
/* Simple disclosure arrow driven by aria-expanded on title */
.nav-group-title::after {
        content: '▾';
        position: absolute;
        right: 12px;
        top: 10px;
        color: #888;
}
.nav-group-title[aria-expanded="false"]::after {
        content: '▸';
}
body {
    margin-left: 220px;
}
</style>
<script>
(function(){
    try {
        var nav = document.querySelector('.sidebar-nav');
        if (!nav) return;
        var storageKey = 'sidebar.groups.v1';
        var state = {};
        try { state = JSON.parse(localStorage.getItem(storageKey) || '{}') || {}; } catch(e) { state = {}; }
        var groups = nav.querySelectorAll('.nav-group');
        groups.forEach(function(group, idx){
            var title = group.querySelector('.nav-group-title');
            var content = group.querySelector('.nav-sublinks');
            if (!title || !content) return;
            var key = content.id || title.id || ('group-' + idx);
            var expanded = state.hasOwnProperty(key) ? !!state[key] : true; // default expanded
            // Always expand if group contains the current active link
            if (content.querySelector('.nav-sublink.active')) expanded = true;
            content.classList.toggle('collapsed', !expanded);
            title.setAttribute('role', 'button');
            title.setAttribute('tabindex', '0');
            if (content.id) title.setAttribute('aria-controls', content.id);
            title.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            function toggle(){
                var isCollapsed = content.classList.toggle('collapsed');
                var isExpanded = !isCollapsed;
                title.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
                state[key] = isExpanded;
                try { localStorage.setItem(storageKey, JSON.stringify(state)); } catch(e) {}
            }
            title.addEventListener('click', function(ev){ toggle(); });
            title.addEventListener('keydown', function(ev){ if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); toggle(); } });
        });

        // Persist sidebar scroll position across pages
        var scrollKey = 'sidebar.scrollTop.v1';
        // Restore after groups are initialized so heights are correct
        try {
            var savedTop = localStorage.getItem(scrollKey);
            if (savedTop !== null) {
                var top = parseInt(savedTop, 10);
                if (!isNaN(top)) nav.scrollTop = top;
            }
        } catch(e) {}
        // Save on scroll (debounced) and also on unload/pagehide
        var saveScroll = function(){
            try { localStorage.setItem(scrollKey, String(nav.scrollTop)); } catch(e) {}
        };
        var scrollTimer = null;
        nav.addEventListener('scroll', function(){
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(saveScroll, 120);
        });
        window.addEventListener('beforeunload', saveScroll);
        window.addEventListener('pagehide', saveScroll);
        document.addEventListener('visibilitychange', function(){ if (document.visibilityState === 'hidden') saveScroll(); });
    } catch(e) { /* no-op */ }
})();
</script>
