{% extends 'basic_page.html' %}
{% block title %}Manual Input{% endblock %}
{% block page_title %}Manual Input{% endblock %}
{% block head %}
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }

        .form-group label {
            flex: 1 1 33%;
            max-width: 33%;
            min-width: 120px;
            text-align: left;
            margin-right: 12px;
        }

        .form-group select,
        .form-group input[type="text"] {
            flex: 2 1 67%;
            max-width: 67%;
            min-width: 0;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            background: #f0f0f0;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
        }

        .nav-menu button {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px 16px;
        }

        .nav-menu button.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-weight: bold;
        }

        .input-section {
            display: none;
        }

        .input-section.active {
            display: block;
        }

        /* Page flex layout: header 10%, table takes remaining height */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);
            /* adjust if you have headers */
            box-sizing: border-box;
        }

        .page-top {
            flex: 0 0 10vh;
            /* 10% of viewport height */
            padding-left: 24px;
            box-sizing: border-box;
        }

        .table-container {
            /* Let table take all remaining vertical space under the header */
            flex: 1 1 auto;
            min-height: 0; /* allows child to size and scroll properly in flex container */
            padding-left: 24px;
            box-sizing: border-box;
            overflow: auto;
            /* allow scrolling inside each table area */
        }
    </style>
{% endblock %}
{% block content %}
    <div class="page-wrapper">
        <div class="page-top">
            <!-- Add button to open modal for manual forecast input -->
            <button id="add_button" type="button">Add</button>
            <!-- Modify button to open modal for updating existing forecasts -->
            <button id="modify_button" type="button">Modify</button>
        </div>
        {% from 'components/movable_modal.html' import movable_modal %}

        <!-- Movable modal for forecast input -->
        {% call movable_modal('forecastModal','Forecast Input (Personnel & Non-Personnel)', overlay_id='forecastModalOverlay', close_id='forecastModalClose') %}
            <form method="POST" action="/upload_forecast" id="upload_forecast">
                    <div class="form-group">
                        <label for="PO">PO</label>
                        <select name="PO" id="po_select" required>
                            <option value="">Select PO</option>
                            {% for po in pos %}
                            <option value="{{ po.name }}" data-po-id="{{ po.id }}">{{ po.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Department">BU</label>
                        <select name="Department" id="department_select" required>
                            <option value="">Select BU</option>
                            {% for dept in departments %}
                            {# dept is dict with keys id, name, po_id #}
                            <option value="{{ dept.name }}" data-po-id="{{ dept.po_id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fiscal_year">Fiscal Year</label>
                        <select name="fiscal_year" required>
                            <option value="">Select Year</option>
                            {% for y in range(2020, 2036) %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Project_Name">Project Name</label>
                        <select name="Project_Name" required>
                            <option value="">Select Project Name</option>
                            {% for proj in projects %}
                            <option value="{{ proj }}">{{ proj }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="Project_Category">Project Category</label>
                        <input type="text" name="Project_Category" required value="{{ project_categories[0] if project_categories|length > 0 else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="IO">IO</label>
                        <input type="text" name="IO" required value="{{ ios[0] if ios|length > 0 else '' }}">
                    </div>
                    <div class="form-group">
                        <label>Human Resource FTEs</label>
                        <div id="hr_fte_container" style="flex:2 1 67%; max-width:67%;">
                            <!-- Per-category FTE inputs will be injected here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Non_personnel_cost">Non-personnel Expense</label>
                        <input type="text" name="Non_personnel_cost">
                    </div>
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="forecastModalCancel">Cancel</button>
                    </div>
                </form>
        {% endcall %}

        <!-- Movable modal for modifying forecasts -->
        {% call movable_modal('modifyForecastModal','Modify Forecast (Personnel & Non-Personnel)', overlay_id='modifyForecastModalOverlay', close_id='modifyForecastModalClose') %}
            <form method="POST" action="/manual_input/change_forecast" id="modify_forecast">
                    <div class="form-group">
                        <label for="PO_modify">PO</label>
                        <select name="PO" id="po_select_modify" required>
                            <option value="" selected disabled>Select PO</option>
                            {% for po in pos %}
                            <option value="{{ po.name }}">{{ po.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Department_modify">BU</label>
                        <select name="Department" id="department_select_modify" required>
                            <option value="" selected disabled>Select BU</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fiscal_year_modify">Fiscal Year</label>
                        <select name="fiscal_year" id="fiscal_year_modify" required>
                            <option value="" selected disabled>Select Fiscal Year</option>
                            {% for y in range(2020, 2036) %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Project_Name_modify">Project Name</label>
                        <select name="Project_Name" id="project_name_modify" required>
                            <option value="" selected disabled>Select Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Project_Category_modify">Project Category</label>
                        <input type="text" name="Project_Category" id="project_category_modify" required value="" readonly style="background:#f9f9f9; cursor:not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="IO_modify">IO</label>
                        <input type="text" name="IO" id="io_modify" required value="" readonly style="background:#f9f9f9; cursor:not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Human Resource FTEs</label>
                        <div id="hr_fte_container_modify" style="flex:2 1 67%; max-width:67%;">
                            <!-- Per-category FTE inputs for modify form will be injected here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Non_personnel_cost_modify">Non-personnel Expense</label>
                        <input type="number" name="Non_personnel_cost" id="Non_personnel_cost_modify" step="0.01" inputmode="decimal" pattern="^-?\\d+(?:\\.\\d{1,4})?$" style="width:100%;">
                    </div>
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="modifyForecastModalCancel">Cancel</button>
                    </div>
                </form>
        {% endcall %}

        <!-- Display combined project forecasts table (GenericTable) -->
        {% if combined_forecast_columns %}
        <div class="table-container">
            <h3>Project Forecasts</h3>
            <div id="gt-forecasts" style="height:100%;" data-cols='{{ combined_forecast_columns|tojson|safe }}' data-rows='{{ (combined_forecast_data or [])|tojson|safe }}' data-group-start='{{ (personnel_group_columns or [])|first }}' data-group-end='{{ (personnel_group_columns or [])|last }}'></div>
        </div>
        {% endif %}

        <!-- Populate Project Category dropdown when Project_Name changes -->
        <script>
            // Populate Project Category dropdown when Project_Name changes
            (function () {
                function rebuildCategoryOptions(options) {
                    // Support both select and input elements for Project_Category.
                    var sel = document.querySelector('select[name="Project_Category"]');
                    var inp = document.querySelector('input[name="Project_Category"]');
                    if (sel) {
                        var current = sel.value;
                        while (sel.firstChild) sel.removeChild(sel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select Project Category';
                        sel.appendChild(placeholder);
                        options.forEach(function (c) {
                            var opt = document.createElement('option');
                            opt.value = c;
                            opt.textContent = c;
                            sel.appendChild(opt);
                        });
                        if (current && Array.from(sel.options).some(function (o) { return o.value === current; })) {
                            sel.value = current;
                        } else {
                            sel.value = '';
                        }
                    } else if (inp) {
                        // For input, set its value to the first option if available, otherwise clear.
                        var prev = inp.value || '';
                        if (prev && options.some(function (o) { return String(o) === String(prev); })) {
                            // keep previous if still valid
                            inp.value = prev;
                        } else if (options.length > 0) {
                            inp.value = options[0];
                        } else {
                            inp.value = '';
                        }
                    }
                }

                function fetchAndRebuildCategories(project) {
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/project_categories' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.project_categories) return;
                        rebuildCategoryOptions(data.project_categories);
                    }).catch(function () { });
                }

                function attachProjectHandlers() {
                    var projectSelects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    projectSelects.forEach(function (sel) {
                        sel.addEventListener('change', function () {
                            var val = sel.value || '';
                            // notify server selection (existing endpoint)
                            fetch('/manual_input/project_selection', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: val })
                            }).catch(function () { }).finally(function () {
                                // If project cleared, clear Project Category and IO inputs/selects
                                if (!val) {
                                    try {
                                        var catSel = document.querySelector('select[name="Project_Category"]');
                                        var catInp = document.querySelector('input[name="Project_Category"]');
                                        if (catSel) { catSel.selectedIndex = 0; }
                                        if (catInp) { catInp.value = ''; }
                                        var ioSel = document.querySelector('select[name="IO"]');
                                        var ioInp = document.querySelector('input[name="IO"]');
                                        if (ioSel) { ioSel.selectedIndex = 0; }
                                        if (ioInp) { ioInp.value = ''; }
                                    } catch (e) { }
                                }
                                // refresh dependent fields: categories and IOs
                                try { fetchAndRebuildCategories(val); } catch (e) { /* ignore */ }
                                try { fetchAndRebuildIOs(val); } catch (e) { /* ignore */ }
                            });
                        });
                    });
                }

                // Also fetch and rebuild IO select based on project selection
                function rebuildIOOptions(options) {
                    // Support both select and input elements for IO.
                    var sel = document.querySelector('select[name="IO"]');
                    var inp = document.querySelector('input[name="IO"]');
                    if (sel) {
                        var current = sel.value;
                        while (sel.firstChild) sel.removeChild(sel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select IO';
                        sel.appendChild(placeholder);
                        options.forEach(function (i) {
                            var opt = document.createElement('option');
                            opt.value = i;
                            opt.textContent = i;
                            sel.appendChild(opt);
                        });
                        if (current && Array.from(sel.options).some(function (o) { return o.value === String(current); })) {
                            sel.value = current;
                        } else {
                            sel.value = '';
                        }
                    } else if (inp) {
                        var prev = inp.value || '';
                        if (prev && options.some(function (o) { return String(o) === String(prev); })) {
                            inp.value = prev;
                        } else if (options.length > 0) {
                            inp.value = options[0];
                        } else {
                            inp.value = '';
                        }
                    }
                }

                function fetchAndRebuildIOs(project) {
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/ios' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !Array.isArray(data.ios)) return;
                        rebuildIOOptions(data.ios);
                    }).catch(function () { });
                }

                // Ensure categories are initialized on load (in case a project is preselected)
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    attachProjectHandlers();
                    // if there is already a selected project in UI, fetch categories and IOs for it
                    var firstProj = document.querySelector('select[name="Project_Name"]');
                    if (firstProj && firstProj.value) {
                        fetchAndRebuildCategories(firstProj.value);
                        fetchAndRebuildIOs(firstProj.value);
                    }
                } else {
                    document.addEventListener('DOMContentLoaded', function () { 
                        attachProjectHandlers(); 
                        var f = document.querySelector('select[name="Project_Name"]'); 
                        if (f && f.value) {
                            fetchAndRebuildCategories(f.value);
                            fetchAndRebuildIOs(f.value);
                        }
                    });
                }
            })();
        </script>
        <script>
            // Per-category HR cost updater based on FTE and /api/hr_cost (hierarchical by PO/Department)
            (function(){
                function parseNum(v){ var n = parseFloat(v); return isNaN(n) ? 0 : n; }
                function getFY(){
                    var modifyFy = document.querySelector('#modify_forecast select[name="fiscal_year"]');
                    if (modifyFy && modifyFy.value) return modifyFy.value;
                    var addFy = document.querySelector('#upload_forecast select[name="fiscal_year"]');
                    return addFy ? addFy.value : '';
                }
                function collectCats(scope){
                    var formSelector = scope === 'modify' ? '#modify_forecast' : '#upload_forecast';
                    var list = [];
                    var hidden = Array.from(document.querySelectorAll(formSelector + ' input[name^="cat__"]'));
                    hidden.forEach(function(h){ list.push({ slug: h.name.replace('cat__',''), name: h.value, scope: scope }); });
                    return list;
                }
                var costCache = {}; // key: name|year|po|dept -> base cost
                function fetchBaseCost(name, year){
                    var poVal = '';
                    var deptVal = '';
                    var poAdd = document.getElementById('po_select');
                    var deptAdd = document.getElementById('department_select');
                    var poMod = document.getElementById('po_select_modify');
                    var deptMod = document.getElementById('department_select_modify');
                    if (poMod && poMod.value) poVal = poMod.value; else if (poAdd && poAdd.value) poVal = poAdd.value;
                    if (deptMod && deptMod.value) deptVal = deptMod.value; else if (deptAdd && deptAdd.value) deptVal = deptAdd.value;
                    var key = [name, year, poVal, deptVal].join('|');
                    if (costCache.hasOwnProperty(key)) return Promise.resolve(costCache[key]);
                    if (!name || !year) return Promise.resolve(null);
                    var qs = new URLSearchParams({category: name, year: year});
                    if (poVal) qs.append('po', poVal);
                    if (deptVal) qs.append('department', deptVal);
                    return fetch('/api/hr_cost?' + qs.toString())
                        .then(function(r){ return r.json(); })
                        .then(function(j){ var c = (j && j.cost != null) ? parseNum(j.cost) : null; costCache[key] = c; return c; })
                        .catch(function(){ costCache[key] = null; return null; });
                }
                function updateOne(cat){
                    var year = getFY();
                    var spanId = cat.scope === 'modify' ? 'cost_modify__' + cat.slug : 'cost__' + cat.slug;
                    var span = document.getElementById(spanId);
                    var formSel = cat.scope === 'modify' ? '#modify_forecast' : '#upload_forecast';
                    var fteInput = document.querySelector(formSel + ' input[name="fte__' + cat.slug + '"]');
                    if (!span || !fteInput){ return; }
                    if (!year){ span.textContent = 'Cost: --'; return; }
                    fetchBaseCost(cat.name, year).then(function(base){
                        var fte = parseNum(fteInput.value);
                        if (base == null){ span.textContent = 'Cost: N/A'; return; }
                        var total = base * fte;
                        span.textContent = 'Cost: ' + (fte === 0 ? '0.00' : total.toFixed(2));
                    });
                }
                function updateAll(){
                    collectCats('add').forEach(updateOne);
                    collectCats('modify').forEach(updateOne);
                }
                function bindFte(scope){
                    var formSel = scope === 'modify' ? '#modify_forecast' : '#upload_forecast';
                    var inputs = Array.from(document.querySelectorAll(formSel + ' input[name^="fte__"]'));
                    inputs.forEach(function(inp){
                        inp.addEventListener('input', function(){
                            var slug = inp.getAttribute('data-slug') || inp.name.replace('fte__','');
                            var catNameInput = document.querySelector(formSel + ' input[name="cat__' + slug + '"]');
                            var cat = { slug: slug, name: catNameInput ? catNameInput.value : '', scope: scope };
                            updateOne(cat);
                        });
                        inp.addEventListener('blur', function(){ if (inp.value !== ''){ inp.value = parseNum(inp.value).toFixed(1); } });
                    });
                }
                function bindFY(){
                    var fyAdd = document.querySelector('#upload_forecast select[name="fiscal_year"]');
                    var fyMod = document.querySelector('#modify_forecast select[name="fiscal_year"]');
                    [fyAdd, fyMod].forEach(function(fy){ if (fy){ fy.addEventListener('change', function(){ costCache = {}; updateAll(); }); }});
                }
                // expose helpers for after rebuilding HR inputs
                window.updateAllHrCosts = updateAll;
                window.bindHrFteListeners = function(){ bindFte('add'); bindFY(); };
                window.bindHrFteListenersModify = function(){ bindFte('modify'); bindFY(); };
                // initial bind on DOM ready
                function init(){ bindFte('add'); bindFte('modify'); bindFY(); }
                if (document.readyState === 'complete' || document.readyState === 'interactive') init(); else document.addEventListener('DOMContentLoaded', init);
                // when opening Add or Modify, rebind and compute shortly after
                var addBtn = document.getElementById('add_button');
                if (addBtn){ addBtn.addEventListener('click', function(){ setTimeout(function(){ bindFte(); updateAll(); }, 100); }); }
                var modifyBtn = document.getElementById('modify_button');
                if (modifyBtn){ modifyBtn.addEventListener('click', function(){ setTimeout(function(){ bindFte('modify'); updateAll(); }, 100); }); }
                // Invalidate cache and recompute when hierarchy changes
                ['po_select','department_select','po_select_modify','department_select_modify'].forEach(function(id){
                    var el = document.getElementById(id);
                    if (el){ el.addEventListener('change', function(){ costCache = {}; updateAll(); }); }
                });
            })();
        </script>
        <!-- GenericTable for forecasts display -->
        <script src="{{ url_for('static', filename='js/genericTable.js') }}"></script>
        <script>
            (function(){
                function mount(elId){
                    var el = document.getElementById(elId);
                    if(!el || !window.GenericTable || !GenericTable.create) return;
                    try{
                        var cols = JSON.parse(el.getAttribute('data-cols') || '[]');
                        var data = JSON.parse(el.getAttribute('data-rows') || '[]');
                        // Determine personnel cost group boundaries (all HR category columns). We infer by finding contiguous block after known base columns.
                        // Since backend sends HR category columns toward the end, we can use provided first/last marker plus heuristics.
                        var firstCat = el.getAttribute('data-group-start');
                        var lastCat = el.getAttribute('data-group-end');
                        var groupCols = [];
                        if (firstCat && lastCat) {
                            var firstIdx = cols.indexOf(firstCat);
                            var lastIdx = cols.indexOf(lastCat);
                            if (firstIdx >= 0 && lastIdx >= firstIdx) {
                                for (var i = firstIdx; i <= lastIdx; i++) groupCols.push(cols[i]);
                            }
                        }
                        var rows = (data||[]).map(function(arr){ var o={}; (cols||[]).forEach(function(c,i){ o[c] = (arr||[])[i]; }); return o; });
                        // Helper slugify (scoped)
                        function slugify(str){ return String(str||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,''); }
                        // Prefill logic for modify modal when a table row is clicked
                        function prefillModifyModal(modal, row){
                            if(!modal || !row) return;
                            // Reset first to ensure clean state
                            if (typeof window.resetModifyForecastForm === 'function') window.resetModifyForecastForm();
                            // Core elements
                            var poSel = document.getElementById('po_select_modify');
                            var deptSel = document.getElementById('department_select_modify');
                            var fySel = document.getElementById('fiscal_year_modify');
                            var projSel = document.getElementById('project_name_modify');
                            var pcInp = document.getElementById('project_category_modify');
                            var ioInp = document.getElementById('io_modify');
                            var nonpcInp = document.getElementById('Non_personnel_cost_modify');
                            var fiscalYear = row['Fiscal Year'] || row['fiscal_year'];
                            // Set PO immediately
                            if (poSel && row['PO']) { poSel.value = row['PO']; }
                            // Fetch departments for PO then set Department
                            function fetchDepartments(){
                                return new Promise(function(resolve){
                                    if (!row['PO']) return resolve();
                                    fetch('/manual_input/departments?po=' + encodeURIComponent(row['PO']))
                                      .then(r=>r.json()).then(function(j){
                                        if (j && Array.isArray(j.departments) && deptSel){
                                            // rebuild options
                                            while (deptSel.firstChild) deptSel.removeChild(deptSel.firstChild);
                                            var ph = document.createElement('option'); ph.value=''; ph.textContent='Select BU'; deptSel.appendChild(ph);
                                            j.departments.forEach(function(d){
                                                var opt = document.createElement('option');
                                                opt.value = d.name; opt.textContent = d.name; deptSel.appendChild(opt);
                                            });
                                            if (row['Department']) deptSel.value = row['Department'];
                                        }
                                        resolve();
                                      }).catch(function(){ resolve(); });
                                });
                            }
                            function fetchProjects(){
                                return new Promise(function(resolve){
                                    var qs = [];
                                    if (row['PO']) qs.push('po=' + encodeURIComponent(row['PO']));
                                    if (row['Department']) qs.push('department=' + encodeURIComponent(row['Department']));
                                    if (fiscalYear) qs.push('fiscal_year=' + encodeURIComponent(fiscalYear));
                                    var url = '/manual_input/projects' + (qs.length?('?' + qs.join('&')):'');
                                    fetch(url).then(r=>r.json()).then(function(j){
                                        if (j && Array.isArray(j.projects) && projSel){
                                            while (projSel.firstChild) projSel.removeChild(projSel.firstChild);
                                            var ph = document.createElement('option'); ph.value=''; ph.textContent='Select Project'; projSel.appendChild(ph);
                                            j.projects.forEach(function(p){
                                                var opt = document.createElement('option');
                                                opt.value = p.name; opt.textContent = p.name; projSel.appendChild(opt);
                                            });
                                            if (row['Project'] || row['Project Name']) {
                                                var pname = row['Project'] || row['Project Name'];
                                                projSel.value = pname;
                                            }
                                        }
                                        resolve();
                                    }).catch(function(){ resolve(); });
                                });
                            }
                            // Set fiscal year select
                            if (fySel && fiscalYear){ fySel.value = fiscalYear; }
                            // Sequential async population
                            fetchDepartments().then(fetchProjects).then(function(){
                                if (pcInp && row['Project Category']) pcInp.value = row['Project Category'];
                                if (ioInp && row['IO']) ioInp.value = row['IO'];
                                var nonpc = (row['Non-personnel Forecast']!=null && row['Non-personnel Forecast']!=='') ? row['Non-personnel Forecast'] : row['Non-personnel Expense'];
                                if (nonpcInp && nonpc!=null && nonpc!=='') nonpcInp.value = nonpc;
                                // Prefill per-category FTEs by converting cost -> FTE using /api/hr_cost
                                var year = fiscalYear;
                                var promises = [];
                                Object.keys(row).forEach(function(key){
                                    if (['id','PO','Department','Fiscal Year','Project Category','Project','Project Name','IO','Forecast Sum','Non-personnel Forecast'].indexOf(key) >= 0) return;
                                    // Remaining keys are HR categories (cost values)
                                    var costVal = row[key];
                                    if (costVal == null || costVal === '') return;
                                    var catName = key;
                                    var slug = slugify(catName);
                                    var fteInput = document.querySelector('#modify_forecast input[name="fte__' + slug + '"]');
                                    if (!fteInput) return;
                                                                        // fetch base cost using hierarchical context: PO + Department + Fiscal Year
                                                                        var poVal = poSel && poSel.value ? poSel.value : '';
                                                                        var deptVal = deptSel && deptSel.value ? deptSel.value : '';
                                                                        var params = new URLSearchParams({ category: catName, year: String(year) });
                                                                        if (poVal) params.append('po', poVal);
                                                                        if (deptVal) params.append('department', deptVal);
                                                                        promises.push(
                                                                                fetch('/api/hr_cost?' + params.toString())
                                                                                    .then(function(r){ return r.json(); })
                                                                                    .then(function(j){
                                                                                        var base = j && j.cost != null ? parseFloat(j.cost) : null;
                                                                                        var c = parseFloat(costVal);
                                                                                        if (base && base > 0){
                                                                                                var fte = c / base;
                                                                                                fteInput.value = (isFinite(fte)? fte.toFixed(1): '0');
                                                                                        } else {
                                                                                                // fallback can't derive FTE, set 0
                                                                                                fteInput.value = '0';
                                                                                        }
                                                                                    })
                                                                                    .catch(function(){ fteInput.value = '0'; })
                                                                        );
                                });
                                Promise.all(promises).then(function(){
                                    // Recalculate cost spans based on filled FTEs
                                    if (typeof window.updateAllHrCosts === 'function') window.updateAllHrCosts();
                                });
                            });
                        }
                        var api = GenericTable.create(el, {
                            columns: cols,
                            rows: rows,
                            defaultPageSize: 25,
                            groups: groupCols.length ? { 'Personnel Cost': groupCols } : null,
                            rowClickEditModal: {
                                selector: '#modifyForecastModal',
                                prefill: prefillModifyModal,
                                onOpen: function(modal,row){
                                    // Ensure HR cost listeners bound (modify scope)
                                    if (typeof window.bindHrFteListenersModify === 'function') window.bindHrFteListenersModify();
                                    // Focus first field for usability
                                    var first = modal.querySelector('select, input');
                                    if (first) first.focus();
                                }
                            }
                        });

                        // Inject Delete column & buttons after each render/refresh
                        function ensureDeleteHeader(table){
                            var theadRows = table.querySelectorAll('thead tr');
                            var headerRow = null; // second row is actual labels (group row may be first)
                            if (theadRows.length === 1) headerRow = theadRows[0];
                            else if (theadRows.length >= 2) headerRow = theadRows[1];
                            if(!headerRow) return null;
                            // If last header already 'Delete', skip adding
                            var lastHeaderText = headerRow.lastElementChild ? (headerRow.lastElementChild.textContent || '').trim() : '';
                            if (lastHeaderText !== 'Delete'){
                                var th = document.createElement('th');
                                th.textContent = 'Delete';
                                th.style.background = '#f5e5e5';
                                th.style.color = '#a00';
                                th.style.fontWeight = '600';
                                headerRow.appendChild(th);
                                // Add matching filter-row spacer
                                var filterRow = table.querySelector('thead tr:last-child');
                                if(filterRow){
                                    var thf = document.createElement('th');
                                    thf.textContent = '';
                                    filterRow.appendChild(thf);
                                }
                            }
                            return headerRow;
                        }

                        function addDeleteButtons(){
                            try {
                                var table = el.querySelector('table.gt-table');
                                if(!table) return;
                                var headerRow = ensureDeleteHeader(table);
                                if(!headerRow) return;

                                // For each body row append a delete button
                                Array.from(table.querySelectorAll('tbody tr')).forEach(function(tr){
                                    var td = document.createElement('td');
                                    td.style.textAlign = 'center';
                                    var btn = document.createElement('button');
                                    btn.type = 'button';
                                    btn.textContent = 'Delete';
                                    btn.style.background = '#c62828';
                                    btn.style.color = '#fff';
                                    btn.style.border = 'none';
                                    btn.style.padding = '4px 8px';
                                    btn.style.cursor = 'pointer';
                                    btn.style.borderRadius = '4px';
                                    btn.addEventListener('click', function(ev){
                                        ev.stopPropagation();
                                        // Gather key values from the row cells by header names
                                        try {
                                            var cells = Array.from(tr.children);
                                            var headers = Array.from(headerRow.children).map(function(th){ return th.querySelector('.gt-col-label') ? th.querySelector('.gt-col-label').textContent : (th.textContent || ''); });
                                            // Remove trailing 'Delete' header from mapping
                                            if(headers[headers.length-1] === 'Delete') headers.pop();
                                            var rowObj = {};
                                            cells.forEach(function(td,i){
                                                if(i < headers.length){ rowObj[headers[i]] = td.textContent; }
                                            });
                                            // Build payload using expected backend keys
                                            var payload = {
                                                PO: rowObj['PO'],
                                                Department: rowObj['Department'],
                                                'Project': rowObj['Project'] || rowObj['Project Name'],
                                                'Project Category': rowObj['Project Category'],
                                                'Fiscal Year': rowObj['Fiscal Year'] || rowObj['fiscal_year']
                                            };
                                            // Basic guard
                                            if(!payload.PO || !payload.Department || !payload['Project'] || !payload['Project Category'] || !payload['Fiscal Year']){
                                                console.warn('Missing keys for deletion', payload); return;
                                            }
                                            // Optional confirmation
                                            if(!window.confirm('Delete all forecasts for this key (including all IOs & HR categories)?')) return;
                                            fetch('/manual_input/delete_forecast', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                            }).then(function(r){ return r.json().catch(function(){ return {}; }); })
                                            .then(function(resp){
                                                if(resp && resp.status === 'ok'){
                                                    // Remove row from DOM
                                                    tr.parentNode.removeChild(tr);
                                                } else {
                                                    alert('Delete failed: ' + (resp && resp.message ? resp.message : 'Unknown error'));
                                                }
                                            }).catch(function(){ alert('Delete request failed.'); });
                                        } catch(e){ console.warn('Deletion failed to build payload', e); }
                                    });
                                    td.appendChild(btn);
                                    tr.appendChild(td);
                                });
                            } catch(e){ console.warn('Failed to append Delete column', e); }
                        }

                        // Hook into table refresh to re-append buttons after any filtering/paging
                        if (api && typeof api.refresh === 'function'){
                            var origRefresh = api.refresh;
                            api.refresh = function(){ origRefresh(); addDeleteButtons(); };
                        }
                        // Initial add
                        addDeleteButtons();
                    }catch(e){ console.warn('Failed to mount forecasts table', e); }
                }
                if (document.readyState === 'complete' || document.readyState === 'interactive'){
                    mount('gt-forecasts');
                } else {
                    document.addEventListener('DOMContentLoaded', function(){ mount('gt-forecasts'); });
                }
            })();
        </script>
        <script>
            // Modal handlers (aligned with modify_table.html style)
            (function () {
                var addBtn = document.getElementById('add_button');
                var modal = document.getElementById('forecastModal');
                var modalClose = document.getElementById('forecastModalClose');
                var modalOverlay = document.getElementById('forecastModalOverlay');
                var modalCancel = document.getElementById('forecastModalCancel');
                var modifyBtn = document.getElementById('modify_button');
                var modifyModal = document.getElementById('modifyForecastModal');
                var modifyModalClose = document.getElementById('modifyForecastModalClose');
                var modifyModalOverlay = document.getElementById('modifyForecastModalOverlay');
                var modifyModalCancel = document.getElementById('modifyForecastModalCancel');
                function openModal() {
                    // reset form to default state when opening
                    if (typeof window.resetForecastForm === 'function') window.resetForecastForm();
                    modal.style.display = 'block';
                    modal.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden';
                    var firstInput = modal.querySelector('input, select, button');
                    if (firstInput) firstInput.focus();
                }
                function closeModal() {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';
                }
                function openModifyModal() {
                    if (typeof window.resetModifyForecastForm === 'function') window.resetModifyForecastForm();
                    modifyModal.style.display = 'block';
                    modifyModal.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden';
                    var firstInput = modifyModal.querySelector('input, select, button');
                    if (firstInput) firstInput.focus();
                }
                function closeModifyModal() {
                    modifyModal.style.display = 'none';
                    modifyModal.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';
                }
                addBtn && addBtn.addEventListener('click', openModal);
                modalClose && modalClose.addEventListener('click', closeModal);
                modalOverlay && modalOverlay.addEventListener('click', closeModal);
                modalCancel && modalCancel.addEventListener('click', closeModal);
                modifyBtn && modifyBtn.addEventListener('click', openModifyModal);
                modifyModalClose && modifyModalClose.addEventListener('click', closeModifyModal);
                modifyModalOverlay && modifyModalOverlay.addEventListener('click', closeModifyModal);
                modifyModalCancel && modifyModalCancel.addEventListener('click', closeModifyModal);
                document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeModal(); });
            })();
        </script>

        <script>
            // Global reset function and hierarchy helpers for forecast modal
            // Exposed on window so other IIFEs can call it when needed (PO/Department changes)
            window.resetForecastForm = function () {
                try {
                    var form = document.getElementById('upload_forecast');
                    if (!form) return;
                    // Reset all select controls to placeholder (first option)
                    var selects = Array.from(form.querySelectorAll('select'));
                    selects.forEach(function (s) {
                        if (s.options && s.options.length) s.selectedIndex = 0;
                    });
                    // Clear text inputs (Project_Category, IO, Personnel, Non-personnel, etc.)
                    var textInputs = Array.from(form.querySelectorAll('input[type="text"]'));
                    textInputs.forEach(function (i) { i.value = ''; });
                    // Reset all per-category FTE inputs to 0
                    var fteInputs = Array.from(form.querySelectorAll('input[name^="fte__"]'));
                    fteInputs.forEach(function(inp){ inp.value = '0'; });
                    // Reset all per-category cost displays
                    var costSpans = Array.from(form.querySelectorAll('span.hr-cost'));
                    costSpans.forEach(function(sp){ sp.textContent = 'Cost: 0.00'; });
                    // If there are project selects, clear their option lists (keep placeholder)
                    var projSelects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    projSelects.forEach(function (sel) {
                        while (sel.options && sel.options.length > 1) sel.remove(1);
                        sel.value = '';
                    });
                    // Also clear department options (keep placeholder) - used when opening modal
                    var dept = document.getElementById('department_select');
                    if (dept) {
                        while (dept.options && dept.options.length > 1) dept.remove(1);
                        dept.value = '';
                    }
                } catch (e) {
                    console.warn('resetForecastForm failed', e);
                }
            };
        </script>

        
        <script>
            // Send selected PO to server and fetch server-filtered departments for the modal (server-side filtering)
            (function () {
                var poSelect = document.getElementById('po_select');
                var deptSelect = document.getElementById('department_select');
                var poSelectM = document.getElementById('po_select_modify');
                var deptSelectM = document.getElementById('department_select_modify');

                // Build HR FTE inputs in Add modal, and rebuild HR category select in Modify modal
                function slugify(str){
                    return String(str || '')
                        .toLowerCase()
                        .trim()
                        .replace(/[^a-z0-9]+/g, '_')
                        .replace(/^_+|_+$/g, '');
                }
                function buildHrFteInputsAdd(categories){
                    var container = document.getElementById('hr_fte_container');
                    if (!container) return;
                    // Clear existing
                    while (container.firstChild) container.removeChild(container.firstChild);
                    (categories || []).forEach(function(cat){
                        var slug = slugify(cat);
                        var wrap = document.createElement('div');
                        wrap.className = 'form-group';
                        var label = document.createElement('label');
                        label.textContent = cat + ' FTE';
                        label.style.maxWidth = '33%';
                        label.style.flex = '1 1 33%';
                        var input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.name = 'fte__' + slug;
                        input.value = '0';
                        input.setAttribute('data-slug', slug);
                        input.onblur = function(){ if(this.value!==''){ this.value = parseFloat(this.value).toFixed(1); } };
                        input.style.flex = '0 1 25%';
                        input.style.maxWidth = '25%';
                        // per-category cost display
                        var cost = document.createElement('span');
                        cost.className = 'hr-cost';
                        cost.id = 'cost__' + slug;
                        cost.style.marginLeft = '12px';
                        cost.style.color = '#555';
                        cost.textContent = 'Cost: 0.00';
                        // hidden original category name
                        var hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = 'cat__' + slug;
                        hidden.value = cat;
                        wrap.appendChild(label);
                        wrap.appendChild(input);
                        wrap.appendChild(cost);
                        wrap.appendChild(hidden);
                        container.appendChild(wrap);
                    });
                }
                function buildHrFteInputsModify(categories){
                    var container = document.getElementById('hr_fte_container_modify');
                    if (!container) return;
                    while (container.firstChild) container.removeChild(container.firstChild);
                    (categories || []).forEach(function(cat){
                        var slug = slugify(cat);
                        var wrap = document.createElement('div');
                        wrap.className = 'form-group';
                        var label = document.createElement('label');
                        label.textContent = cat + ' FTE';
                        label.style.maxWidth = '33%';
                        label.style.flex = '1 1 33%';
                        var input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.name = 'fte__' + slug;
                        input.value = '0';
                        input.setAttribute('data-slug', slug);
                        input.onblur = function(){ if(this.value!==''){ this.value = parseFloat(this.value).toFixed(1);} };
                        input.style.flex = '0 1 25%';
                        input.style.maxWidth = '25%';
                        var cost = document.createElement('span');
                        cost.className = 'hr-cost-modify';
                        cost.id = 'cost_modify__' + slug;
                        cost.style.marginLeft = '12px';
                        cost.style.color = '#555';
                        cost.textContent = 'Cost: 0.00';
                        var hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = 'cat__' + slug;
                        hidden.value = cat;
                        wrap.appendChild(label);
                        wrap.appendChild(input);
                        wrap.appendChild(cost);
                        wrap.appendChild(hidden);
                        container.appendChild(wrap);
                    });
                }
                function rebuildHrCategoryOptionsModify(options){
                    var hrSelM = document.getElementById('hr_category_modify');
                    if (hrSelM){
                        var currentM = hrSelM.value;
                        while (hrSelM.firstChild) hrSelM.removeChild(hrSelM.firstChild);
                        var placeholderM = document.createElement('option');
                        placeholderM.value = '';
                        placeholderM.textContent = 'Select Human Resource Category';
                        hrSelM.appendChild(placeholderM);
                        (options || []).forEach(function(h){
                            var opt = document.createElement('option');
                            opt.value = h;
                            opt.textContent = h;
                            hrSelM.appendChild(opt);
                        });
                        if (currentM && Array.from(hrSelM.options).some(function(o){ return o.value === currentM; })){
                            hrSelM.value = currentM;
                        } else {
                            hrSelM.value = '';
                        }
                    }
                }

                function fetchAndRebuildHrCategories(){
                    // Always fetch full, unfiltered list from backend
                    fetch('/manual_input/hr_categories')
                        .then(function(res){ return res.json(); })
                        .then(function(json){
                            if (!json || !Array.isArray(json.human_resource_categories)){
                                return; // keep existing options on malformed response
                            }
                            buildHrFteInputsAdd(json.human_resource_categories);
                            buildHrFteInputsModify(json.human_resource_categories);
                            // cost calculators rebind
                            // After building inputs, bind listeners and compute initial costs
                            setTimeout(function(){
                                if (window.bindHrFteListeners) window.bindHrFteListeners();
                                if (window.updateAllHrCosts) window.updateAllHrCosts();
                                if (window.bindHrFteListenersModify) window.bindHrFteListenersModify();
                            }, 50);
                        })
                        .catch(function(){ /* silent failure keeps previous options */ });
                }

                function rebuildDeptOptions(options) {
                    if (!deptSelect) return;
                    // Remember current value to try to preserve selection if still valid
                    var current = deptSelect.value;
                    // Clear all
                    while (deptSelect.firstChild) deptSelect.removeChild(deptSelect.firstChild);
                    // Placeholder
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select BU';
                    deptSelect.appendChild(placeholder);
                    // Add filtered options
                    options.forEach(function (d) {
                        if (!d || !d.name) return;
                        var opt = document.createElement('option');
                        opt.value = d.name;
                        opt.textContent = d.name;
                        if (d.po_id !== undefined && d.po_id !== null) opt.setAttribute('data-po-id', d.po_id);
                        deptSelect.appendChild(opt);
                    });
                    // Try to preserve selection; if not present, reset to placeholder
                    if (current && Array.from(deptSelect.options).some(function (o) { return o.value === current; })) {
                        deptSelect.value = current;
                    } else {
                        deptSelect.value = '';
                    }
                }

                function fetchServerFilteredDepartments() {
                    if (!poSelect || !deptSelect) return;
                    var poVal = poSelect.value || '';
                    if (!poVal) return; // No PO selected: keep current options
                    fetch('/manual_input/departments?po=' + encodeURIComponent(poVal))
                        .then(function (res) { return res.json(); })
                        .then(function (json) {
                            if (json && Array.isArray(json.departments)) rebuildDeptOptions(json.departments);
                        })
                        .catch(function () { /* keep current options on error */ });
                }

                if (poSelect && deptSelect) {
                    // Initialize once on load (handles preselected PO) using server-side filtering
                    fetchServerFilteredDepartments();
                    // Initialize HR categories on load as well
                    fetchAndRebuildHrCategories();
                    // On change: post to server and update UI immediately
                    poSelect.addEventListener('change', function () {
                        var val = poSelect.value || '';
                        // Fire-and-forget server update
                        fetch('/manual_input/po_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ po: val })
                        }).catch(function () { });
                        // If PO is cleared, reset dependent UI and server-side selections
                        if (!val) {
                            // reset entire form except PO itself
                            window.resetForecastForm && window.resetForecastForm();
                            // reset HR FTE inputs as well
                            buildHrFteInputsAdd([]);
                            // notify server that department/fiscal_year/project are cleared
                            fetch('/manual_input/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: '' }) }).catch(function(){});
                            fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: '' }) }).catch(function(){});
                            fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){});
                        } else {
                            // Then fetch server-filtered departments and update UI
                            fetchServerFilteredDepartments();
                            // Also refresh projects list filtered by new PO
                            if (window.fetchAndRebuildProjects) window.fetchAndRebuildProjects();
                            // And refresh HR categories (unfiltered) for FTE inputs
                            fetchAndRebuildHrCategories();
                        }
                    });
                }
                // Modify modal dependencies
                function rebuildDeptOptionsM(options) {
                    if (!deptSelectM) return;
                    var current = deptSelectM.value;
                    while (deptSelectM.firstChild) deptSelectM.removeChild(deptSelectM.firstChild);
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select BU';
                    deptSelectM.appendChild(placeholder);
                    options.forEach(function (d) {
                        var name = d && d.name ? d.name : (typeof d === 'string' ? d : '');
                        if (!name) return;
                        var opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        deptSelectM.appendChild(opt);
                    });
                    if (current && Array.from(deptSelectM.options).some(function (o) { return o.value === current; })) {
                        deptSelectM.value = current;
                    } else {
                        deptSelectM.value = '';
                    }
                }
                function fetchServerFilteredDepartmentsM() {
                    if (!poSelectM || !deptSelectM) return;
                    var poVal = poSelectM.value || '';
                    if (!poVal) return;
                    fetch('/manual_input/departments?po=' + encodeURIComponent(poVal))
                        .then(function (res) { return res.json(); })
                        .then(function (json) {
                            if (json && Array.isArray(json.departments)) rebuildDeptOptionsM(json.departments);
                        })
                        .catch(function () { });
                }
                if (poSelectM && deptSelectM) {
                    fetchServerFilteredDepartmentsM();
                    poSelectM.addEventListener('change', function(){
                        // update server-side selection as well
                        var val = poSelectM.value || '';
                        fetch('/manual_input/po_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ po: val }) }).catch(function(){});
                        fetchServerFilteredDepartmentsM();
                        // refresh HR categories (unfiltered)
                        fetchAndRebuildHrCategories();
                    });
                }
            })();
        </script>
        <script>
            // Fetch projects from server and rebuild all Project_Name selects in the modal/form
            (function () {
                var poSelect = document.getElementById('po_select');
                var deptSelect = document.getElementById('department_select');
                var fySelect = document.querySelector('select[name="fiscal_year"]');
                var poSelectM = document.getElementById('po_select_modify');
                var deptSelectM = document.getElementById('department_select_modify');
                var fySelectM = document.getElementById('fiscal_year_modify');

                function rebuildProjectOptions(options) {
                    // There may be multiple selects named Project_Name in the template; update all
                    var selects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    selects.forEach(function (sel) {
                        var current = sel.value;
                        while (sel.firstChild) sel.removeChild(sel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select Project';
                        sel.appendChild(placeholder);
                        options.forEach(function (p) {
                            var opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = p.name;
                            sel.appendChild(opt);
                        });
                        if (current && Array.from(sel.options).some(function (o) { return o.value === current; })) {
                            sel.value = current;
                        }
                    });
                }

                function fetchAndRebuildProjects() {
                    var po = (poSelect && poSelect.value) ? poSelect.value : '';
                    var dept = (deptSelect && deptSelect.value) ? deptSelect.value : '';
                    var fy = (fySelect && fySelect.value) ? fySelect.value : '';
                    var qs = [];
                    if (po) qs.push('po=' + encodeURIComponent(po));
                    if (dept) qs.push('department=' + encodeURIComponent(dept));
                    if (fy) qs.push('fiscal_year=' + encodeURIComponent(fy));
                    var url = '/manual_input/projects' + (qs.length ? ('?' + qs.join('&')) : '');
                    fetch(url).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.projects) return;
                        rebuildProjectOptions(data.projects);
                        // after rebuilding projects, if a project is selected fetch IOs for it
                        var firstProj = document.querySelector('select[name="Project_Name"]');
                        if (firstProj && firstProj.value) fetchAndRebuildIOs(firstProj.value);
                    }).catch(function () { });
                }
                function rebuildProjectOptionsM(options) {
                    var sel = document.getElementById('project_name_modify');
                    if (!sel) return;
                    var current = sel.value;
                    while (sel.firstChild) sel.removeChild(sel.firstChild);
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select Project';
                    sel.appendChild(placeholder);
                    options.forEach(function (p) {
                        var name = p && p.name ? p.name : (typeof p === 'string' ? p : '');
                        if (!name) return;
                        var opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sel.appendChild(opt);
                    });
                    if (current && Array.from(sel.options).some(function (o) { return o.value === current; })) sel.value = current; else sel.value = '';
                }
                function fetchAndRebuildProjectsM() {
                    var po = (poSelectM && poSelectM.value) ? poSelectM.value : '';
                    var dept = (deptSelectM && deptSelectM.value) ? deptSelectM.value : '';
                    var fy = (fySelectM && fySelectM.value) ? fySelectM.value : '';
                    var qs = [];
                    if (po) qs.push('po=' + encodeURIComponent(po));
                    if (dept) qs.push('department=' + encodeURIComponent(dept));
                    if (fy) qs.push('fiscal_year=' + encodeURIComponent(fy));
                    var url = '/manual_input/projects' + (qs.length ? ('?' + qs.join('&')) : '');
                    fetch(url).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.projects) return;
                        rebuildProjectOptionsM(data.projects);
                        var firstProj = document.getElementById('project_name_modify');
                        if (firstProj && firstProj.value) { fetchAndRebuildCategoriesM(firstProj.value); fetchAndRebuildIOsM(firstProj.value); }
                    }).catch(function () { });
                }

                // Hook up change handlers to refresh projects when department or fiscal year changes
                if (deptSelect) {
                    deptSelect.addEventListener('change', function () {
                        // POST department selection to server (existing) then refresh projects
                        var val = deptSelect.value || '';
                        fetch('/manual_input/department_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department: val })
                        }).catch(function () { }).finally(function () {
                            // If department cleared, enforce hierarchy: clear fiscal year, projects, and inputs
                            if (!val) {
                                try {
                                    var fy = document.querySelector('select[name="fiscal_year"]');
                                    if (fy) fy.selectedIndex = 0;
                                    // clear project selects
                                    var projSelects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                                    projSelects.forEach(function (sel) { while (sel.options && sel.options.length > 1) sel.remove(1); sel.value = ''; });
                                    // clear inputs: Project_Category and IO
                                    var cat = document.querySelector('input[name="Project_Category"]'); if (cat) cat.value = '';
                                    var ioInp = document.querySelector('input[name="IO"]'); if (ioInp) ioInp.value = '';
                                    // notify server that fiscal year and project cleared
                                    fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: '' }) }).catch(function(){});
                                    fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){});
                                } catch (e) { }
                            }
                            fetchAndRebuildProjects();
                        });
                    });
                }
                if (fySelect) {
                    fySelect.addEventListener('change', function () {
                        var val = fySelect.value || '';
                        fetch('/manual_input/fiscal_year_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fiscal_year: val })
                        }).catch(function () { }).finally(function () { fetchAndRebuildProjects(); });
                    });
                }
                if (deptSelectM) {
                    deptSelectM.addEventListener('change', function(){
                        var val = deptSelectM.value || '';
                        fetch('/manual_input/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: val }) }).catch(function () { }).finally(function () { fetchAndRebuildProjectsM(); });
                    });
                }
                if (fySelectM) {
                    fySelectM.addEventListener('change', function(){
                        var val = fySelectM.value || '';
                        fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: val }) }).catch(function () { }).finally(function () { fetchAndRebuildProjectsM(); });
                    });
                }

                // Expose for other scripts in this file to call after PO changes
                window.fetchAndRebuildProjects = fetchAndRebuildProjects;
                window.fetchAndRebuildProjectsM = fetchAndRebuildProjectsM;

                // Initialize on load in case preselected values exist
                if (document.readyState === 'complete' || document.readyState === 'interactive') fetchAndRebuildProjects(); else document.addEventListener('DOMContentLoaded', fetchAndRebuildProjects);
                if (document.readyState === 'complete' || document.readyState === 'interactive') fetchAndRebuildProjectsM(); else document.addEventListener('DOMContentLoaded', fetchAndRebuildProjectsM);
            })();
        </script>
        <script>
            // Send selected Project to manual_input endpoint to update module-level selected_project
            (function () {
                function bindProjectSelects() {
                    var selects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    selects.forEach(function (sel) {
                        sel.addEventListener('change', function () {
                            var val = sel.value || '';
                            fetch('/manual_input/project_selection', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ project: val })
                            }).catch(function () { });
                            // If project cleared, clear Project Category and IO inputs/selects and notify server
                            if (!val) {
                                try {
                                    var catSel = document.querySelector('select[name="Project_Category"]');
                                    var catInp = document.querySelector('input[name="Project_Category"]');
                                    if (catSel) { catSel.selectedIndex = 0; }
                                    if (catInp) { catInp.value = ''; }
                                    var ioSel = document.querySelector('select[name="IO"]');
                                    var ioInp = document.querySelector('input[name="IO"]');
                                    if (ioSel) { ioSel.selectedIndex = 0; }
                                    if (ioInp) { ioInp.value = ''; }
                                } catch (e) { }
                                fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){});
                            } else {
                                // Also refresh IOs for this project selection
                                fetchAndRebuildIOs(val);
                            }
                        });
                    });
                }
                if (document.readyState === 'complete' || document.readyState === 'interactive') bindProjectSelects(); else document.addEventListener('DOMContentLoaded', bindProjectSelects);
                // Re-bind after projects are rebuilt
                var originalFetch = window.fetchAndRebuildProjects;
                if (typeof originalFetch === 'function') {
                    window.fetchAndRebuildProjects = function () { originalFetch(); setTimeout(bindProjectSelects, 50); };
                }
                // Bind project select in modify modal
                function bindProjectSelectModify(){
                    var sel = document.getElementById('project_name_modify');
                    if (!sel) return;
                    sel.addEventListener('change', function(){
                        var val = sel.value || '';
                        fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: val }) }).catch(function () { });
                        if (val) { fetchAndRebuildCategoriesM(val); fetchAndRebuildIOsM(val); }
                    });
                }
                if (document.readyState === 'complete' || document.readyState === 'interactive') bindProjectSelectModify(); else document.addEventListener('DOMContentLoaded', bindProjectSelectModify);
            })();
        </script>
        <script>
            // Send selected Department to manual_input endpoint to update module-level selected_department (manual page specific)
            (function () {
                var deptSelect = document.getElementById('department_select');
                if (!deptSelect) return;
                deptSelect.addEventListener('change', function () {
                    var val = deptSelect.value || '';
                    fetch('/manual_input/department_selection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ department: val })
                    }).catch(function () { });
                });
            })();
        </script>
        <script>
        // Send selected Fiscal Year to manual_input endpoint to update module-level selected_fiscal_year (manual page specific)
        (function () {
            function bindFY(el){
                if (!el) return;
                el.addEventListener('change', function(){
                    var val = el.value || '';
                    fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: val }) }).catch(function () { });
                });
            }
            bindFY(document.querySelector('select[name="fiscal_year"]'));
            bindFY(document.getElementById('fiscal_year_modify'));
        })();
        </script>
        <script>
            // Helpers and reset for Modify modal (categories & IOs)
            (function(){
                function rebuildCategoryOptionsM(options){
                    var inp = document.getElementById('project_category_modify');
                    if (!inp) return;
                    if (options && options.length > 0) inp.value = options[0]; else inp.value = '';
                }
                window.fetchAndRebuildCategoriesM = function(project){
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/project_categories' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.project_categories) return;
                        rebuildCategoryOptionsM(data.project_categories);
                    }).catch(function () { });
                }
                function rebuildIOOptionsM(options){
                    var inp = document.getElementById('io_modify');
                    if (!inp) return;
                    if (options && options.length > 0) inp.value = options[0]; else inp.value = '';
                }
                window.fetchAndRebuildIOsM = function(project){
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/ios' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !Array.isArray(data.ios)) return;
                        rebuildIOOptionsM(data.ios);
                    }).catch(function () { });
                }
                window.resetModifyForecastForm = function(){
                    try{
                        var form = document.getElementById('modify_forecast');
                        if (!form) return;
                        var selects = Array.from(form.querySelectorAll('select'));
                        selects.forEach(function(s){ if (s.options && s.options.length) s.selectedIndex = 0; });
                        var inputs = Array.from(form.querySelectorAll('input[type="text"], input[type="number"]'));
                        inputs.forEach(function(i){ i.value = ''; });
                        // Reset per-category FTEs if present
                        var perFte = Array.from(form.querySelectorAll('input[name^="fte__"]'));
                        perFte.forEach(function(inp){ inp.value = '0'; });
                    }catch(e){ console.warn('resetModifyForecastForm failed', e); }
                }
            })();
        </script>
        <style>
            /* Modal styles reused */
            .modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }

            .modal-overlay {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
            }

            .modal-content {
                position: relative;
                max-width: 760px;
                margin: 60px auto;
                background: #fff;
                border-radius: 6px;
                padding: 20px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                z-index: 2010;
            }

            .modal-close {
                position: absolute;
                right: 10px;
                top: 8px;
                font-size: 24px;
                background: transparent;
                border: none;
                cursor: pointer;
            }
        </style>
        <script src="{{ url_for('static', filename='js/movableModal.js') }}"></script>
    </div>
{% endblock %}
