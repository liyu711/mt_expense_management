<!DOCTYPE html>
<!DOCTYPE html>
<html>

<head>
    <title>Manual Input</title>
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }

        .form-group label {
            flex: 1 1 33%;
            max-width: 33%;
            min-width: 120px;
            text-align: left;
            margin-right: 12px;
        }

        .form-group select,
        .form-group input[type="text"] {
            flex: 2 1 67%;
            max-width: 67%;
            min-width: 0;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            background: #f0f0f0;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
        }

        .nav-menu button {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px 16px;
        }

        .nav-menu button.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-weight: bold;
        }

        .input-section {
            display: none;
        }

        .input-section.active {
            display: block;
        }

        /* Page flex layout: top (rest) 10%, each table 45% */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);
            /* adjust if you have headers */
            box-sizing: border-box;
        }

        .page-top {
            flex: 0 0 10vh;
            /* 10% of viewport height */
            padding-left: 24px;
            box-sizing: border-box;
        }

        .table-container {
            flex: 0 0 45vh;
            /* each table takes 45% of viewport height */
            padding-left: 24px;
            box-sizing: border-box;
            overflow: auto;
            /* allow scrolling inside each table area */
        }
    </style>
    <script>
        // No JS needed: forecast form is always visible on /manual_input
    </script>
</head>

<body>
    {% include 'sidebar.html' %}
    <div class="page-wrapper">
        <div class="page-top">
            <!-- Add button to open modal for manual forecast input -->
            <button id="add_button" type="button">Add</button>
            <!-- Modify button to open modal for updating existing forecasts -->
            <button id="modify_button" type="button">Modify</button>
        </div>

        <!-- Modal for forecast input (hidden by default) -->
        <div id="forecastModal" class="modal" aria-hidden="true" role="dialog">
            <div class="modal-overlay" id="forecastModalOverlay"></div>
            <div class="modal-content">
                <button class="modal-close" id="forecastModalClose" aria-label="Close">&times;</button>
                <h1>Forecast Input (Personnel & Non-Personnel)</h1>
                <form method="POST" action="/upload_forecast" id="upload_forecast">
                    <div class="form-group">
                        <label for="PO">PO</label>
                        <select name="PO" id="po_select" required>
                            <option value="">Select PO</option>
                            {% for po in pos %}
                            <option value="{{ po.name }}" data-po-id="{{ po.id }}">{{ po.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Department">BU</label>
                        <select name="Department" id="department_select" required>
                            <option value="">Select BU</option>
                            {% for dept in departments %}
                            {# dept is dict with keys id, name, po_id #}
                            <option value="{{ dept.name }}" data-po-id="{{ dept.po_id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fiscal_year">Fiscal Year</label>
                        <select name="fiscal_year" required>
                            <option value="">Select Year</option>
                            {% for y in range(2020, 2036) %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Project_Name">Project Name</label>
                        <select name="Project_Name" required>
                            <option value="">Select Project Name</option>
                            {% for proj in projects %}
                            <option value="{{ proj }}">{{ proj }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="Project_Category">Project Category</label>
                        <input type="text" name="Project_Category" required value="{{ project_categories[0] if project_categories|length > 0 else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="IO">IO</label>
                        <input type="text" name="IO" required value="{{ ios[0] if ios|length > 0 else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="Human_resource_category">Human Resource Category</label>
                        <select name="Human_resource_category">
                            <option value="">Select Human Resource Category</option>
                            {% for hrc in human_resource_categories %}
                            <option value="{{ hrc }}">{{ hrc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Human_resource_FTE">Working Time(FTE)</label>
                        <input type="number" step="0.1" name="Human_resource_FTE" id="Human_resource_FTE" value="0"
                            onblur="if(this.value!==''){this.value = parseFloat(this.value).toFixed(1)}">
                    </div>
                    <div class="form-group">
                        <label for="Personnel_cost">Personnel Expense</label>
                        <input type="text" name="Personnel_cost" id="Personnel_cost" readonly>
                    </div>
                    <div class="form-group">
                        <label for="Non_personnel_cost">Non-personnel Expense</label>
                        <input type="text" name="Non_personnel_cost">
                    </div>
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="forecastModalCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for modifying forecasts (hidden by default) -->
        <div id="modifyForecastModal" class="modal" aria-hidden="true" role="dialog">
            <div class="modal-overlay" id="modifyForecastModalOverlay"></div>
            <div class="modal-content">
                <button class="modal-close" id="modifyForecastModalClose" aria-label="Close">&times;</button>
                <h1>Modify Forecast (Personnel & Non-Personnel)</h1>
                <form method="POST" action="/manual_input/change_forecast" id="modify_forecast">
                    <div class="form-group">
                        <label for="PO_modify">PO</label>
                        <select name="PO" id="po_select_modify" required>
                            <option value="" selected disabled>Select PO</option>
                            {% for po in pos %}
                            <option value="{{ po.name }}">{{ po.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Department_modify">BU</label>
                        <select name="Department" id="department_select_modify" required>
                            <option value="" selected disabled>Select BU</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fiscal_year_modify">Fiscal Year</label>
                        <select name="fiscal_year" id="fiscal_year_modify" required>
                            <option value="" selected disabled>Select Fiscal Year</option>
                            {% for y in range(2020, 2036) %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Project_Name_modify">Project Name</label>
                        <select name="Project_Name" id="project_name_modify" required>
                            <option value="" selected disabled>Select Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Project_Category_modify">Project Category</label>
                        <input type="text" name="Project_Category" id="project_category_modify" required value="">
                    </div>
                    <div class="form-group">
                        <label for="IO_modify">IO</label>
                        <input type="text" name="IO" id="io_modify" required value="">
                    </div>
                    <div class="form-group">
                        <label for="Human_resource_category_modify">Human Resource Category</label>
                        <select name="Human_resource_category" id="hr_category_modify">
                            <option value="" selected disabled>Select Human Resource Category</option>
                            {% for hrc in human_resource_categories %}
                            <option value="{{ hrc }}">{{ hrc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Human_resource_FTE_modify">Working Time(FTE)</label>
                        <input type="number" step="0.1" name="Human_resource_FTE" id="Human_resource_FTE_modify" value="0"
                            onblur="if(this.value!==''){this.value = parseFloat(this.value).toFixed(1)}">
                    </div>
                    <div class="form-group">
                        <label for="Non_personnel_cost_modify">Non-personnel Expense</label>
                        <input type="text" name="Non_personnel_cost" id="Non_personnel_cost_modify">
                    </div>
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="modifyForecastModalCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Display project_forecasts_nonpc table (GenericTable) -->
        {% if pf_nonpc_columns and pf_nonpc_data %}
        <div class="table-container">
            <h3>Project Forecasts (non-personnel)</h3>
            <div id="gt-nonpc" style="height:45vh;" data-cols='{{ pf_nonpc_columns|tojson|safe }}' data-rows='{{ pf_nonpc_data|tojson|safe }}'></div>
        </div>
        {% endif %}

        <!-- Display project_forecasts_pc table (GenericTable) -->
        {% if pf_pc_columns and pf_pc_data %}
        <div class="table-container">
            <h3>Project Forecasts (personnel)</h3>
            <div id="gt-pc" style="height:45vh;" data-cols='{{ pf_pc_columns|tojson|safe }}' data-rows='{{ pf_pc_data|tojson|safe }}'></div>
        </div>
        {% endif %}

        <!-- Populate Project Category dropdown when Project_Name changes -->
        <script>
            // Populate Project Category dropdown when Project_Name changes
            (function () {
                function rebuildCategoryOptions(options) {
                    // Support both select and input elements for Project_Category.
                    var sel = document.querySelector('select[name="Project_Category"]');
                    var inp = document.querySelector('input[name="Project_Category"]');
                    if (sel) {
                        var current = sel.value;
                        while (sel.firstChild) sel.removeChild(sel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select Project Category';
                        sel.appendChild(placeholder);
                        options.forEach(function (c) {
                            var opt = document.createElement('option');
                            opt.value = c;
                            opt.textContent = c;
                            sel.appendChild(opt);
                        });
                        if (current && Array.from(sel.options).some(function (o) { return o.value === current; })) {
                            sel.value = current;
                        } else {
                            sel.value = '';
                        }
                    } else if (inp) {
                        // For input, set its value to the first option if available, otherwise clear.
                        var prev = inp.value || '';
                        if (prev && options.some(function (o) { return String(o) === String(prev); })) {
                            // keep previous if still valid
                            inp.value = prev;
                        } else if (options.length > 0) {
                            inp.value = options[0];
                        } else {
                            inp.value = '';
                        }
                    }
                }

                function fetchAndRebuildCategories(project) {
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/project_categories' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.project_categories) return;
                        rebuildCategoryOptions(data.project_categories);
                    }).catch(function () { });
                }

                function attachProjectHandlers() {
                    var projectSelects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    projectSelects.forEach(function (sel) {
                        sel.addEventListener('change', function () {
                            var val = sel.value || '';
                            // notify server selection (existing endpoint)
                            fetch('/manual_input/project_selection', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: val })
                            }).catch(function () { }).finally(function () {
                                // If project cleared, clear Project Category and IO inputs/selects
                                if (!val) {
                                    try {
                                        var catSel = document.querySelector('select[name="Project_Category"]');
                                        var catInp = document.querySelector('input[name="Project_Category"]');
                                        if (catSel) { catSel.selectedIndex = 0; }
                                        if (catInp) { catInp.value = ''; }
                                        var ioSel = document.querySelector('select[name="IO"]');
                                        var ioInp = document.querySelector('input[name="IO"]');
                                        if (ioSel) { ioSel.selectedIndex = 0; }
                                        if (ioInp) { ioInp.value = ''; }
                                    } catch (e) { }
                                }
                                // refresh dependent fields: categories and IOs
                                try { fetchAndRebuildCategories(val); } catch (e) { /* ignore */ }
                                try { fetchAndRebuildIOs(val); } catch (e) { /* ignore */ }
                            });
                        });
                    });
                }

                // Also fetch and rebuild IO select based on project selection
                function rebuildIOOptions(options) {
                    // Support both select and input elements for IO.
                    var sel = document.querySelector('select[name="IO"]');
                    var inp = document.querySelector('input[name="IO"]');
                    if (sel) {
                        var current = sel.value;
                        while (sel.firstChild) sel.removeChild(sel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select IO';
                        sel.appendChild(placeholder);
                        options.forEach(function (i) {
                            var opt = document.createElement('option');
                            opt.value = i;
                            opt.textContent = i;
                            sel.appendChild(opt);
                        });
                        if (current && Array.from(sel.options).some(function (o) { return o.value === String(current); })) {
                            sel.value = current;
                        } else {
                            sel.value = '';
                        }
                    } else if (inp) {
                        var prev = inp.value || '';
                        if (prev && options.some(function (o) { return String(o) === String(prev); })) {
                            inp.value = prev;
                        } else if (options.length > 0) {
                            inp.value = options[0];
                        } else {
                            inp.value = '';
                        }
                    }
                }

                function fetchAndRebuildIOs(project) {
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/ios' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !Array.isArray(data.ios)) return;
                        rebuildIOOptions(data.ios);
                    }).catch(function () { });
                }

                // Ensure categories are initialized on load (in case a project is preselected)
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    attachProjectHandlers();
                    // if there is already a selected project in UI, fetch categories and IOs for it
                    var firstProj = document.querySelector('select[name="Project_Name"]');
                    if (firstProj && firstProj.value) {
                        fetchAndRebuildCategories(firstProj.value);
                        fetchAndRebuildIOs(firstProj.value);
                    }
                } else {
                    document.addEventListener('DOMContentLoaded', function () { 
                        attachProjectHandlers(); 
                        var f = document.querySelector('select[name="Project_Name"]'); 
                        if (f && f.value) {
                            fetchAndRebuildCategories(f.value);
                            fetchAndRebuildIOs(f.value);
                        }
                    });
                }
            })();
        </script>
        <!-- GenericTable for forecasts display -->
        <script src="{{ url_for('static', filename='js/genericTable.js') }}"></script>
        <script>
            (function(){
                function mount(elId){
                    var el = document.getElementById(elId);
                    if(!el || !window.GenericTable || !GenericTable.create) return;
                    try{
                        var cols = JSON.parse(el.getAttribute('data-cols') || '[]');
                        var data = JSON.parse(el.getAttribute('data-rows') || '[]');
                        var rows = (data||[]).map(function(arr){ var o={}; (cols||[]).forEach(function(c,i){ o[c] = (arr||[])[i]; }); return o; });
                        GenericTable.create(el, { columns: cols, rows: rows, defaultPageSize: 25 });
                    }catch(e){}
                }
                if (document.readyState === 'complete' || document.readyState === 'interactive'){
                    mount('gt-nonpc');
                    mount('gt-pc');
                } else {
                    document.addEventListener('DOMContentLoaded', function(){ mount('gt-nonpc'); mount('gt-pc'); });
                }
            })();
        </script>
        <script>
            // Modal handlers (aligned with modify_table.html style)
            (function () {
                var addBtn = document.getElementById('add_button');
                var modal = document.getElementById('forecastModal');
                var modalClose = document.getElementById('forecastModalClose');
                var modalOverlay = document.getElementById('forecastModalOverlay');
                var modalCancel = document.getElementById('forecastModalCancel');
                var modifyBtn = document.getElementById('modify_button');
                var modifyModal = document.getElementById('modifyForecastModal');
                var modifyModalClose = document.getElementById('modifyForecastModalClose');
                var modifyModalOverlay = document.getElementById('modifyForecastModalOverlay');
                var modifyModalCancel = document.getElementById('modifyForecastModalCancel');
                function openModal() {
                    // reset form to default state when opening
                    if (typeof window.resetForecastForm === 'function') window.resetForecastForm();
                    modal.style.display = 'block';
                    modal.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden';
                    var firstInput = modal.querySelector('input, select, button');
                    if (firstInput) firstInput.focus();
                }
                function closeModal() {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';
                }
                function openModifyModal() {
                    if (typeof window.resetModifyForecastForm === 'function') window.resetModifyForecastForm();
                    modifyModal.style.display = 'block';
                    modifyModal.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden';
                    var firstInput = modifyModal.querySelector('input, select, button');
                    if (firstInput) firstInput.focus();
                }
                function closeModifyModal() {
                    modifyModal.style.display = 'none';
                    modifyModal.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';
                }
                addBtn && addBtn.addEventListener('click', openModal);
                modalClose && modalClose.addEventListener('click', closeModal);
                modalOverlay && modalOverlay.addEventListener('click', closeModal);
                modalCancel && modalCancel.addEventListener('click', closeModal);
                modifyBtn && modifyBtn.addEventListener('click', openModifyModal);
                modifyModalClose && modifyModalClose.addEventListener('click', closeModifyModal);
                modifyModalOverlay && modifyModalOverlay.addEventListener('click', closeModifyModal);
                modifyModalCancel && modifyModalCancel.addEventListener('click', closeModifyModal);
                document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeModal(); });
            })();
        </script>

        <script>
            // Global reset function and hierarchy helpers for forecast modal
            // Exposed on window so other IIFEs can call it when needed (PO/Department changes)
            window.resetForecastForm = function () {
                try {
                    var form = document.getElementById('upload_forecast');
                    if (!form) return;
                    // Reset all select controls to placeholder (first option)
                    var selects = Array.from(form.querySelectorAll('select'));
                    selects.forEach(function (s) {
                        if (s.options && s.options.length) s.selectedIndex = 0;
                    });
                    // Clear text inputs (Project_Category, IO, Personnel, Non-personnel, etc.)
                    var textInputs = Array.from(form.querySelectorAll('input[type="text"]'));
                    textInputs.forEach(function (i) { i.value = ''; });
                    // Reset numeric FTE to 0 (match initial markup)
                    var fte = form.querySelector('#Human_resource_FTE');
                    if (fte) fte.value = '0';
                    // Clear personnel cost
                    var personnel = form.querySelector('#Personnel_cost');
                    if (personnel) personnel.value = '';
                    // If there are project selects, clear their option lists (keep placeholder)
                    var projSelects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    projSelects.forEach(function (sel) {
                        while (sel.options && sel.options.length > 1) sel.remove(1);
                        sel.value = '';
                    });
                    // Also clear department options (keep placeholder) - used when opening modal
                    var dept = document.getElementById('department_select');
                    if (dept) {
                        while (dept.options && dept.options.length > 1) dept.remove(1);
                        dept.value = '';
                    }
                } catch (e) {
                    console.warn('resetForecastForm failed', e);
                }
            };
        </script>

        <script>
            (function () {
                function parseNumber(v) {
                    var n = parseFloat(v);
                    return isNaN(n) ? 0 : n;
                }

                function setupHandlers() {
                    var form = document.getElementById('upload_forecast');
                    if (!form) return;
                    var categorySelect = form.querySelector('select[name="Human_resource_category"]');
                    var yearSelect = form.querySelector('select[name="fiscal_year"]');
                    var fteInput = form.querySelector('#Human_resource_FTE');
                    var personnelInput = form.querySelector('#Personnel_cost');

                    function updatePersonnel() {
                        var category = categorySelect ? categorySelect.value : '';
                        var year = yearSelect ? yearSelect.value : '';
                        var fte = fteInput ? parseNumber(fteInput.value) : 0;
                        if (!personnelInput) return;
                        if (!category || !year) {
                            personnelInput.value = '';
                            return;
                        }
                        // call API
                        fetch('/api/hr_cost?category=' + encodeURIComponent(category) + '&year=' + encodeURIComponent(year))
                            .then(function (res) { return res.json(); })
                            .then(function (json) {
                                var base = parseNumber(json && json.cost ? json.cost : 0);
                                var total = base * fte;
                                personnelInput.value = (isNaN(total) || total === 0) ? (fte === 0 ? '0.00' : '') : total.toFixed(2);
                            })
                            .catch(function () {
                                personnelInput.value = '';
                            });
                    }

                    // attach listeners
                    if (categorySelect) categorySelect.addEventListener('change', updatePersonnel);
                    if (yearSelect) yearSelect.addEventListener('change', updatePersonnel);
                    if (fteInput) fteInput.addEventListener('input', updatePersonnel);

                    // update once to initialize
                    updatePersonnel();
                }

                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    setupHandlers();
                } else {
                    document.addEventListener('DOMContentLoaded', setupHandlers);
                }

                // Also re-run setup when modal opens (in case elements are re-rendered)
                var addBtn = document.getElementById('add_button');
                if (addBtn) addBtn.addEventListener('click', function () { setTimeout(setupHandlers, 10); });
            })();
        </script>
        <script>
            // Send selected PO to server and fetch server-filtered departments for the modal (server-side filtering)
            (function () {
                var poSelect = document.getElementById('po_select');
                var deptSelect = document.getElementById('department_select');
                var poSelectM = document.getElementById('po_select_modify');
                var deptSelectM = document.getElementById('department_select_modify');

                // Rebuild Human Resource Category options in both Add and Modify modals
                function rebuildHrCategoryOptions(options){
                    // Add modal
                    var hrSel = document.querySelector('select[name="Human_resource_category"]');
                    if (hrSel){
                        var current = hrSel.value;
                        while (hrSel.firstChild) hrSel.removeChild(hrSel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select Human Resource Category';
                        hrSel.appendChild(placeholder);
                        (options || []).forEach(function(h){
                            var opt = document.createElement('option');
                            opt.value = h;
                            opt.textContent = h;
                            hrSel.appendChild(opt);
                        });
                        if (current && Array.from(hrSel.options).some(function(o){ return o.value === current; })){
                            hrSel.value = current;
                        } else {
                            hrSel.value = '';
                        }
                    }
                    // Modify modal
                    var hrSelM = document.getElementById('hr_category_modify');
                    if (hrSelM){
                        var currentM = hrSelM.value;
                        while (hrSelM.firstChild) hrSelM.removeChild(hrSelM.firstChild);
                        var placeholderM = document.createElement('option');
                        placeholderM.value = '';
                        placeholderM.textContent = 'Select Human Resource Category';
                        hrSelM.appendChild(placeholderM);
                        (options || []).forEach(function(h){
                            var opt = document.createElement('option');
                            opt.value = h;
                            opt.textContent = h;
                            hrSelM.appendChild(opt);
                        });
                        if (currentM && Array.from(hrSelM.options).some(function(o){ return o.value === currentM; })){
                            hrSelM.value = currentM;
                        } else {
                            hrSelM.value = '';
                        }
                    }
                }

                function fetchAndRebuildHrCategories(poVal){
                    if (!poVal){
                        rebuildHrCategoryOptions([]);
                        return;
                    }
                    fetch('/manual_input/hr_categories?po=' + encodeURIComponent(poVal))
                        .then(function(res){ return res.json(); })
                        .then(function(json){
                            if (!json || !Array.isArray(json.human_resource_categories)){
                                rebuildHrCategoryOptions([]);
                                return;
                            }
                            rebuildHrCategoryOptions(json.human_resource_categories);
                        })
                        .catch(function(){ rebuildHrCategoryOptions([]); });
                }

                function rebuildDeptOptions(options) {
                    if (!deptSelect) return;
                    // Remember current value to try to preserve selection if still valid
                    var current = deptSelect.value;
                    // Clear all
                    while (deptSelect.firstChild) deptSelect.removeChild(deptSelect.firstChild);
                    // Placeholder
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select BU';
                    deptSelect.appendChild(placeholder);
                    // Add filtered options
                    options.forEach(function (d) {
                        if (!d || !d.name) return;
                        var opt = document.createElement('option');
                        opt.value = d.name;
                        opt.textContent = d.name;
                        if (d.po_id !== undefined && d.po_id !== null) opt.setAttribute('data-po-id', d.po_id);
                        deptSelect.appendChild(opt);
                    });
                    // Try to preserve selection; if not present, reset to placeholder
                    if (current && Array.from(deptSelect.options).some(function (o) { return o.value === current; })) {
                        deptSelect.value = current;
                    } else {
                        deptSelect.value = '';
                    }
                }

                function fetchServerFilteredDepartments() {
                    if (!poSelect || !deptSelect) return;
                    var poVal = poSelect.value || '';
                    if (!poVal) return; // No PO selected: keep current options
                    fetch('/manual_input/departments?po=' + encodeURIComponent(poVal))
                        .then(function (res) { return res.json(); })
                        .then(function (json) {
                            if (json && Array.isArray(json.departments)) rebuildDeptOptions(json.departments);
                        })
                        .catch(function () { /* keep current options on error */ });
                }

                if (poSelect && deptSelect) {
                    // Initialize once on load (handles preselected PO) using server-side filtering
                    fetchServerFilteredDepartments();
                    // Initialize HR categories on load as well
                    if (poSelect.value){ fetchAndRebuildHrCategories(poSelect.value); }
                    // On change: post to server and update UI immediately
                    poSelect.addEventListener('change', function () {
                        var val = poSelect.value || '';
                        // Fire-and-forget server update
                        fetch('/manual_input/po_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ po: val })
                        }).catch(function () { });
                        // If PO is cleared, reset dependent UI and server-side selections
                        if (!val) {
                            // reset entire form except PO itself
                            window.resetForecastForm && window.resetForecastForm();
                            // reset HR categories as well
                            rebuildHrCategoryOptions([]);
                            // notify server that department/fiscal_year/project are cleared
                            fetch('/manual_input/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: '' }) }).catch(function(){});
                            fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: '' }) }).catch(function(){});
                            fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){});
                        } else {
                            // Then fetch server-filtered departments and update UI
                            fetchServerFilteredDepartments();
                            // Also refresh projects list filtered by new PO
                            if (window.fetchAndRebuildProjects) window.fetchAndRebuildProjects();
                            // And refresh HR categories filtered by new PO
                            fetchAndRebuildHrCategories(val);
                        }
                    });
                }
                // Modify modal dependencies
                function rebuildDeptOptionsM(options) {
                    if (!deptSelectM) return;
                    var current = deptSelectM.value;
                    while (deptSelectM.firstChild) deptSelectM.removeChild(deptSelectM.firstChild);
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select BU';
                    deptSelectM.appendChild(placeholder);
                    options.forEach(function (d) {
                        var name = d && d.name ? d.name : (typeof d === 'string' ? d : '');
                        if (!name) return;
                        var opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        deptSelectM.appendChild(opt);
                    });
                    if (current && Array.from(deptSelectM.options).some(function (o) { return o.value === current; })) {
                        deptSelectM.value = current;
                    } else {
                        deptSelectM.value = '';
                    }
                }
                function fetchServerFilteredDepartmentsM() {
                    if (!poSelectM || !deptSelectM) return;
                    var poVal = poSelectM.value || '';
                    if (!poVal) return;
                    fetch('/manual_input/departments?po=' + encodeURIComponent(poVal))
                        .then(function (res) { return res.json(); })
                        .then(function (json) {
                            if (json && Array.isArray(json.departments)) rebuildDeptOptionsM(json.departments);
                        })
                        .catch(function () { });
                }
                if (poSelectM && deptSelectM) {
                    fetchServerFilteredDepartmentsM();
                    poSelectM.addEventListener('change', function(){
                        // update server-side selection as well
                        var val = poSelectM.value || '';
                        fetch('/manual_input/po_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ po: val }) }).catch(function(){});
                        fetchServerFilteredDepartmentsM();
                        // refresh HR categories in modify modal
                        fetchAndRebuildHrCategories(val);
                    });
                }
            })();
        </script>
        <script>
            // Fetch projects from server and rebuild all Project_Name selects in the modal/form
            (function () {
                var poSelect = document.getElementById('po_select');
                var deptSelect = document.getElementById('department_select');
                var fySelect = document.querySelector('select[name="fiscal_year"]');
                var poSelectM = document.getElementById('po_select_modify');
                var deptSelectM = document.getElementById('department_select_modify');
                var fySelectM = document.getElementById('fiscal_year_modify');

                function rebuildProjectOptions(options) {
                    // There may be multiple selects named Project_Name in the template; update all
                    var selects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    selects.forEach(function (sel) {
                        var current = sel.value;
                        while (sel.firstChild) sel.removeChild(sel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select Project';
                        sel.appendChild(placeholder);
                        options.forEach(function (p) {
                            var opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = p.name;
                            sel.appendChild(opt);
                        });
                        if (current && Array.from(sel.options).some(function (o) { return o.value === current; })) {
                            sel.value = current;
                        }
                    });
                }

                function fetchAndRebuildProjects() {
                    var po = (poSelect && poSelect.value) ? poSelect.value : '';
                    var dept = (deptSelect && deptSelect.value) ? deptSelect.value : '';
                    var fy = (fySelect && fySelect.value) ? fySelect.value : '';
                    var qs = [];
                    if (po) qs.push('po=' + encodeURIComponent(po));
                    if (dept) qs.push('department=' + encodeURIComponent(dept));
                    if (fy) qs.push('fiscal_year=' + encodeURIComponent(fy));
                    var url = '/manual_input/projects' + (qs.length ? ('?' + qs.join('&')) : '');
                    fetch(url).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.projects) return;
                        rebuildProjectOptions(data.projects);
                        // after rebuilding projects, if a project is selected fetch IOs for it
                        var firstProj = document.querySelector('select[name="Project_Name"]');
                        if (firstProj && firstProj.value) fetchAndRebuildIOs(firstProj.value);
                    }).catch(function () { });
                }
                function rebuildProjectOptionsM(options) {
                    var sel = document.getElementById('project_name_modify');
                    if (!sel) return;
                    var current = sel.value;
                    while (sel.firstChild) sel.removeChild(sel.firstChild);
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select Project';
                    sel.appendChild(placeholder);
                    options.forEach(function (p) {
                        var name = p && p.name ? p.name : (typeof p === 'string' ? p : '');
                        if (!name) return;
                        var opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sel.appendChild(opt);
                    });
                    if (current && Array.from(sel.options).some(function (o) { return o.value === current; })) sel.value = current; else sel.value = '';
                }
                function fetchAndRebuildProjectsM() {
                    var po = (poSelectM && poSelectM.value) ? poSelectM.value : '';
                    var dept = (deptSelectM && deptSelectM.value) ? deptSelectM.value : '';
                    var fy = (fySelectM && fySelectM.value) ? fySelectM.value : '';
                    var qs = [];
                    if (po) qs.push('po=' + encodeURIComponent(po));
                    if (dept) qs.push('department=' + encodeURIComponent(dept));
                    if (fy) qs.push('fiscal_year=' + encodeURIComponent(fy));
                    var url = '/manual_input/projects' + (qs.length ? ('?' + qs.join('&')) : '');
                    fetch(url).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.projects) return;
                        rebuildProjectOptionsM(data.projects);
                        var firstProj = document.getElementById('project_name_modify');
                        if (firstProj && firstProj.value) { fetchAndRebuildCategoriesM(firstProj.value); fetchAndRebuildIOsM(firstProj.value); }
                    }).catch(function () { });
                }

                // Hook up change handlers to refresh projects when department or fiscal year changes
                if (deptSelect) {
                    deptSelect.addEventListener('change', function () {
                        // POST department selection to server (existing) then refresh projects
                        var val = deptSelect.value || '';
                        fetch('/manual_input/department_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department: val })
                        }).catch(function () { }).finally(function () {
                            // If department cleared, enforce hierarchy: clear fiscal year, projects, and inputs
                            if (!val) {
                                try {
                                    var fy = document.querySelector('select[name="fiscal_year"]');
                                    if (fy) fy.selectedIndex = 0;
                                    // clear project selects
                                    var projSelects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                                    projSelects.forEach(function (sel) { while (sel.options && sel.options.length > 1) sel.remove(1); sel.value = ''; });
                                    // clear inputs: Project_Category and IO
                                    var cat = document.querySelector('input[name="Project_Category"]'); if (cat) cat.value = '';
                                    var ioInp = document.querySelector('input[name="IO"]'); if (ioInp) ioInp.value = '';
                                    // notify server that fiscal year and project cleared
                                    fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: '' }) }).catch(function(){});
                                    fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){});
                                } catch (e) { }
                            }
                            fetchAndRebuildProjects();
                        });
                    });
                }
                if (fySelect) {
                    fySelect.addEventListener('change', function () {
                        var val = fySelect.value || '';
                        fetch('/manual_input/fiscal_year_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fiscal_year: val })
                        }).catch(function () { }).finally(function () { fetchAndRebuildProjects(); });
                    });
                }
                if (deptSelectM) {
                    deptSelectM.addEventListener('change', function(){
                        var val = deptSelectM.value || '';
                        fetch('/manual_input/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: val }) }).catch(function () { }).finally(function () { fetchAndRebuildProjectsM(); });
                    });
                }
                if (fySelectM) {
                    fySelectM.addEventListener('change', function(){
                        var val = fySelectM.value || '';
                        fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: val }) }).catch(function () { }).finally(function () { fetchAndRebuildProjectsM(); });
                    });
                }

                // Expose for other scripts in this file to call after PO changes
                window.fetchAndRebuildProjects = fetchAndRebuildProjects;
                window.fetchAndRebuildProjectsM = fetchAndRebuildProjectsM;

                // Initialize on load in case preselected values exist
                if (document.readyState === 'complete' || document.readyState === 'interactive') fetchAndRebuildProjects(); else document.addEventListener('DOMContentLoaded', fetchAndRebuildProjects);
                if (document.readyState === 'complete' || document.readyState === 'interactive') fetchAndRebuildProjectsM(); else document.addEventListener('DOMContentLoaded', fetchAndRebuildProjectsM);
            })();
        </script>
        <script>
            // Send selected Project to manual_input endpoint to update module-level selected_project
            (function () {
                function bindProjectSelects() {
                    var selects = Array.from(document.querySelectorAll('select[name="Project_Name"]'));
                    selects.forEach(function (sel) {
                        sel.addEventListener('change', function () {
                            var val = sel.value || '';
                            fetch('/manual_input/project_selection', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ project: val })
                            }).catch(function () { });
                            // If project cleared, clear Project Category and IO inputs/selects and notify server
                            if (!val) {
                                try {
                                    var catSel = document.querySelector('select[name="Project_Category"]');
                                    var catInp = document.querySelector('input[name="Project_Category"]');
                                    if (catSel) { catSel.selectedIndex = 0; }
                                    if (catInp) { catInp.value = ''; }
                                    var ioSel = document.querySelector('select[name="IO"]');
                                    var ioInp = document.querySelector('input[name="IO"]');
                                    if (ioSel) { ioSel.selectedIndex = 0; }
                                    if (ioInp) { ioInp.value = ''; }
                                } catch (e) { }
                                fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){});
                            } else {
                                // Also refresh IOs for this project selection
                                fetchAndRebuildIOs(val);
                            }
                        });
                    });
                }
                if (document.readyState === 'complete' || document.readyState === 'interactive') bindProjectSelects(); else document.addEventListener('DOMContentLoaded', bindProjectSelects);
                // Re-bind after projects are rebuilt
                var originalFetch = window.fetchAndRebuildProjects;
                if (typeof originalFetch === 'function') {
                    window.fetchAndRebuildProjects = function () { originalFetch(); setTimeout(bindProjectSelects, 50); };
                }
                // Bind project select in modify modal
                function bindProjectSelectModify(){
                    var sel = document.getElementById('project_name_modify');
                    if (!sel) return;
                    sel.addEventListener('change', function(){
                        var val = sel.value || '';
                        fetch('/manual_input/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: val }) }).catch(function () { });
                        if (val) { fetchAndRebuildCategoriesM(val); fetchAndRebuildIOsM(val); }
                    });
                }
                if (document.readyState === 'complete' || document.readyState === 'interactive') bindProjectSelectModify(); else document.addEventListener('DOMContentLoaded', bindProjectSelectModify);
            })();
        </script>
        <script>
            // Send selected Department to manual_input endpoint to update module-level selected_department (manual page specific)
            (function () {
                var deptSelect = document.getElementById('department_select');
                if (!deptSelect) return;
                deptSelect.addEventListener('change', function () {
                    var val = deptSelect.value || '';
                    fetch('/manual_input/department_selection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ department: val })
                    }).catch(function () { });
                });
            })();
        </script>
        <script>
        // Send selected Fiscal Year to manual_input endpoint to update module-level selected_fiscal_year (manual page specific)
        (function () {
            function bindFY(el){
                if (!el) return;
                el.addEventListener('change', function(){
                    var val = el.value || '';
                    fetch('/manual_input/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: val }) }).catch(function () { });
                });
            }
            bindFY(document.querySelector('select[name="fiscal_year"]'));
            bindFY(document.getElementById('fiscal_year_modify'));
        })();
        </script>
        <script>
            // Helpers and reset for Modify modal (categories & IOs)
            (function(){
                function rebuildCategoryOptionsM(options){
                    var inp = document.getElementById('project_category_modify');
                    if (!inp) return;
                    if (options && options.length > 0) inp.value = options[0]; else inp.value = '';
                }
                window.fetchAndRebuildCategoriesM = function(project){
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/project_categories' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !data.project_categories) return;
                        rebuildCategoryOptionsM(data.project_categories);
                    }).catch(function () { });
                }
                function rebuildIOOptionsM(options){
                    var inp = document.getElementById('io_modify');
                    if (!inp) return;
                    if (options && options.length > 0) inp.value = options[0]; else inp.value = '';
                }
                window.fetchAndRebuildIOsM = function(project){
                    var qs = project ? ('?project=' + encodeURIComponent(project)) : '';
                    fetch('/manual_input/ios' + qs).then(function (res) { return res.json(); }).then(function (data) {
                        if (!data || !Array.isArray(data.ios)) return;
                        rebuildIOOptionsM(data.ios);
                    }).catch(function () { });
                }
                window.resetModifyForecastForm = function(){
                    try{
                        var form = document.getElementById('modify_forecast');
                        if (!form) return;
                        var selects = Array.from(form.querySelectorAll('select'));
                        selects.forEach(function(s){ if (s.options && s.options.length) s.selectedIndex = 0; });
                        var inputs = Array.from(form.querySelectorAll('input[type="text"], input[type="number"]'));
                        inputs.forEach(function(i){ i.value = ''; });
                        var fte = document.getElementById('Human_resource_FTE_modify'); if (fte) fte.value = '0';
                    }catch(e){ console.warn('resetModifyForecastForm failed', e); }
                }
            })();
        </script>
        <style>
            /* Modal styles reused */
            .modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }

            .modal-overlay {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
            }

            .modal-content {
                position: relative;
                max-width: 760px;
                margin: 60px auto;
                background: #fff;
                border-radius: 6px;
                padding: 20px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                z-index: 2010;
            }

            .modal-close {
                position: absolute;
                right: 10px;
                top: 8px;
                font-size: 24px;
                background: transparent;
                border: none;
                cursor: pointer;
            }
        </style>
    </div>
</body>

</html>
