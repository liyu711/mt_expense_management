{% extends 'basic_page.html' %}

{% block title %}Data Summary{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        .hidden { display: none; }
    </style>
{% endblock %}

{% block page_title %}Expense Summary{% endblock %}

{% block content %}
    <div style="padding:20px;">
        <div>
            <label for="po">Choose PO</label>
            <select name="po" id="po">
                <option value="">-- select PO --</option>
                <option value="All" {% if selected_po == 'All' %}selected{% endif %}>All</option>
                {% if pos %}
                    {% for p in pos %}
                        <option value="{{ p.name }}" data-po-id="{{ p.id }}" {% if selected_po and selected_po == p.name %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <div id="department_wrapper" class="{% if not selected_po %}hidden{% endif %}" style="margin-top:10px;">
                <label for="department">Choose BU</label>
                <select name="department" id="department">
                    <option value="">-- select BU --</option>
                    <option value="All" {% if selected_department == 'All' %}selected{% endif %}>All</option>
                    {% if departments %}
                        {% for d in departments %}
                            {% set dept_name = d.get('name') or d.get('name_dept') or d.get('name_departments') %}
                            <option value="{{ dept_name }}" data-dept-id="{{ d.get('id') }}" {% if selected_department and selected_department == dept_name %}selected{% endif %}>{{ dept_name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div id="fiscal_year_wrapper" class="{% if not selected_department or not selected_po %}hidden{% endif %}" style="margin-top:10px;">
                <label for="fiscal_year">Choose Fiscal Year</label>
                <select name="fiscal_year" id="fiscal_year">
                    <option value="">-- select Year --</option>
                    <option value="All" {% if selected_fiscal_year == 'All' %}selected{% endif %}>All</option>
                    {% if fiscal_years %}
                        {% for y in fiscal_years %}
                            <option value="{{ y }}" {% if selected_fiscal_year and selected_fiscal_year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
        </div>
        <hr style="margin:20px 0;" />
        <div id="stats" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">Statistics</h3>
            <div id="stats-content"><em>Loading…</em></div>
            <div style="margin-top:10px;">
                <button id="calculate_stats">Refresh statistics</button>
            </div>
        </div>
        <div id="capex-stats" style="margin-top:18px;">
            <h3 style="margin:0 0 8px;">Capex Statistics</h3>
            <div id="capex-stats-content"><em>Loading…</em></div>
        </div>
        {% if summary_row %}
            <h3>Aggregated Summary</h3>
            <table id="summary_table" class="display" style="width:60%" border="1">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Forecasted Expense</td>
                        <td>{{ summary_row['Forecasted Expense'] }}</td>
                    </tr>
                    <tr>
                        <td>Budget and Funding</td>
                        <td>{{ summary_row['Budget and Funding'] }}</td>
                    </tr>
                    <tr>
                        <td>Actual Expenditure</td>
                        <td>{{ summary_row['Actual Expenditure'] }}</td>
                    </tr>
                </tbody>
            </table>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
            <script>
                // Ensure the handler is attached after the DOM is ready so the button exists
                document.addEventListener('DOMContentLoaded', function(){
                    var btn = document.getElementById('calculate_stats');
                    if(!btn) return;
                    btn.addEventListener('click', function(){
                        // request current stats from server
                        fetch('/data_summary/get_statistics', { method: 'GET' }).then(function(resp){
                            if(!resp.ok) return resp.json().then(function(){throw new Error('bad')});
                            return resp.json();
                        }).then(function(data){
                            if(!data) return;
                            document.getElementById('stat_non_personnel').textContent = data.non_personnel_forecast != null ? data.non_personnel_forecast : '-';
                            document.getElementById('stat_personnel').textContent = data.personnel_forecast != null ? data.personnel_forecast : '-';
                            document.getElementById('stat_total_forecast').textContent = data.total_forecast != null ? data.total_forecast : '-';
                            // populate budget breakdown values (backend returns keys with spaces)
                            document.getElementById('stat_personnel_budget').textContent = data['personnel budget'] != null ? data['personnel budget'] : '-';
                            document.getElementById('stat_non_personnel_budget').textContent = data['non personnel budget'] != null ? data['non personnel budget'] : '-';
                            document.getElementById('stat_budget').textContent = data.budget != null ? data.budget : '-';
                            document.getElementById('stat_funding').textContent = data.funding != null ? data.funding : '-';
                            document.getElementById('stat_total_budget').textContent = data['total_budget and funding'] != null ? data['total_budget and funding'] : '-';
                            // new expense breakdowns
                            var pe = document.getElementById('stat_personnel_expense');
                            var npe = document.getElementById('stat_non_personnel_expense');
                            var te = document.getElementById('stat_total_expense');
                            if (pe) pe.textContent = (data['Personnel Expense'] != null ? data['Personnel Expense'] : '-');
                            if (npe) npe.textContent = (data['Non-personnel Expense'] != null ? data['Non-personnel Expense'] : '-');
                            if (te) te.textContent = (data['Total Expense'] != null ? data['Total Expense'] : '-');
                        }).catch(function(err){ console.error('Failed to fetch stats', err); });
                    });
                });
            </script>
            <script>
                (function(){
                    var dept = document.getElementById('department');
                    if(!dept) return;
                    var fyWrap = document.getElementById('fiscal_year_wrapper');
                    dept.addEventListener('change', function(){
                        // show/hide fiscal year wrapper immediately when department selected
                        if(fyWrap){
                                // show fiscal year only when a department is selected and a PO is selected
                                var poSel = document.getElementById('po');
                                var poHas = poSel && poSel.value && poSel.value !== '';
                                if(dept.value && dept.value !== '' && poHas) fyWrap.style.display = '';
                                else fyWrap.style.display = 'none';
                            }
                        var val = dept.value;
                        fetch('/data_summary/department_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Department');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>

            <script>
                (function(){
                    var fy = document.getElementById('fiscal_year');
                    if(!fy) return;
                    fy.addEventListener('change', function(){
                        var val = fy.value;
                        fetch('/data_summary/fiscal_year_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fiscal_year: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Fiscal Year');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
            <script>
                (function(){
                    var po = document.getElementById('po');
                    var deptWrap = document.getElementById('department_wrapper');
                    if(!po) return;
                    po.addEventListener('change', function(){
                            // When PO changes we should reset downstream selects immediately
                            if(deptWrap){
                                if(po.value && po.value !== '') deptWrap.style.display = '';
                                else deptWrap.style.display = 'none';
                            }
                            // reset UI selects for department and fiscal year (project filter removed)
                            var dept = document.getElementById('department');
                            var fy = document.getElementById('fiscal_year');
                            if(dept) { dept.selectedIndex = 0; }
                            if(fy) { fy.selectedIndex = 0; }

                            // clear server-side selections for department/fiscal_year before applying new PO
                            var clearPromises = [];
                            clearPromises.push(fetch('/data_summary/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: '' }) }).catch(function(){}) );
                            clearPromises.push(fetch('/data_summary/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: '' }) }).catch(function(){}) );

                            Promise.all(clearPromises).then(function(){
                                // now send PO selection to server
                                var val = po.value;
                                fetch('/data_summary/po_selection', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({po: val})
                                }).then(function(resp){
                                    if(resp.ok){
                                        // reload to reflect selection
                                        window.location.reload();
                                    } else {
                                        console.error('Failed to set PO');
                                    }
                                }).catch(function(err){ console.error(err); });
                            });
                        });
                })();
            </script>
        <script>
            (function(){
                function fmt(n){
                    if(n === null || n === undefined || isNaN(Number(n))) return '-';
                    try { return Number(n).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1}); } catch(e){ return String(n); }
                }
                var rows = [
                    { label: 'Personnel Forecast', key: 'personnel_forecast' },
                    { label: 'Non-personnel Forecast', key: 'non_personnel_forecast' },
                    { label: 'Total Forecast', key: 'total_forecast' },
                    { label: 'Personnel Budget', key: 'personnel budget' },
                    { label: 'Non-personnel Budget', key: 'non personnel budget' },
                    { label: 'Budget', key: 'budget' },
                    { label: 'Funding', key: 'funding' },
                    { label: 'Total Budget and Funding', key: 'total_budget and funding' },
                    { label: 'Personnel Expense', key: 'Personnel Expense' },
                    { label: 'Non-personnel Expense', key: 'Non-personnel Expense' },
                    { label: 'Total Expense', key: 'Total Expense' }
                ];
                var capexRows = [
                    { label: 'Capex Forecast', key: 'capex_forecast' },
                    { label: 'Capex Budget', key: 'capex_budget' },
                    { label: 'Capex Expense', key: 'capex_expense' }
                ];
                function render(data){
                    var el = document.getElementById('stats-content');
                    if(!el) return;
                    if(!data || data.error){ el.innerHTML = '<span style="color:#a00;">Failed to load statistics</span>'; return; }
                    var html = '<table style="border-collapse:collapse;min-width:420px;">\n<tbody>';
                    rows.forEach(function(r){
                        html += '<tr>' +
                            '<td style="padding:6px 10px;border-bottom:1px solid #eee;white-space:nowrap;">' + r.label + '</td>' +
                            '<td style="padding:6px 10px;border-bottom:1px solid #eee;text-align:right;font-variant-numeric:tabular-nums;">' + fmt(data[r.key]) + '</td>' +
                        '</tr>';
                    });
                    html += '</tbody></table>';
                    el.innerHTML = html;
                }
                function renderCapex(data){
                    var el = document.getElementById('capex-stats-content');
                    if(!el) return;
                    if(!data || data.error){ el.innerHTML = '<span style="color:#a00;">Failed to load capex statistics</span>'; return; }
                    var html = '<table style="border-collapse:collapse;min-width:420px;">\n<tbody>';
                    capexRows.forEach(function(r){
                        html += '<tr>' +
                            '<td style="padding:6px 10px;border-bottom:1px solid #eee;white-space:nowrap;">' + r.label + '</td>' +
                            '<td style="padding:6px 10px;border-bottom:1px solid #eee;text-align:right;font-variant-numeric:tabular-nums;">' + fmt(data[r.key]) + '</td>' +
                        '</tr>';
                    });
                    html += '</tbody></table>';
                    el.innerHTML = html;
                }
                function load(){
                    fetch('/data_summary/get_statistics',{method:'GET'})
                        .then(function(r){ return r.ok ? r.json() : {error:'bad status'}; })
                        .then(function(data){ render(data); renderCapex(data); })
                        .catch(function(){ render({error:'network'}); renderCapex({error:'network'}); });
                }
                document.addEventListener('DOMContentLoaded', function(){
                    var btn = document.getElementById('calculate_stats');
                    if(btn){ btn.addEventListener('click', function(e){ e.preventDefault(); load(); }); }
                    load();
                });
            })();
        </script>
{% endblock %}
