<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Data Summary</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    <div style="margin-left:50px;padding:20px;">
        <h2 style="margin-top:20px;">Expense Summary</h2>
        <div>
            <label for="po">Choose PO</label>
            <select name="po" id="po">
                <option value="">-- select PO --</option>
                <option value="All" {% if selected_po == 'All' %}selected{% endif %}>All</option>
                {% if pos %}
                    {% for p in pos %}
                        <option value="{{ p.name }}" data-po-id="{{ p.id }}" {% if selected_po and selected_po == p.name %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <div id="department_wrapper" class="{% if not selected_po %}hidden{% endif %}" style="margin-top:10px;">
                <label for="department">Choose BU</label>
                <select name="department" id="department">
                    <option value="">-- select BU --</option>
                    <option value="All" {% if selected_department == 'All' %}selected{% endif %}>All</option>
                    {% if departments %}
                        {% for d in departments %}
                            {% set dept_name = d.get('name') or d.get('name_dept') or d.get('name_departments') %}
                            <option value="{{ dept_name }}" data-dept-id="{{ d.get('id') }}" {% if selected_department and selected_department == dept_name %}selected{% endif %}>{{ dept_name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div id="fiscal_year_wrapper" class="{% if not selected_department or not selected_po %}hidden{% endif %}" style="margin-top:10px;">
                <label for="fiscal_year">Choose Fiscal Year</label>
                <select name="fiscal_year" id="fiscal_year">
                    <option value="">-- select Year --</option>
                    <option value="All" {% if selected_fiscal_year == 'All' %}selected{% endif %}>All</option>
                    {% if fiscal_years %}
                        {% for y in fiscal_years %}
                            <option value="{{ y }}" {% if selected_fiscal_year and selected_fiscal_year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div id="project_wrapper" class="{% if not selected_fiscal_year %}hidden{% endif %}" style="margin-top:10px;">
                <label for="project">Choose Project</label>
                <select name="project" id="project">
                    <option value="">-- select Project --</option>
                    <option value="All" {% if selected_project == 'All' %}selected{% endif %}>All</option>
                    {% if projects %}
                        {% for p in projects %}
                            {% set pname = p.get('name') or p.get('Project') or p.get('project') %}
                            <option value="{{ pname }}" data-project="{{ pname }}" {% if selected_project and selected_project == pname %}selected{% endif %}>{{ pname }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <script>
                (function(){
                    var project = document.getElementById('project');
                    if(!project) return;
                    project.addEventListener('change', function(){
                        var val = project.value;
                        fetch('/data_summary/project_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ project: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Project');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
            <script>
                // Ensure the handler is attached after the DOM is ready so the button exists
                document.addEventListener('DOMContentLoaded', function(){
                    var btn = document.getElementById('calculate_stats');
                    if(!btn) return;
                    btn.addEventListener('click', function(){
                        // request current stats from server
                        fetch('/data_summary/get_statistics', { method: 'GET' }).then(function(resp){
                            if(!resp.ok) return resp.json().then(function(){throw new Error('bad')});
                            return resp.json();
                        }).then(function(data){
                            if(!data) return;
                            document.getElementById('stat_non_personnel').textContent = data.non_personnel_forecast != null ? data.non_personnel_forecast : '-';
                            document.getElementById('stat_personnel').textContent = data.personnel_forecast != null ? data.personnel_forecast : '-';
                            document.getElementById('stat_total_forecast').textContent = data.total_forecast != null ? data.total_forecast : '-';
                            // populate budget breakdown values (backend returns keys with spaces)
                            document.getElementById('stat_personnel_budget').textContent = data['personnel budget'] != null ? data['personnel budget'] : '-';
                            document.getElementById('stat_non_personnel_budget').textContent = data['non personnel budget'] != null ? data['non personnel budget'] : '-';
                            document.getElementById('stat_budget').textContent = data.budget != null ? data.budget : '-';
                            document.getElementById('stat_funding').textContent = data.funding != null ? data.funding : '-';
                            document.getElementById('stat_total_budget').textContent = data.total_budget != null ? data.total_budget : '-';
                            document.getElementById('stat_actual').textContent = data.actual_expense != null ? data.actual_expense : '-';
                        }).catch(function(err){ console.error('Failed to fetch stats', err); });
                    });
                });
            </script>
            <script>
                (function(){
                    var dept = document.getElementById('department');
                    if(!dept) return;
                    var fyWrap = document.getElementById('fiscal_year_wrapper');
                    dept.addEventListener('change', function(){
                        // show/hide fiscal year wrapper immediately when department selected
                        if(fyWrap){
                                // show fiscal year only when a department is selected and a PO is selected
                                var poSel = document.getElementById('po');
                                var poHas = poSel && poSel.value && poSel.value !== '';
                                if(dept.value && dept.value !== '' && poHas) fyWrap.style.display = '';
                                else fyWrap.style.display = 'none';
                            }
                        var val = dept.value;
                        fetch('/data_summary/department_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Department');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>

            <script>
                (function(){
                    var fy = document.getElementById('fiscal_year');
                    if(!fy) return;
                    fy.addEventListener('change', function(){
                        var val = fy.value;
                        fetch('/data_summary/fiscal_year_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fiscal_year: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Fiscal Year');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
            <script>
                (function(){
                    var po = document.getElementById('po');
                    var deptWrap = document.getElementById('department_wrapper');
                    if(!po) return;
                    po.addEventListener('change', function(){
                            // When PO changes we should reset downstream selects immediately
                            if(deptWrap){
                                if(po.value && po.value !== '') deptWrap.style.display = '';
                                else deptWrap.style.display = 'none';
                            }
                            // reset UI selects for department, fiscal year and project
                            var dept = document.getElementById('department');
                            var fy = document.getElementById('fiscal_year');
                            var project = document.getElementById('project');
                            if(dept) { dept.selectedIndex = 0; }
                            if(fy) { fy.selectedIndex = 0; }
                            if(project) { project.selectedIndex = 0; }

                            // clear server-side selections for department/fiscal_year/project before applying new PO
                            var clearPromises = [];
                            clearPromises.push(fetch('/data_summary/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: '' }) }).catch(function(){}) );
                            clearPromises.push(fetch('/data_summary/fiscal_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fiscal_year: '' }) }).catch(function(){}) );
                            clearPromises.push(fetch('/data_summary/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: '' }) }).catch(function(){}) );

                            Promise.all(clearPromises).then(function(){
                                // now send PO selection to server
                                var val = po.value;
                                fetch('/data_summary/po_selection', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({po: val})
                                }).then(function(resp){
                                    if(resp.ok){
                                        // reload to reflect selection
                                        window.location.reload();
                                    } else {
                                        console.error('Failed to set PO');
                                    }
                                }).catch(function(err){ console.error(err); });
                            });
                        });
                })();
            </script>
        </div>
        <hr>
        <div style="margin-top:12px;">
            <h3>Statistics</h3>
            <div>
                <label>Non personnel forecast: </label>
                <span id="stat_non_personnel">-</span>
            </div>
            <div>
                <label>Personnel forecast: </label>
                <span id="stat_personnel">-</span>
            </div>
            <div>
                <label>Personnel budget: </label>
                <span id="stat_personnel_budget">-</span>
            </div>
            <div>
                <label>Non personnel budget: </label>
                <span id="stat_non_personnel_budget">-</span>
            </div>
            <div>
                <label>Total forecast: </label>
                <span id="stat_total_forecast">-</span>
            </div>
            <div>
                <label>Budget: </label>
                <span id="stat_budget">-</span>
            </div>
            <div>
                <label>Funding: </label>
                <span id="stat_funding">-</span>
            </div>
            <div>
                <label>Total Budget: </label>
                <span id="stat_total_budget">-</span>
            </div>
            <div>
                <label>Actual Expense: </label>
                <span id="stat_actual">-</span>
            </div>
            <div style="margin-top:8px;">
                <button id="calculate_stats">Calculate statistics</button>
            </div>
        </div>
        {% if summary_row %}
            <h3>Aggregated Summary</h3>
            <table id="summary_table" class="display" style="width:60%" border="1">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Forecasted Expense</td>
                        <td>{{ summary_row['Forecasted Expense'] }}</td>
                    </tr>
                    <tr>
                        <td>Budget and Funding</td>
                        <td>{{ summary_row['Budget and Funding'] }}</td>
                    </tr>
                    <tr>
                        <td>Actual Expenditure</td>
                        <td>{{ summary_row['Actual Expenditure'] }}</td>
                    </tr>
                </tbody>
            </table>
        {% endif %}
    </div>
</body>
</html>
