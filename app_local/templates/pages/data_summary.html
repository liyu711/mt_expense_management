<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Data Summary</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body>
    {% include 'sidebar.html' %}
    <div style="margin-left:50px;padding:20px;">
        <h2 style="margin-top:20px;">Expense Summary</h2>
        <div>
            <label for="po">Choose PO</label>
            <select name="po" id="po">
                <option value="">-- select PO --</option>
                <option value="All" {% if selected_po == 'All' %}selected{% endif %}>All</option>
                {% if pos %}
                    {% for p in pos %}
                        <option value="{{ p.name }}" data-po-id="{{ p.id }}" {% if selected_po and selected_po == p.name %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <div style="margin-top:10px;">
                <label for="department">Choose Department</label>
                <select name="department" id="department">
                    <option value="">-- select Department --</option>
                    <option value="All" {% if selected_department == 'All' %}selected{% endif %}>All</option>
                    {% if departments %}
                        {% for d in departments %}
                            {% set dept_name = d.get('name') or d.get('name_dept') or d.get('name_departments') %}
                            <option value="{{ dept_name }}" data-dept-id="{{ d.get('id') }}" {% if selected_department and selected_department == dept_name %}selected{% endif %}>{{ dept_name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <script>
                (function(){
                    var po = document.getElementById('po');
                    if(!po) return;
                    po.addEventListener('change', function(){
                        var val = po.value;
                        // send selection to server
                        fetch('/data_summary/po_selection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({po: val})
                        }).then(function(resp){
                            if(resp.ok){
                                // reload to reflect selection
                                window.location.reload();
                            } else {
                                console.error('Failed to set PO');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
        </div>
        <hr>
        {% if summary_row %}
            <h3>Aggregated Summary</h3>
            <table id="summary_table" class="display" style="width:60%" border="1">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Forecasted Expense</td>
                        <td>{{ summary_row['Forecasted Expense'] }}</td>
                    </tr>
                    <tr>
                        <td>Budget and Funding</td>
                        <td>{{ summary_row['Budget and Funding'] }}</td>
                    </tr>
                    <tr>
                        <td>Actual Expenditure</td>
                        <td>{{ summary_row['Actual Expenditure'] }}</td>
                    </tr>
                </tbody>
            </table>
        {% endif %}
    </div>
</body>
</html>
