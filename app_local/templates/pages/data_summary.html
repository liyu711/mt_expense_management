<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Data Summary</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    <div style="margin-left:50px;padding:20px;">
        <h2 style="margin-top:20px;">Expense Summary</h2>
        <div>
            <label for="po">Choose PO</label>
            <select name="po" id="po">
                <option value="">-- select PO --</option>
                <option value="All" {% if selected_po == 'All' %}selected{% endif %}>All</option>
                {% if pos %}
                    {% for p in pos %}
                        <option value="{{ p.name }}" data-po-id="{{ p.id }}" {% if selected_po and selected_po == p.name %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <div id="department_wrapper" class="{% if not selected_po %}hidden{% endif %}" style="margin-top:10px;">
                <label for="department">Choose Department</label>
                <select name="department" id="department">
                    <option value="">-- select Department --</option>
                    <option value="All" {% if selected_department == 'All' %}selected{% endif %}>All</option>
                    {% if departments %}
                        {% for d in departments %}
                            {% set dept_name = d.get('name') or d.get('name_dept') or d.get('name_departments') %}
                            <option value="{{ dept_name }}" data-dept-id="{{ d.get('id') }}" {% if selected_department and selected_department == dept_name %}selected{% endif %}>{{ dept_name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div id="fiscal_year_wrapper" class="{% if not selected_department or not selected_po %}hidden{% endif %}" style="margin-top:10px;">
                <label for="fiscal_year">Choose Fiscal Year</label>
                <select name="fiscal_year" id="fiscal_year">
                    <option value="">-- select Year --</option>
                    <option value="All" {% if selected_fiscal_year == 'All' %}selected{% endif %}>All</option>
                    {% if fiscal_years %}
                        {% for y in fiscal_years %}
                            <option value="{{ y }}" {% if selected_fiscal_year and selected_fiscal_year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div id="project_wrapper" class="{% if not selected_fiscal_year %}hidden{% endif %}" style="margin-top:10px;">
                <label for="project">Choose Project</label>
                <select name="project" id="project">
                    <option value="">-- select Project --</option>
                    <option value="All" {% if selected_project == 'All' %}selected{% endif %}>All</option>
                    {% if projects %}
                        {% for p in projects %}
                            {% set pname = p.get('name') or p.get('Project') or p.get('project') %}
                            <option value="{{ pname }}" data-project="{{ pname }}" {% if selected_project and selected_project == pname %}selected{% endif %}>{{ pname }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <script>
                (function(){
                    var project = document.getElementById('project');
                    if(!project) return;
                    project.addEventListener('change', function(){
                        var val = project.value;
                        fetch('/data_summary/project_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ project: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Project');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
            <script>
                (function(){
                    var dept = document.getElementById('department');
                    if(!dept) return;
                    var fyWrap = document.getElementById('fiscal_year_wrapper');
                    dept.addEventListener('change', function(){
                        // show/hide fiscal year wrapper immediately when department selected
                        if(fyWrap){
                                // show fiscal year only when a department is selected and a PO is selected
                                var poSel = document.getElementById('po');
                                var poHas = poSel && poSel.value && poSel.value !== '';
                                if(dept.value && dept.value !== '' && poHas) fyWrap.style.display = '';
                                else fyWrap.style.display = 'none';
                            }
                        var val = dept.value;
                        fetch('/data_summary/department_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Department');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>

            <script>
                (function(){
                    var fy = document.getElementById('fiscal_year');
                    if(!fy) return;
                    fy.addEventListener('change', function(){
                        var val = fy.value;
                        fetch('/data_summary/fiscal_year_selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fiscal_year: val })
                        }).then(function(resp){
                            if(resp.ok){
                                window.location.reload();
                            } else {
                                console.error('Failed to set Fiscal Year');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
            <script>
                (function(){
                    var po = document.getElementById('po');
                    var deptWrap = document.getElementById('department_wrapper');
                    if(!po) return;
                    po.addEventListener('change', function(){
                        // show/hide department wrapper immediately when a PO is selected
                        if(deptWrap){
                            if(po.value && po.value !== '') deptWrap.style.display = '';
                            else deptWrap.style.display = 'none';
                        }
                        var val = po.value;
                        // send selection to server
                        fetch('/data_summary/po_selection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({po: val})
                        }).then(function(resp){
                            if(resp.ok){
                                // reload to reflect selection
                                window.location.reload();
                            } else {
                                console.error('Failed to set PO');
                            }
                        }).catch(function(err){ console.error(err); });
                    });
                })();
            </script>
        </div>
        <hr>
        {% if summary_row %}
            <h3>Aggregated Summary</h3>
            <table id="summary_table" class="display" style="width:60%" border="1">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Forecasted Expense</td>
                        <td>{{ summary_row['Forecasted Expense'] }}</td>
                    </tr>
                    <tr>
                        <td>Budget and Funding</td>
                        <td>{{ summary_row['Budget and Funding'] }}</td>
                    </tr>
                    <tr>
                        <td>Actual Expenditure</td>
                        <td>{{ summary_row['Actual Expenditure'] }}</td>
                    </tr>
                </tbody>
            </table>
        {% endif %}
    </div>
</body>
</html>
