<!DOCTYPE html>
<html>
<head>
    <title>Manual Input</title>
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .form-group label {
            flex: 1 1 33%;
            max-width: 33%;
            min-width: 120px;
            text-align: left;
            margin-right: 12px;
        }
        .form-group select,
        .form-group input[type="text"] {
            flex: 2 1 67%;
            max-width: 67%;
            min-width: 0;
        }
        .nav-menu {
            display: flex;
            gap: 20px;
            background: #f0f0f0;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
        }
        .nav-menu button {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px 16px;
        }
        .nav-menu button.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .input-section {
            display: none;
        }
        .input-section.active {
            display: block;
        }
        /* Page flex layout: top (rest) 10%, each table 45% */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px); /* adjust if you have headers */
            box-sizing: border-box;
        }
        .page-top {
            flex: 0 0 10vh; /* 10% of viewport height */
            padding-left: 24px;
            box-sizing: border-box;
        }
        .table-container {
            flex: 0 0 45vh; /* each table takes 45% of viewport height */
            padding-left: 24px;
            box-sizing: border-box;
            overflow: auto; /* allow scrolling inside each table area */
        }
    </style>
    <script>
        // No JS needed: forecast form is always visible on /manual_input
    </script>
</head>
<body>
    {% include 'sidebar.html' %}
    <div class="page-wrapper">
        <div class="page-top">
            <!-- Add button to open modal for manual forecast input -->
            <button id="add_button" type="button">Add</button>
        </div>

    <!-- Modal for forecast input (hidden by default) -->
    <div id="forecastModal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-overlay" id="forecastModalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="forecastModalClose" aria-label="Close">&times;</button>
            <h1>Forecast Input (Personnel & Non-Personnel)</h1>
            <form method="POST" action="/upload_forecast" id="upload_forecast">
                <div class="form-group">
                    <label for="PO">PO</label>
                    <select name="PO" required>
                        <option value="">Select PO</option>
                        {% for po in pos %}
                        <option value="{{ po }}">{{ po }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="IO">IO</label>
                    <select name="IO" required>
                        <option value="">Select IO</option>
                        {% for io in ios %}
                        <option value="{{ io }}">{{ io }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Department">Department</label>
                    <select name="Department" required>
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Project_Category">Project Category</label>
                    <select name="Project_Category" required>
                        <option value="">Select Project Category</option>
                        {% for cat in project_categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Project_Name">Project Name</label>
                    <select name="Project_Name" required>
                        <option value="">Select Project Name</option>
                        {% for proj in projects %}
                        <option value="{{ proj }}">{{ proj }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="fiscal_year">Fiscal Year</label>
                    <select name="fiscal_year" required>
                        <option value="">Select Year</option>
                        {% for y in range(2020, 2036) %}
                        <option value="{{ y }}">{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Human_resource_category">Human Resource Category</label>
                    <select name="Human_resource_category">
                        <option value="">Select Human Resource Category</option>
                        {% for hrc in human_resource_categories %}
                        <option value="{{ hrc }}">{{ hrc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Human_resource_FTE">Human Resource FTE</label>
                    <input type="number" step="0.1" name="Human_resource_FTE" id="Human_resource_FTE" value="0" onblur="if(this.value!==''){this.value = parseFloat(this.value).toFixed(1)}">
                </div>
                <div class="form-group">
                    <label for="Personnel_cost">Personnel Expense</label>
                    <input type="text" name="Personnel_cost" id="Personnel_cost" readonly>
                </div>
                <div class="form-group">
                    <label for="Non_personnel_cost">Non-personnel Expense</label>
                    <input type="text" name="Non_personnel_cost">
                </div>
                <div style="margin-top:12px;">
                    <button type="submit">Submit</button>
                    <button type="button" id="forecastModalCancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Display project_forecasts_nonpc table -->
    {% if pf_nonpc_columns and pf_nonpc_data %}
    <div class="table-container">
        <h3>Project Forecasts (non-personnel)</h3>
        <table id="pf_nonpc_table" class="display" style="width:100%" border="1">
            <thead>
                <tr>
                    {% for col in pf_nonpc_columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in pf_nonpc_data %}
                <tr>
                    {% for item in row %}
                    {% set colname = pf_nonpc_columns[loop.index0] if pf_nonpc_columns|length > loop.index0 else '' %}
                    {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname == 'PO' or colname == 'IO' or colname|lower == 'po' or colname|lower == 'io' or colname == 'Month' or colname|lower == 'month' or colname == 'Fiscal Year' or colname|lower == 'fiscal year' or colname|lower == 'fiscal_year') %}
                        <td>{{ item|as_int }}</td>
                    {% else %}
                        <td>{{ item|one_decimal }}</td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Display project_forecasts_pc table -->
    {% if pf_pc_columns and pf_pc_data %}
    <div class="table-container">
        <h3>Project Forecasts (personnel)</h3>
        <table id="pf_pc_table" class="display" style="width:100%" border="1">
            <thead>
                <tr>
                    {% for col in pf_pc_columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in pf_pc_data %}
                <tr>
                    {% for item in row %}
                    {% set colname = pf_pc_columns[loop.index0] if pf_pc_columns|length > loop.index0 else '' %}
                    {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname == 'PO' or colname == 'IO' or colname|lower == 'po' or colname|lower == 'io') %}
                        <td>{{ item|as_int }}</td>
                    {% else %}
                        <td>{{ item|one_decimal }}</td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Include DataTables and init scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script>
    $(document).ready(function(){
        if($('#pf_nonpc_table').length) $('#pf_nonpc_table').DataTable({paging:true, searching:true, ordering:true, lengthMenu:[[10,25,50,100],[10,25,50,100]]});
        if($('#pf_pc_table').length) $('#pf_pc_table').DataTable({paging:true, searching:true, ordering:true, lengthMenu:[[10,25,50,100],[10,25,50,100]]});

        // modal handlers
        var addBtn = document.getElementById('add_button');
        var modal = document.getElementById('forecastModal');
        var modalClose = document.getElementById('forecastModalClose');
        var modalOverlay = document.getElementById('forecastModalOverlay');
        var modalCancel = document.getElementById('forecastModalCancel');
        function openModal(){ modal.style.display='block'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
        function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
        addBtn && addBtn.addEventListener('click', openModal);
        modalClose && modalClose.addEventListener('click', closeModal);
        modalOverlay && modalOverlay.addEventListener('click', closeModal);
        modalCancel && modalCancel.addEventListener('click', closeModal);
        document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeModal(); });
    });
    </script>
    <script>
    (function(){
        function parseNumber(v){
            var n = parseFloat(v);
            return isNaN(n) ? 0 : n;
        }

        function setupHandlers(){
            var form = document.getElementById('upload_forecast');
            if(!form) return;
            var categorySelect = form.querySelector('select[name="Human_resource_category"]');
            var yearSelect = form.querySelector('select[name="fiscal_year"]');
            var fteInput = form.querySelector('#Human_resource_FTE');
            var personnelInput = form.querySelector('#Personnel_cost');

            function updatePersonnel(){
                var category = categorySelect ? categorySelect.value : '';
                var year = yearSelect ? yearSelect.value : '';
                var fte = fteInput ? parseNumber(fteInput.value) : 0;
                if(!personnelInput) return;
                if(!category || !year){
                    personnelInput.value = '';
                    return;
                }
                // call API
                fetch('/api/hr_cost?category=' + encodeURIComponent(category) + '&year=' + encodeURIComponent(year))
                    .then(function(res){ return res.json(); })
                    .then(function(json){
                        var base = parseNumber(json && json.cost ? json.cost : 0);
                        var total = base * fte;
                        personnelInput.value = (isNaN(total) || total === 0) ? (fte === 0 ? '0.00' : '') : total.toFixed(2);
                    })
                    .catch(function(){
                        personnelInput.value = '';
                    });
            }

            // attach listeners
            if(categorySelect) categorySelect.addEventListener('change', updatePersonnel);
            if(yearSelect) yearSelect.addEventListener('change', updatePersonnel);
            if(fteInput) fteInput.addEventListener('input', updatePersonnel);

            // update once to initialize
            updatePersonnel();
        }

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setupHandlers();
        } else {
            document.addEventListener('DOMContentLoaded', setupHandlers);
        }

        // Also re-run setup when modal opens (in case elements are re-rendered)
        var addBtn = document.getElementById('add_button');
        if(addBtn) addBtn.addEventListener('click', function(){ setTimeout(setupHandlers, 10); });
    })();
    </script>
    <style>
        /* Modal styles reused */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; }
        .modal-overlay { position: absolute; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4); }
        .modal-content { position: relative; max-width: 760px; margin: 60px auto; background: #fff; border-radius: 6px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 2010; }
        .modal-close { position: absolute; right: 10px; top: 8px; font-size: 24px; background: transparent; border: none; cursor: pointer; }
    </style>
    </div>
</body>
</html>
