{% extends 'basic_page.html' %}

{% block title %}Manual Input{% endblock %}

{% block head_extra %}
    <style>
        .form-group { display:flex; align-items:center; margin-bottom:18px; }
        .form-group label { flex:1 1 33%; max-width:33%; min-width:120px; text-align:left; margin-right:12px; }
        .form-group select, .form-group input[type="text"] { flex:2 1 67%; max-width:67%; min-width:0; }
        .page-wrapper { display:flex; flex-direction:column; height:calc(100vh - 0px); box-sizing:border-box; }
        .page-top { flex:0 0 10vh; padding-left:24px; box-sizing:border-box; }
        .table-container { flex:0 0 45vh; padding-left:24px; box-sizing:border-box; overflow:auto; }
        .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; }
        .modal-overlay { position:absolute; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
        .modal-content { position:relative; max-width:760px; margin:60px auto; background:#fff; border-radius:6px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.2); z-index:2010; }
        .modal-close { position:absolute; right:10px; top:8px; font-size:24px; background:transparent; border:none; cursor:pointer; }
    </style>
{% endblock %}

{% block page_title %}Manual Input{% endblock %}

{% block page_controls %}<button id="add_button" type="button">Add</button>{% endblock %}

{% block content %}
    <!-- Modal for forecast input -->
    <div id="forecastModal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-overlay" id="forecastModalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="forecastModalClose" aria-label="Close">&times;</button>
            <h1>Forecast Input (Personnel & Non-Personnel)</h1>
            <form method="POST" action="/upload_forecast" id="upload_forecast">
                <div class="form-group">
                    <label for="PO">PO</label>
                    <select name="PO" id="po_select" required>
                        <option value="">Select PO</option>
                        {% for po in pos %}<option value="{{ po.name }}" data-po-id="{{ po.id }}">{{ po.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Department">BU</label>
                    <select name="Department" id="department_select" required>
                        <option value="">Select BU</option>
                        {% for dept in departments %}<option value="{{ dept.name }}" data-po-id="{{ dept.po_id }}">{{ dept.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="fiscal_year">Fiscal Year</label>
                    <select name="fiscal_year" required>
                        <option value="">Select Year</option>
                        {% for y in range(2020, 2036) %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Project_Name">Project Name</label>
                    <select name="Project_Name" required>
                        <option value="">Select Project Name</option>
                        {% for proj in projects %}<option value="{{ proj }}">{{ proj }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Project_Category">Project Category</label>
                    <input type="text" name="Project_Category" required value="{{ project_categories[0] if project_categories|length > 0 else '' }}">
                </div>
                <div class="form-group">
                    <label for="IO">IO</label>
                    <input type="text" name="IO" required value="{{ ios[0] if ios|length > 0 else '' }}">
                </div>
                <div class="form-group">
                    <label for="Human_resource_category">Human Resource Category</label>
                    <select name="Human_resource_category">
                        <option value="">Select Human Resource Category</option>
                        {% for hrc in human_resource_categories %}<option value="{{ hrc }}">{{ hrc }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="Human_resource_FTE">Working Time(FTE)</label>
                    <input type="number" step="0.1" name="Human_resource_FTE" id="Human_resource_FTE" value="0" onblur="if(this.value!==''){this.value = parseFloat(this.value).toFixed(1)}">
                </div>
                <div class="form-group">
                    <label for="Personnel_cost">Personnel Expense</label>
                    <input type="text" name="Personnel_cost" id="Personnel_cost" readonly>
                </div>
                <div class="form-group">
                    <label for="Non_personnel_cost">Non-personnel Expense</label>
                    <input type="text" name="Non_personnel_cost">
                </div>
                <div style="margin-top:12px;">
                    <button type="submit">Submit</button>
                    <button type="button" id="forecastModalCancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    {% if pf_nonpc_columns and pf_nonpc_data %}
    <div class="table-container">
        <h3>Project Forecasts (non-personnel)</h3>
        <table id="pf_nonpc_table" class="display" style="width:100%" border="1">
            <thead><tr>{% for col in pf_nonpc_columns %}<th>{{ col }}</th>{% endfor %}</tr></thead>
            <tbody>
                {% for row in pf_nonpc_data %}
                <tr>
                    {% for item in row %}
                        {% set colname = pf_nonpc_columns[loop.index0] if pf_nonpc_columns|length > loop.index0 else '' %}
                        {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname in ['PO','IO','IO number','IO Number','Month','Fiscal Year','Capital Year'] or colname|lower in ['po','io','io number','month','fiscal year','fiscal_year','capital year','capital_year']) %}
                            <td>{{ item|as_int }}</td>
                        {% else %}<td>{{ item|one_decimal }}</td>{% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if pf_pc_columns and pf_pc_data %}
    <div class="table-container">
        <h3>Project Forecasts (personnel)</h3>
        <table id="pf_pc_table" class="display" style="width:100%" border="1">
            <thead><tr>{% for col in pf_pc_columns %}<th>{{ col }}</th>{% endfor %}</tr></thead>
            <tbody>
                {% for row in pf_pc_data %}
                <tr>
                    {% for item in row %}
                        {% set colname = pf_pc_columns[loop.index0] if pf_pc_columns|length > loop.index0 else '' %}
                        {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname in ['PO','IO'] or colname|lower in ['po','io']) %}
                            <td>{{ item|as_int }}</td>
                        {% else %}<td>{{ item|one_decimal }}</td>{% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        (function initForecastTables(retries){
            retries = retries || 15;
            function init(){
                if(window.jQuery && jQuery.fn && jQuery.fn.dataTable){
                    if($('#pf_nonpc_table').length) $('#pf_nonpc_table').DataTable({paging:true, searching:true, ordering:true});
                    if($('#pf_pc_table').length) $('#pf_pc_table').DataTable({paging:true, searching:true, ordering:true});
                } else if(retries>0){ setTimeout(function(){ initForecastTables(retries-1); },200); }
            }
            if(document.readyState==='complete' || document.readyState==='interactive') init(); else document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
    <script>
        (function(){
            var addBtn = document.getElementById('add_button');
            var modal = document.getElementById('forecastModal');
            var modalClose = document.getElementById('forecastModalClose');
            var modalOverlay = document.getElementById('forecastModalOverlay');
            var modalCancel = document.getElementById('forecastModalCancel');
            function open(){ if(typeof window.resetForecastForm==='function') window.resetForecastForm(); modal.style.display='block'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
            function close(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
            addBtn && addBtn.addEventListener('click',open);
            [modalClose, modalOverlay, modalCancel].forEach(function(el){ el && el.addEventListener('click', close); });
            document.addEventListener('keydown', function(e){ if(e.key==='Escape') close(); });
        })();
    </script>
    <script>
        window.resetForecastForm = function(){ try { var form = document.getElementById('upload_forecast'); if(!form) return; Array.from(form.querySelectorAll('select')).forEach(function(s){ if(s.options&&s.options.length) s.selectedIndex=0; }); Array.from(form.querySelectorAll('input[type="text"]')).forEach(function(i){ i.value=''; }); var fte=form.querySelector('#Human_resource_FTE'); if(fte) fte.value='0'; var personnel=form.querySelector('#Personnel_cost'); if(personnel) personnel.value=''; } catch(e){ console.warn(e); } };
    </script>
    <script>
        (function(){
            function parseNumber(v){ var n=parseFloat(v); return isNaN(n)?0:n; }
            function setup(){ var form=document.getElementById('upload_forecast'); if(!form) return; var cat=form.querySelector('select[name="Human_resource_category"]'); var year=form.querySelector('select[name="fiscal_year"]'); var fte=form.querySelector('#Human_resource_FTE'); var personnel=form.querySelector('#Personnel_cost'); function update(){ var c=cat?cat.value:''; var y=year?year.value:''; var f=fte?parseNumber(fte.value):0; if(!personnel) return; if(!c||!y){ personnel.value=''; return; } fetch('/api/hr_cost?category='+encodeURIComponent(c)+'&year='+encodeURIComponent(y)).then(r=>r.json()).then(j=>{ var base=parseNumber(j&&j.cost?j.cost:0); var total=base*f; personnel.value=(isNaN(total)||total===0)?(f===0?'0.00':''):total.toFixed(2); }).catch(()=>{ personnel.value=''; }); }
                [cat,year,fte].forEach(function(el){ el && el.addEventListener(el==='fte'?'input':'change', update); }); update(); }
            if(document.readyState==='complete'||document.readyState==='interactive') setup(); else document.addEventListener('DOMContentLoaded', setup);
        })();
    </script>
{% endblock %}