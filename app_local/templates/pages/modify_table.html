<!DOCTYPE html>
<html>
<head>
    <title>Modify {{ title }}</title>
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .form-group label {
            flex: 1 1 33%;
            max-width: 33%;
            min-width: 120px;
            text-align: left;
            margin-right: 12px;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"] {
            flex: 2 1 67%;
            max-width: 67%;
            min-width: 0;
        }
        .container {
            padding: 24px 0 0 0;
        }
        /* Page flex layout: top 20%, table 80% */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);
            box-sizing: border-box;
        }
        .page-top {
            flex: 0 0 20vh; /* top area 20% */
            box-sizing: border-box;
            padding: 24px 0 0 0;
        }
        .table-container {
            flex: 0 0 80vh; /* table area 80% */
            box-sizing: border-box;
            padding: 0 24px 24px 24px;
            overflow: auto;
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    <div class="page-wrapper">
        <div class="page-top">
            <div class="container">
                <h1>{{ title }}</h1>
                <!-- Add and Modify buttons to trigger modal popups -->
                <button id="add_button" type="button">Add</button>
                {% if table_name == 'human_resource_cost' or table_name == 'capex_forecasts' or table_name == 'budgets' or table_name == 'fundings' or table_name == 'capex_budgets' %}
                <button id="modify_button" type="button">Modify</button>
                {% endif %}

        <!-- Modal structure: hidden by default -->
        <div id="modifyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal-content" role="document">
                <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
                <h2 id="modalTitle">Modify {{ title }}</h2>
                <form method="POST" name="Modify_{{ table_name }}" id="modifyForm">
                    <input type="hidden" name="table_name" value="{{ table_name }}">
                    {% for field in fields %}
                        <div class="form-group">
                            <label for="{{ field.name }}">{{ field.label }}</label>
                            {% if field.type == 'select' %}
                                <select name="{{ field.name }}" id="{{ field.name }}" required>
                                    <option value="" disabled selected>Select an option</option>
                                    {% for option in field.options %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}"{% if not (table_name == 'ios' and (field.name|lower in ['io','io_num','io number','io_number'])) %} required{% endif %}>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="modalCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

                    <!-- Modify modal: single instance that submits to /change_staff_cost (render only for staff cost page) -->
            {% if table_name == 'human_resource_cost' or table_name == 'capex_forecasts' or table_name == 'budgets' or table_name == 'fundings' or table_name == 'capex_budgets' or table_name == 'pos' or table_name == 'departments' or table_name == 'project_categories' %}
                    <div id="modifyModalChange" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitleChange">
                        <div class="modal-overlay" id="modalOverlayChange"></div>
                        <div class="modal-content" role="document">
                            <button class="modal-close" id="modalCloseChange" aria-label="Close">&times;</button>
                            <h2 id="modalTitleChange">Modify {{ title }}</h2>
                    <form method="POST"
                        action="{% if table_name == 'human_resource_cost' %}{{ url_for('staff_cost_routes.change_staff_cost') }}{% elif table_name == 'capex_forecasts' %}{{ url_for('capex_forecast_routes.change_capex_forecast') }}{% elif table_name == 'budgets' %}{{ url_for('modify_tables.change_budget') }}{% elif table_name == 'fundings' %}{{ url_for('modify_tables.change_funding') }}{% elif table_name == 'capex_budgets' %}{{ url_for('capex_forecast_routes.change_capex_budget') }}{% elif table_name == 'pos' %}{{ url_for('po_routes.change_po') }}{% elif table_name == 'departments' %}{{ url_for('department_routes.change_department') }}{% elif table_name == 'project_categories' %}{{ url_for('project_category_routes.change_porject_category') }}{% endif %}"
                                  name="Change_{{ table_name }}" id="changeForm">
                                {% if table_name == 'pos' %}
                                <!-- Hidden field to carry the original PO name for update lookup -->
                                <input type="hidden" name="existing_name" id="change_existing_name" value="">
                                <!-- Hidden field to carry the PO id for precise updates -->
                                <input type="hidden" name="po_id" id="change_po_id" value="">
                                {% elif table_name == 'departments' %}
                                <!-- Hidden fields for Department change: existing name and id for precise update -->
                                <input type="hidden" name="existing_department" id="change_existing_department" value="">
                                <input type="hidden" name="department_id" id="change_department_id" value="">
                                {% elif table_name == 'project_categories' %}
                                <!-- Hidden fields for Project Category change: existing name and id for precise update -->
                                <input type="hidden" name="existing_category" id="change_existing_category" value="">
                                <input type="hidden" name="category_id" id="change_category_id" value="">
                                {% endif %}
                                <input type="hidden" name="table_name" value="{{ table_name }}">
                                {% for field in fields %}
                                    <div class="form-group">
                                        <label for="change_{{ field.name }}">{{ field.label }}</label>
                                        {% if field.type == 'select' %}
                                            <select name="{{ field.name }}" id="change_{{ field.name }}" required>
                                                <option value="" disabled selected>Select an option</option>
                                                {% for option in field.options %}
                                                    <option value="{{ option }}">{{ option }}</option>
                                                {% endfor %}
                                            </select>
                                        {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                            <input type="{{ field.type }}" name="{{ field.name }}" id="change_{{ field.name }}" required>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                <div style="margin-top:12px;">
                                    <button type="submit">Submit</button>
                                    <button type="button" id="modalCancelChange">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                <!-- table container area -->
                <div class="table-container">
                {% if columns %}
                    <!-- <h3>Current table data</h3> -->
                    <div id="gt-generic" style="height:60vh;" data-cols='{{ columns|tojson|safe }}' data-rows='{{ data|tojson|safe }}' data-table='{{ table_name }}'></div>
                    <script src="{{ url_for('static', filename='js/genericTable.js') }}"></script>
                    <script>
                        (function(){
                            try{
                                var el = document.getElementById('gt-generic');
                                if(!el) return;
                                var cols = JSON.parse(el.getAttribute('data-cols') || '[]');
                                var data = JSON.parse(el.getAttribute('data-rows') || '[]');
                                var rows = (data || []).map(function(arr){
                                    var obj = {}; (cols||[]).forEach(function(c,i){ obj[c] = (arr||[])[i]; }); return obj;
                                });
                                if(!window.GenericTable || !GenericTable.create) return;
                                var modalEl = document.getElementById('modifyModalChange');
                                var opts = { title: '', columns: cols, rows: rows };
                                if(modalEl){
                                    opts.rowClickEditModal = { selector: '#modifyModalChange' };
                                    // Special prefill for PO page: set both existing_name and the new input value
                                    var tableName = el.getAttribute('data-table') || '';
                                    if(tableName === 'pos'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                // Handle various display column names: 'PO Name' (from transform), or fallbacks
                                                var existing = row['PO Name'] || row.PO || row.name || row.Name || '';
                                                var ex = modal.querySelector('input[name="existing_name"]');
                                                if(ex) ex.value = existing;
                                                // Prefer id-based update
                                                var idIn = modal.querySelector('input[name="po_id"]');
                                                if(idIn && (row.id != null && row.id !== '')) idIn.value = row.id;
                                                var input = modal.querySelector('#change_PO') || modal.querySelector('input[name="PO"]');
                                                if(input) input.value = existing;
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'capex_forecasts'){
                                        // Prefill Change form for CapEx Forecasts
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                function pick(obj, keys){ for(var i=0;i<keys.length;i++){ var k=keys[i]; if(obj.hasOwnProperty(k) && obj[k] != null && obj[k] !== '') return String(obj[k]); } return ''; }
                                                // Extract display values from row with robust key detection
                                                var poVal = pick(row, ['PO','PO Name','po_name','name_po']);
                                                var deptVal = pick(row, ['Department','Department Name','department_name','BU','name_departments']);
                                                var yearVal = pick(row, ['Capital Year','Fiscal Year','fiscal_year','cap_year']);
                                                var projVal = pick(row, ['Project','Project Name','project_name']);
                                                var descVal = pick(row, ['Description','capex_description']);
                                                var forecastVal = pick(row, ['CapEx Forecast','capex_forecast','Forecast','forecast']);
                                                var costCenterVal = pick(row, ['Cost Center','cost_center']);

                                                // Set PO first
                                                var poSel = modal.querySelector('select[name="po"]');
                                                if(poSel && poVal){ poSel.value = poVal; }

                                                // Cap Year
                                                var yearSel = modal.querySelector('select[name="cap_year"]');
                                                if(yearSel && yearVal){ yearSel.value = String(yearVal); }

                                                // Description, Forecast, Cost Center
                                                var descIn = modal.querySelector('input[name="capex_description"]');
                                                if(descIn){ descIn.value = descVal; }
                                                var fcIn = modal.querySelector('input[name="capex_forecast"]');
                                                if(fcIn){ fcIn.value = forecastVal; }
                                                var ccIn = modal.querySelector('input[name="cost_center"]');
                                                if(ccIn){ ccIn.value = costCenterVal; }

                                                // Department depends on selected PO -> fetch filtered departments then set
                                                var deptSel = modal.querySelector('select[name="department"]');
                                                function setDeptAndMaybeProjects(){
                                                    if(deptSel && deptVal){ deptSel.value = deptVal; }
                                                    // After Department and Year are present, fetch project options and set
                                                    var projSel = modal.querySelector('select[name="project_name"]');
                                                    var currentPO = poSel ? poSel.value : '';
                                                    var currentDept = deptSel ? deptSel.value : '';
                                                    var currentFY = yearSel ? yearSel.value : '';
                                                    if(projSel && currentPO && currentDept && currentFY){
                                                        var url = '/capex_forecast/project_update?po=' + encodeURIComponent(currentPO) + '&department=' + encodeURIComponent(currentDept) + '&fiscal_year=' + encodeURIComponent(currentFY);
                                                        fetch(url)
                                                            .then(function(res){ return res.ok ? res.json() : { projects: [] }; })
                                                            .then(function(json){
                                                                try{
                                                                    // Rebuild project options
                                                                    projSel.innerHTML = '';
                                                                    var placeholder = document.createElement('option');
                                                                    placeholder.value = ''; placeholder.disabled = true; placeholder.selected = true; placeholder.textContent = 'Select an option';
                                                                    projSel.appendChild(placeholder);
                                                                    (json && json.projects ? json.projects : []).forEach(function(name){
                                                                        var opt = document.createElement('option'); opt.value = name; opt.textContent = name; projSel.appendChild(opt);
                                                                    });
                                                                    if(projVal){ projSel.value = projVal; }
                                                                }catch(e){}
                                                            })
                                                            .catch(function(){});
                                                    } else if (projSel && projVal){
                                                        projSel.value = projVal;
                                                    }
                                                }

                                                // If we have a PO selected, fetch filtered departments; otherwise just set value
                                                if(poSel && poSel.value){
                                                    fetch('/capex_forecast/department_update?po=' + encodeURIComponent(poSel.value))
                                                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                                                        .then(function(json){
                                                            try{
                                                                if(deptSel){
                                                                    // Rebuild department options
                                                                    deptSel.innerHTML = '';
                                                                    var placeholder = document.createElement('option');
                                                                    placeholder.value=''; placeholder.disabled=true; placeholder.selected=true; placeholder.textContent='Select an option';
                                                                    deptSel.appendChild(placeholder);
                                                                    (json && json.departments ? json.departments : []).forEach(function(name){
                                                                        var opt = document.createElement('option'); opt.value = name; opt.textContent = name; deptSel.appendChild(opt);
                                                                    });
                                                                }
                                                            }catch(e){}
                                                        })
                                                        .then(function(){ setDeptAndMaybeProjects(); })
                                                        .catch(function(){ setDeptAndMaybeProjects(); });
                                                } else {
                                                    setDeptAndMaybeProjects();
                                                }
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'departments'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                // Robustly detect department name from various possible column keys
                                                var candidateKeys = ['Department', 'department', 'Department Name', 'name_departments', 'name', 'Name', 'dept', 'department_name'];
                                                var deptName = '';
                                                for(var i=0;i<candidateKeys.length;i++){
                                                    var k = candidateKeys[i];
                                                    if(row.hasOwnProperty(k) && row[k] != null && row[k] !== ''){ deptName = row[k]; break; }
                                                }
                                                // Fallback: first non-empty value in the row object
                                                if(!deptName){
                                                    for(var k in row){ if(row[k] != null && row[k] !== ''){ deptName = row[k]; break; } }
                                                }

                                                // PO name detection (optional)
                                                var poKeys = ['PO','po','PO Name','name_po'];
                                                var poName = '';
                                                for(var j=0;j<poKeys.length;j++){ var pk = poKeys[j]; if(row.hasOwnProperty(pk) && row[pk]){ poName = row[pk]; break; } }

                                                // Hidden identifiers
                                                var ex = modal.querySelector('input[name="existing_department"]');
                                                if(ex) ex.value = deptName;
                                                var idIn = modal.querySelector('input[name="department_id"]');
                                                if(idIn && (row.id != null && row.id !== '')) idIn.value = row.id;

                                                // Visible fields inside the change form: prefer #change_Department
                                                var nameIn = modal.querySelector('#change_Department') || modal.querySelector('input[name="Department"]') || modal.querySelector('input[id="Department"]');
                                                if(nameIn) nameIn.value = deptName;
                                                // PO select prefill if present
                                                var poSel = modal.querySelector('#change_po') || modal.querySelector('select[name="po"]') || modal.querySelector('select[id="po"]');
                                                if(poSel && poName){ poSel.value = poName; }
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'project_categories'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                // Determine category name from common keys
                                                var candidateKeys = ['category','Category','Project Category','project_category','name','Name'];
                                                var catName = '';
                                                for(var i=0;i<candidateKeys.length;i++){
                                                    var k = candidateKeys[i];
                                                    if(row.hasOwnProperty(k) && row[k] != null && row[k] !== ''){ catName = row[k]; break; }
                                                }
                                                if(!catName){
                                                    for(var k in row){ if(row[k] != null && row[k] !== ''){ catName = row[k]; break; } }
                                                }
                                                var ex = modal.querySelector('input[name="existing_category"]');
                                                if(ex) ex.value = catName;
                                                var idIn = modal.querySelector('input[name="category_id"]');
                                                if(idIn && (row.id != null && row.id !== '')) idIn.value = row.id;
                                                var input = modal.querySelector('#change_category') || modal.querySelector('input[name="category"]');
                                                if(input) input.value = catName;
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'human_resource_cost'){
                                        opts.rowClickEditModal.prefill = function(modal, row){ try{}catch(e){} };
                                    } else if (tableName === 'budgets'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                function pick(o, keys){ for(var i=0;i<keys.length;i++){ var k=keys[i]; if(o.hasOwnProperty(k) && o[k] != null && o[k] !== '') return String(o[k]); } return ''; }
                                                var poVal = pick(row, ['PO','po','PO Name','name_po']);
                                                var deptVal = pick(row, ['Department','department','Department Name','name_departments','BU']);
                                                var fyVal = pick(row, ['Fiscal Year','fiscal_year','Year']);
                                                var hrVal = pick(row, ['Personnel budget','human_resource_expense','Human Resource Expense','human_resource_expense']);
                                                var npVal = pick(row, ['Non-personnel budget','non_personnel_expense','Non Personnel Expense','non_personnel_expense']);
                                                var poSel = modal.querySelector('select[name="po"]');
                                                var deptSel = modal.querySelector('select[name="department"]');
                                                var fySel = modal.querySelector('select[name="fiscal_year"]');
                                                var hrIn = modal.querySelector('input[name="human_resource_expense"]');
                                                var npIn = modal.querySelector('input[name="non_personnel_expense"]');
                                                if(poSel && poVal){ poSel.value = poVal; }
                                                if(fySel && fyVal){ fySel.value = String(fyVal); }
                                                if(hrIn && hrVal){ hrIn.value = hrVal; }
                                                if(npIn && npVal){ npIn.value = npVal; }
                                                if(deptSel && deptVal){ deptSel.value = deptVal; }
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'fundings'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                function pick(o, keys){ for(var i=0;i<keys.length;i++){ var k=keys[i]; if(o.hasOwnProperty(k) && o[k] != null && o[k] !== '') return String(o[k]); } return ''; }
                                                var poVal = pick(row, ['PO','po','PO Name','name_po']);
                                                var deptVal = pick(row, ['Department','department','Department Name','name_departments','BU']);
                                                var fyVal = pick(row, ['Fiscal Year','fiscal_year','Year']);
                                                var fundingVal = pick(row, ['Funding','funding']);
                                                var fromVal = pick(row, ['Funding From','funding_from']);
                                                var forVal = pick(row, ['Funding For','funding_for']);
                                                var poSel = modal.querySelector('select[name="po"]');
                                                var deptSel = modal.querySelector('select[name="department"]');
                                                var fySel = modal.querySelector('select[name="fiscal_year"]');
                                                var fIn = modal.querySelector('input[name="funding"]');
                                                var fromIn = modal.querySelector('input[name="funding_from"]');
                                                var forIn = modal.querySelector('input[name="funding_for"]');
                                                if(poSel && poVal){ poSel.value = poVal; }
                                                if(fySel && fyVal){ fySel.value = String(fyVal); }
                                                if(fIn && fundingVal){ fIn.value = fundingVal; }
                                                if(fromIn){ fromIn.value = fromVal; }
                                                if(forIn){ forIn.value = forVal; }
                                                if(deptSel && deptVal){ deptSel.value = deptVal; }
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'capex_budgets'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                function pick(obj, keys){ for(var i=0;i<keys.length;i++){ var k=keys[i]; if(obj.hasOwnProperty(k) && obj[k] != null && obj[k] !== '') return String(obj[k]); } return ''; }
                                                var poVal = pick(row, ['PO','PO Name','po','name_po']);
                                                var deptVal = pick(row, ['Department','Department Name','department','department_name','name_departments','BU']);
                                                var yearVal = pick(row, ['Capex Year','Capital Year','cap_year','Fiscal Year']);
                                                var projVal = pick(row, ['Project','Project Name','project_name']);
                                                var descVal = pick(row, ['Capex Description','Description','capex_description']);
                                                var budgetVal = pick(row, ['Approved Budget (K CNY)','Budget','budget','approved_budget']);
                                                var poSel = modal.querySelector('select[name="po"]');
                                                var yearSel = modal.querySelector('select[name="cap_year"]');
                                                var deptSel = modal.querySelector('select[name="department"]');
                                                var projSel = modal.querySelector('select[name="project_name"]');
                                                var descIn = modal.querySelector('input[name="capex_description"]');
                                                var budIn = modal.querySelector('input[name="approved_budget"], input[name="budget"]');
                                                if(poSel && poVal){ poSel.value = poVal; }
                                                if(yearSel && yearVal){ yearSel.value = String(yearVal); }
                                                if(descIn){ descIn.value = descVal; }
                                                if(budIn && budgetVal){ budIn.value = budgetVal; }
                                                function setDeptAndProjects(){
                                                    if(deptSel && deptVal){ deptSel.value = deptVal; }
                                                    var currentPO = poSel ? poSel.value : '';
                                                    var currentDept = deptSel ? deptSel.value : '';
                                                    var currentFY = yearSel ? yearSel.value : '';
                                                    if(projSel && currentPO && currentDept && currentFY){
                                                        var url = '/capex_forecast/project_update?po=' + encodeURIComponent(currentPO) + '&department=' + encodeURIComponent(currentDept) + '&fiscal_year=' + encodeURIComponent(currentFY);
                                                        fetch(url)
                                                            .then(function(res){ return res.ok ? res.json() : { projects: [] }; })
                                                            .then(function(json){
                                                                try{
                                                                    projSel.innerHTML = '';
                                                                    var placeholder = document.createElement('option');
                                                                    placeholder.value = ''; placeholder.disabled = true; placeholder.selected = true; placeholder.textContent = 'Select an option';
                                                                    projSel.appendChild(placeholder);
                                                                    (json && json.projects ? json.projects : []).forEach(function(name){
                                                                        var opt = document.createElement('option'); opt.value = name; opt.textContent = name; projSel.appendChild(opt);
                                                                    });
                                                                    if(projVal){ projSel.value = projVal; }
                                                                }catch(e){}
                                                            })
                                                            .catch(function(){});
                                                    } else if (projSel && projVal){ projSel.value = projVal; }
                                                }
                                                if(poSel && poSel.value){
                                                    fetch('/capex_forecast/department_update?po=' + encodeURIComponent(poSel.value))
                                                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                                                        .then(function(json){
                                                            try{
                                                                if(deptSel){
                                                                    deptSel.innerHTML = '';
                                                                    var placeholder = document.createElement('option');
                                                                    placeholder.value=''; placeholder.disabled=true; placeholder.selected=true; placeholder.textContent='Select an option';
                                                                    deptSel.appendChild(placeholder);
                                                                    (json && json.departments ? json.departments : []).forEach(function(name){
                                                                        var opt = document.createElement('option'); opt.value = name; opt.textContent = name; deptSel.appendChild(opt);
                                                                    });
                                                                }
                                                            }catch(e){}
                                                        })
                                                        .then(function(){ setDeptAndProjects(); })
                                                        .catch(function(){ setDeptAndProjects(); });
                                                } else {
                                                    setDeptAndProjects();
                                                }
                                            }catch(e){}
                                        };
                                    } else if (tableName === 'human_resource_cost'){
                                        opts.rowClickEditModal.prefill = function(modal, row){
                                            try{
                                                // Determine values from row with robust key detection
                                                function pick(row, keys){
                                                    for(var i=0;i<keys.length;i++){ var k = keys[i]; if(row.hasOwnProperty(k) && row[k] != null && row[k] !== '') return String(row[k]); }
                                                    return '';
                                                }
                                                var poVal = pick(row, ['PO','po','PO Name','name_po']);
                                                var deptVal = pick(row, ['BU','Department','department','department_name','name_departments']);
                                                var catVal = pick(row, ['Staff Category','staff_category','Category','category','name']);
                                                var yearVal = pick(row, ['Year','year','Fiscal Year','fiscal_year']);
                                                var costVal = pick(row, ['Cost','cost','human_resource_expense']);

                                                var poSel = modal.querySelector('select[name="po"]');
                                                var deptSel = modal.querySelector('select[name="department"]');
                                                var catSel = modal.querySelector('select[name="staff_category"]');
                                                var yearSel = modal.querySelector('select[name="year"]');
                                                var costIn = modal.querySelector('input[name="cost"]');

                                                if (poSel && poVal){ poSel.value = poVal; }
                                                if (yearSel && yearVal){ yearSel.value = String(yearVal); }
                                                if (catSel && catVal){ catSel.value = catVal; }
                                                if (costIn && costVal){ costIn.value = costVal; }

                                                // For Department, rebuild options based on selected PO, then set value
                                                if (poSel && deptSel && poSel.value){
                                                    var po = poSel.value;
                                                    fetch('/capex_forecast/department_update?po=' + encodeURIComponent(po))
                                                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                                                        .then(function(json){
                                                            try{
                                                                // Rebuild department options
                                                                while (deptSel.firstChild) deptSel.removeChild(deptSel.firstChild);
                                                                var placeholder = document.createElement('option');
                                                                placeholder.value = ''; placeholder.disabled = true; placeholder.selected = true; placeholder.textContent = 'Select an option';
                                                                deptSel.appendChild(placeholder);
                                                                (json && json.departments ? json.departments : []).forEach(function(name){
                                                                    var opt = document.createElement('option'); opt.value = name; opt.textContent = name; deptSel.appendChild(opt);
                                                                });
                                                                if (deptVal){ deptSel.value = deptVal; }
                                                            }catch(e){}
                                                        })
                                                        .catch(function(){});
                                                } else if (deptSel && deptVal){
                                                    deptSel.value = deptVal;
                                                }
                                            }catch(e){}
                                        };
                                    }
                                }
                                GenericTable.create(el, opts);
                                // Inject per-row Delete actions strictly for CapEx Forecasts table
                                if (tableName === 'capex_forecasts') {
                                    function injectDeleteButtons(){
                                        try{
                                            var table = el.querySelector('table');
                                            if(!table) return;
                                            var theadTr = table.querySelector('thead tr');
                                            if(theadTr && !theadTr.querySelector('th.gt-delete-col')){
                                                var th = document.createElement('th');
                                                th.className = 'gt-delete-col';
                                                th.textContent = 'Delete';
                                                theadTr.appendChild(th);
                                            }
                                            var headerTexts = Array.prototype.map.call(table.querySelectorAll('thead th'), function(th){ return (th.textContent||'').trim(); });
                                            table.querySelectorAll('tbody tr').forEach(function(tr){
                                                if(tr.querySelector('td.gt-delete-cell')) return; // already injected
                                                var td = document.createElement('td');
                                                td.className = 'gt-delete-cell';
                                                var btn = document.createElement('button');
                                                btn.type = 'button';
                                                btn.textContent = 'Delete';
                                                btn.style.cssText = 'padding:2px 6px;font-size:12px;background:#c0392b;color:#fff;border:none;border-radius:4px;cursor:pointer;';
                                                btn.addEventListener('click', function(ev){
                                                    ev.stopPropagation();
                                                    try{
                                                        var cells = Array.prototype.slice.call(tr.querySelectorAll('td, th'));
                                                        // Build a case-insensitive, normalized header->cell map
                                                        function norm(s){
                                                            return (s||'').toLowerCase().replace(/\u00a0/g,' ').replace(/\s+/g,' ').trim();
                                                        }
                                                        var lowerMap = {};
                                                        for (var i = 0; i < headerTexts.length && i < cells.length; i++) {
                                                            var key = norm(headerTexts[i] || '');
                                                            lowerMap[key] = (cells[i].textContent || '').trim();
                                                        }
                                                        function pickLower(map, keys){
                                                            for (var j=0;j<keys.length;j++){
                                                                var k = keys[j];
                                                                if (map.hasOwnProperty(k) && map[k] !== '') return map[k];
                                                            }
                                                            return '';
                                                        }
                                                        var poVal = pickLower(lowerMap, ['po','po name','po_name','name_po']);
                                                        var deptVal = pickLower(lowerMap, ['department','department name','department_name','bu','dept','bu name','name_departments']);
                                                        var projVal = pickLower(lowerMap, ['project','project name','project_name']);
                                                        var yearVal = pickLower(lowerMap, ['capex year','capital year','fiscal year','cap year','year','cap_year']);
                                                        var descVal = pickLower(lowerMap, ['capex description','capex_description','capex desc','description','desc']);
                                                        // Substring-based fallbacks if exact header match failed
                                                        function pickByIncludes(map, includeAny){
                                                            var keys = Object.keys(map);
                                                            for (var i=0;i<keys.length;i++){
                                                                var k = keys[i];
                                                                for (var j=0;j<includeAny.length;j++){
                                                                    if (k.indexOf(includeAny[j]) !== -1) return map[k];
                                                                }
                                                            }
                                                            return '';
                                                        }
                                                        if (!poVal) poVal = pickByIncludes(lowerMap, ['po']);
                                                        if (!deptVal) deptVal = pickByIncludes(lowerMap, ['department','dept','bu']);
                                                        if (!projVal) projVal = pickByIncludes(lowerMap, ['project']);
                                                        if (!yearVal) yearVal = pickByIncludes(lowerMap, ['capex','capital','fiscal','cap','year']);
                                                        if (!descVal) descVal = pickByIncludes(lowerMap, ['description','desc']);

                                                        if(!(poVal && deptVal && projVal && yearVal)){
                                                            alert('Missing key fields for deletion.');
                                                            return;
                                                        }
                                                        if(!confirm('Delete forecast for '+ (projVal||'') +' / '+ (deptVal||'') +' / '+ (poVal||'') +' ('+ (yearVal||'') +')?')) return;

                                                        fetch('/capex_forecast/delete_capex_forecast', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ po: poVal, department: deptVal, project_name: projVal, cap_year: yearVal, capex_description: descVal })
                                                        }).then(function(r){ return r.json(); }).then(function(resp){
                                                            if(resp && resp.status === 'ok'){
                                                                tr.remove();
                                                            } else {
                                                                alert('Delete failed: ' + ((resp && resp.message) ? resp.message : 'unknown error'));
                                                            }
                                                        }).catch(function(err){ alert('Delete error: ' + err); });
                                                    }catch(e){ }
                                                });
                                                td.appendChild(btn);
                                                tr.appendChild(td);
                                            });
                                        }catch(e){}
                                    }
                                    // initial injection after a short delay to allow render
                                    setTimeout(injectDeleteButtons, 60);
                                    // observe changes under the container to re-inject on pagination/redraw
                                    var obs = new MutationObserver(function(){ injectDeleteButtons(); });
                                    obs.observe(el, { childList: true, subtree: true });
                                }
                            }catch(e){}
                        })();
                    </script>
                {% endif %}
                </div>
            </div>
            {% if table_name == 'projects' %}
            <div style="padding: 0 24px 24px 24px;">
                <h3>Projects</h3>
                <div id="projectsTable" style="height:300px;"></div>
                <h3 style="margin-top:16px;">IOs</h3>
                <div id="iosTable" style="height:300px;"></div>
            </div>
            <script src="{{ url_for('static', filename='js/genericTable.js') }}"></script>
            <script>
            (function(){
                function fetchJSON(url){ return fetch(url).then(function(r){ return r.ok ? r.json() : {columns:[], rows:[]}; }); }
                function mountTable(elId, title, listUrl, onRowClick){
                    var el = document.getElementById(elId);
                    if(!el) return;
                    fetchJSON(listUrl).then(function(data){
                        var cols = data.columns || [];
                        var rows = (data.rows || []).map(function(r){ return r; });
                        GenericTable.create(el, {
                            title: title,
                            columns: cols,
                            rows: rows,
                            defaultPageSize: 10,
                            onRowClick: onRowClick
                        });
                    });
                }

                function openProjectEdit(row){
                    var addBtn = document.getElementById('add_button');
                    if(addBtn) addBtn.click();
                    setTimeout(function(){
                        var modal = document.getElementById('modifyModal');
                        if(!modal) return;
                        var nameIn = modal.querySelector('input[name="name"]');
                        if(nameIn && row.Project) nameIn.value = row.Project;
                        var poSel = modal.querySelector('select[name="po"]');
                        if(poSel && row.PO){ poSel.value = row.PO; poSel.dispatchEvent(new Event('change')); }
                        var deptSel = modal.querySelector('select[name="department"]');
                        if(deptSel && row.BU){ deptSel.value = row.BU; }
                        var fySel = modal.querySelector('select[name="fiscal_year"]');
                        if(fySel && row['Fiscal Year']){ fySel.value = String(row['Fiscal Year']); }
                    }, 50);
                }

                function openIoEdit(row){
                    var addBtn = document.getElementById('add_button');
                    if(addBtn) addBtn.click();
                    setTimeout(function(){
                        var modal = document.getElementById('modifyModal');
                        if(!modal) return;
                        var ioIn = modal.querySelector('input[name="IO"], input[name="io"], input[name="IO_num"]');
                        if(ioIn && row.IO != null){ ioIn.value = row.IO; }
                        var projSel = modal.querySelector('select[name="project_name"]');
                        if(projSel && row.Project){ projSel.value = row.Project; }
                    }, 50);
                }

                mountTable('projectsTable', 'Projects', "{{ url_for('project_routes.list_projects') }}", openProjectEdit);
                mountTable('iosTable', 'IOs', "{{ url_for('io_routes.list_ios') }}", openIoEdit);
            })();
            </script>
            {% endif %}
    <script>
        // Modal open/close logic
        (function(){
            var addBtn = document.getElementById('add_button');
            var modal = document.getElementById('modifyModal');
            var modalClose = document.getElementById('modalClose');
            var modalOverlay = document.getElementById('modalOverlay');
            var modalCancel = document.getElementById('modalCancel');

            function openModal(){
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden','false');
                // prevent background scrolling
                document.body.style.overflow = 'hidden';
                // focus first input
                var firstInput = modal.querySelector('input, select, button');
                if(firstInput) firstInput.focus();
            }
            function closeModal(){
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            addBtn && addBtn.addEventListener('click', openModal);
            modalClose && modalClose.addEventListener('click', closeModal);
            modalOverlay && modalOverlay.addEventListener('click', closeModal);
            modalCancel && modalCancel.addEventListener('click', closeModal);

            // Modify modal handlers
            var modifyBtn = document.getElementById('modify_button');
            var modalChange = document.getElementById('modifyModalChange');
            var modalCloseChange = document.getElementById('modalCloseChange');
            var modalOverlayChange = document.getElementById('modalOverlayChange');
            var modalCancelChange = document.getElementById('modalCancelChange');

            function openChangeModal(){
                modalChange.style.display = 'block';
                modalChange.setAttribute('aria-hidden','false');
                document.body.style.overflow = 'hidden';
                var firstInput = modalChange.querySelector('input, select, button');
                if(firstInput) firstInput.focus();
            }
            function closeChangeModal(){
                modalChange.style.display = 'none';
                modalChange.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            modifyBtn && modifyBtn.addEventListener('click', openChangeModal);
            modalCloseChange && modalCloseChange.addEventListener('click', closeChangeModal);
            modalOverlayChange && modalOverlayChange.addEventListener('click', closeChangeModal);
            modalCancelChange && modalCancelChange.addEventListener('click', closeChangeModal);
            // close on escape
            document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeModal(); });
        })();
    </script>
    <script>
        // When selects inside modify modal change (PO, Department, Cap Year, Project), notify server so module-level vars update
        (function () {
            var modal = document.getElementById('modifyModal');
            function attachChangeHandlers() {
                if (!modal) return;
                // PO
                var poSelects = modal.querySelectorAll('select[name="po"], select[id="po"], select[name="PO"], select[id="PO"]');
                poSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        // notify server of PO selection (module-level state)
                        fetch('/capex_forecast/po_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ po: val }) }).catch(function () { });

                        // After notifying server, request updated department list filtered by this PO
                        try {
                            var url = '/capex_forecast/department_update?po=' + encodeURIComponent(val);
                            fetch(url).then(function (res) {
                                if (!res.ok) return null;
                                return res.json();
                            }).then(function (data) {
                                if (!data || !data.departments) return;
                                // rebuild department selects inside the modal
                                var deptSelects = modal.querySelectorAll('select[name="department"], select[id="department"], select[name="Department"], select[id="Department"]');
                                deptSelects.forEach(function (dsel) {
                                    // preserve a default placeholder option
                                    dsel.innerHTML = '';
                                    var placeholder = document.createElement('option');
                                    placeholder.value = '';
                                    placeholder.disabled = true;
                                    placeholder.selected = true;
                                    placeholder.textContent = 'Select an option';
                                    dsel.appendChild(placeholder);
                                    data.departments.forEach(function (opt) {
                                        var o = document.createElement('option');
                                        o.value = opt;
                                        o.textContent = opt;
                                        dsel.appendChild(o);
                                    });
                                });
                            }).catch(function () { /* ignore */ });
                        } catch (e) {
                            /* ignore */
                        }
                    });
                });

                // Department
                var deptSelects = modal.querySelectorAll('select[name="department"], select[id="department"], select[name="Department"], select[id="Department"]');
                deptSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        fetch('/capex_forecast/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: val }) }).catch(function () { });
                        // attempt to refresh projects if PO, Department and Cap Year are selected
                        try {
                            var currentPO = (modal.querySelector('select[name="po"]') || modal.querySelector('select[id="po"]'))?.value || '';
                            var currentDept = val;
                            var currentFY = (modal.querySelector('select[name="cap_year"]') || modal.querySelector('select[id="cap_year"]'))?.value || '';
                            if (currentPO && currentDept && currentFY) {
                                var url = '/capex_forecast/project_update?po=' + encodeURIComponent(currentPO) + '&department=' + encodeURIComponent(currentDept) + '&fiscal_year=' + encodeURIComponent(currentFY);
                                fetch(url).then(function (res) {
                                    if (!res.ok) return null;
                                    return res.json();
                                }).then(function (data) {
                                    if (!data || !data.projects) return;
                                    var projSelects = modal.querySelectorAll('select[name="project_name"], select[id="project_name"], select[name="Project Name"], select[id="Project Name"]');
                                    projSelects.forEach(function (ps) {
                                        ps.innerHTML = '';
                                        var placeholder = document.createElement('option');
                                        placeholder.value = '';
                                        placeholder.disabled = true;
                                        placeholder.selected = true;
                                        placeholder.textContent = 'Select an option';
                                        ps.appendChild(placeholder);
                                        data.projects.forEach(function (opt) {
                                            var o = document.createElement('option');
                                            o.value = opt;
                                            o.textContent = opt;
                                            ps.appendChild(o);
                                        });
                                    });
                                }).catch(function () { });
                            }
                        } catch (e) { /* ignore */ }
                    });
                });

                // Cap Year
                var capYearSelects = modal.querySelectorAll('select[name="cap_year"], select[id="cap_year"], select[name="CapYear"], select[id="CapYear"]');
                capYearSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        fetch('/capex_forecast/cap_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cap_year: val }) }).catch(function () { });
                        // when cap year changes, try to refresh projects if PO & Department are set
                        try {
                            var currentPO = (modal.querySelector('select[name="po"]') || modal.querySelector('select[id="po"]'))?.value || '';
                            var currentDept = (modal.querySelector('select[name="department"]') || modal.querySelector('select[id="department"]'))?.value || '';
                            var currentFY = val;
                            if (currentPO && currentDept && currentFY) {
                                var url = '/capex_forecast/project_update?po=' + encodeURIComponent(currentPO) + '&department=' + encodeURIComponent(currentDept) + '&fiscal_year=' + encodeURIComponent(currentFY);
                                fetch(url).then(function (res) {
                                    if (!res.ok) return null;
                                    return res.json();
                                }).then(function (data) {
                                    if (!data || !data.projects) return;
                                    var projSelects = modal.querySelectorAll('select[name="project_name"], select[id="project_name"], select[name="Project Name"], select[id="Project Name"]');
                                    projSelects.forEach(function (ps) {
                                        ps.innerHTML = '';
                                        var placeholder = document.createElement('option');
                                        placeholder.value = '';
                                        placeholder.disabled = true;
                                        placeholder.selected = true;
                                        placeholder.textContent = 'Select an option';
                                        ps.appendChild(placeholder);
                                        data.projects.forEach(function (opt) {
                                            var o = document.createElement('option');
                                            o.value = opt;
                                            o.textContent = opt;
                                            ps.appendChild(o);
                                        });
                                    });
                                }).catch(function () { });
                            }
                        } catch (e) { /* ignore */ }
                    });
                });

                // Project Name
                var projSelects = modal.querySelectorAll('select[name="project_name"], select[id="project_name"], select[name="Project Name"], select[id="Project Name"]');
                projSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        fetch('/capex_forecast/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: val }) }).catch(function () { });
                    });
                });
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') attachChangeHandlers(); else document.addEventListener('DOMContentLoaded', attachChangeHandlers);
            // Also attach when modal opens (in case fields are re-rendered)
            var addBtn = document.getElementById('add_button');
            if (addBtn) addBtn.addEventListener('click', function () { setTimeout(attachChangeHandlers, 30); });
        })();
    </script>
    {% if table_name == 'projects' %}
    <script>
        // For Modify Project: filter Department options by selected PO within the Add modal
        (function(){
            var modal = document.getElementById('modifyModal');
            if (!modal) return;
            function attachHandlers(){
                var poSel = modal.querySelector('select[name="po"], #po');
                var deptSel = modal.querySelector('select[name="department"], #department');
                if (!poSel || !deptSel) return;
                function rebuildDeptOptions(list){
                    try{
                        while (deptSel.firstChild) deptSel.removeChild(deptSel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.disabled = true;
                        placeholder.selected = true;
                        placeholder.textContent = 'Select an option';
                        deptSel.appendChild(placeholder);
                        (list || []).forEach(function(name){
                            var opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            deptSel.appendChild(opt);
                        });
                    }catch(e){}
                }
                function fetchDepartments(){
                    var val = poSel.value || '';
                    if (!val) { rebuildDeptOptions([]); return; }
                    fetch('/modify_project/departments?po=' + encodeURIComponent(val))
                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                        .then(function(json){ rebuildDeptOptions(json && json.departments ? json.departments : []); })
                        .catch(function(){ rebuildDeptOptions([]); });
                }
                poSel.addEventListener('change', fetchDepartments);
                // initialize once in case a PO is preselected
                fetchDepartments();
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') attachHandlers(); else document.addEventListener('DOMContentLoaded', attachHandlers);
            // Also attach when Add modal opens
            var addBtn = document.getElementById('add_button');
            if (addBtn) addBtn.addEventListener('click', function(){ setTimeout(function(){ attachHandlers(); }, 30); });
        })();
    </script>
    {% endif %}
    {% if table_name == 'human_resource_cost' %}
    <script>
        // For Staff Cost: when PO changes, filter Department options by selected PO.
        // Staff Category remains unfiltered (all categories pre-populated by the server).
        (function(){
            function rebuildOptions(selectEl, values){
                if (!selectEl) return;
                try {
                    while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    placeholder.textContent = 'Select an option';
                    selectEl.appendChild(placeholder);
                    (values || []).forEach(function(v){
                        var o = document.createElement('option');
                        o.value = v;
                        o.textContent = v;
                        selectEl.appendChild(o);
                    });
                } catch(e) {}
            }
            function attachHandlersForModal(modalEl){
                if (!modalEl) return;
                var poSel = modalEl.querySelector('select[name="po"]');
                var deptSel = modalEl.querySelector('select[name="department"]');
                if (!poSel || !deptSel) return;
                function refreshDepartments(){
                    var po = poSel.value || '';
                    if (!po){ rebuildOptions(deptSel, []); return; }
                    fetch('/capex_forecast/department_update?po=' + encodeURIComponent(po))
                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                        .then(function(json){ rebuildOptions(deptSel, (json && json.departments) ? json.departments : []); })
                        .catch(function(){ rebuildOptions(deptSel, []); });
                }
                poSel.addEventListener('change', refreshDepartments);
                // Initialize once in case a PO is preselected
                refreshDepartments();
            }
            function onReady(){
                attachHandlersForModal(document.getElementById('modifyModal'));
                attachHandlersForModal(document.getElementById('modifyModalChange'));
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') onReady(); else document.addEventListener('DOMContentLoaded', onReady);
            var addBtn = document.getElementById('add_button');
            var modifyBtn = document.getElementById('modify_button');
            if (addBtn) addBtn.addEventListener('click', function(){ setTimeout(onReady, 30); });
            if (modifyBtn) modifyBtn.addEventListener('click', function(){ setTimeout(onReady, 30); });
        })();
    </script>
    {% endif %}
    <style>
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; }
        .modal-overlay { position: absolute; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4); }
        .modal-content { position: relative; max-width: 760px; margin: 60px auto; background: #fff; border-radius: 6px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 2010; }
        .modal-close { position: absolute; right: 10px; top: 8px; font-size: 24px; background: transparent; border: none; cursor: pointer; }
        /* Ensure form layout inside modal looks consistent */
        .modal-content .form-group { margin-bottom: 14px; }
    </style>
</body>
</html>