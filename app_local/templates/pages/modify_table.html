<!DOCTYPE html>
<html>
<head>
    <title>Modify {{ title }}</title>
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .form-group label {
            flex: 1 1 33%;
            max-width: 33%;
            min-width: 120px;
            text-align: left;
            margin-right: 12px;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"] {
            flex: 2 1 67%;
            max-width: 67%;
            min-width: 0;
        }
        .container {
            padding: 24px 0 0 0;
        }
        /* Page flex layout: top 20%, table 80% */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);
            box-sizing: border-box;
        }
        .page-top {
            flex: 0 0 20vh; /* top area 20% */
            box-sizing: border-box;
            padding: 24px 0 0 0;
        }
        .table-container {
            flex: 0 0 80vh; /* table area 80% */
            box-sizing: border-box;
            padding: 0 24px 24px 24px;
            overflow: auto;
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    <div class="page-wrapper">
        <div class="page-top">
            <div class="container">
                <h1>{{ title }}</h1>
                <!-- Add and Modify buttons to trigger modal popups -->
                <button id="add_button" type="button">Add</button>
                <button id="modify_button" type="button">Modify</button>

        <!-- <form method="POST" name="Modify_{{ table_name }}">
            <input type="hidden" name="table_name" value="{{ table_name }}">
            {% for field in fields %}
                <div class="form-group">
                    <label for="{{ field.name }}">{{ field.label }}</label>
                    {% if field.type == 'select' %}
                        <select name="{{ field.name }}" id="{{ field.name }}" required>
                            <option value="" disabled selected>Select an option</option>
                            {% for option in field.options %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                        <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}" required{% if field.type == 'number' %} step="0.1" onblur="if(this.value!==''){this.value = parseFloat(this.value).toFixed(1)}"{% endif %}>
                    {% endif %}
                </div>
            {% endfor %}
            <button type="submit">Submit</button>
        </form> -->
        <!-- Modal structure: hidden by default -->
        <div id="modifyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal-content" role="document">
                <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
                <h2 id="modalTitle">Modify {{ title }}</h2>
                <form method="POST" name="Modify_{{ table_name }}" id="modifyForm">
                    <input type="hidden" name="table_name" value="{{ table_name }}">
                    {% for field in fields %}
                        <div class="form-group">
                            <label for="{{ field.name }}">{{ field.label }}</label>
                            {% if field.type == 'select' %}
                                <select name="{{ field.name }}" id="{{ field.name }}" required>
                                    <option value="" disabled selected>Select an option</option>
                                    {% for option in field.options %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}" required>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="modalCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

                    <!-- Modify modal: single instance that submits to /change_staff_cost -->
                    <div id="modifyModalChange" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitleChange">
                        <div class="modal-overlay" id="modalOverlayChange"></div>
                        <div class="modal-content" role="document">
                            <button class="modal-close" id="modalCloseChange" aria-label="Close">&times;</button>
                            <h2 id="modalTitleChange">Modify {{ title }}</h2>
                            <form method="POST" action="{{ url_for('modify_tables.change_staff_cost') }}" name="Change_{{ table_name }}" id="changeForm">
                                <input type="hidden" name="table_name" value="{{ table_name }}">
                                {% for field in fields %}
                                    <div class="form-group">
                                        <label for="change_{{ field.name }}">{{ field.label }}</label>
                                        {% if field.type == 'select' %}
                                            <select name="{{ field.name }}" id="change_{{ field.name }}" required>
                                                <option value="" disabled selected>Select an option</option>
                                                {% for option in field.options %}
                                                    <option value="{{ option }}">{{ option }}</option>
                                                {% endfor %}
                                            </select>
                                        {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                            <input type="{{ field.type }}" name="{{ field.name }}" id="change_{{ field.name }}" required>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                <div style="margin-top:12px;">
                                    <button type="submit">Submit</button>
                                    <button type="button" id="modalCancelChange">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                <!-- table container area -->
                <div class="table-container">
                {% if columns and data %}
                    <h3>Current table data</h3>
                    <table id="modify_data_table" class="display" style="width:100%" border="1">
                        <thead>
                            <tr>
                                {% for col in columns %}
                                <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr>
                                {% for item in row %}
                                {% set colname = columns[loop.index0] if columns|length > loop.index0 else '' %}
                                {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname == 'PO' or colname == 'IO' or colname == 'IO number' or colname == 'IO Number' or colname|lower == 'po' or colname|lower == 'io' or colname|lower == 'io number' or colname == 'Fiscal Year' or colname|lower == 'fiscal year' or colname|lower == 'fiscal_year' or colname == 'Capital Year' or colname|lower == 'capital year' or colname|lower == 'capital_year' or colname == 'Year' or colname|lower == 'year') %}
                                    <td>{{ item|as_int }}</td>
                                {% else %}
                                    <td>{{ item|one_decimal }}</td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- jQuery and DataTables JS (CDN with local fallback) -->
                    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
                    <script>
                        if (typeof jQuery === 'undefined') {
                            var s = document.createElement('script');
                            s.src = "{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}";
                            document.head.appendChild(s);
                        }
                    </script>
                    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
                    <script>
                        (function ensureDataTables(){
                            if (window.jQuery && (!jQuery.fn || !jQuery.fn.dataTable)) {
                                var s = document.createElement('script');
                                s.src = "{{ url_for('static', filename='vendor/jquery.dataTables.min.js') }}";
                                document.head.appendChild(s);
                            }
                        })();
                    </script>
                    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
                    <script>
                    (function initModifyTable(retries){
                        retries = retries || 20;
                        function init(){
                            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.dataTable) {
                                $('#modify_data_table').DataTable({ paging: true, searching: true, ordering: true, lengthMenu: [[10,25,50,100],[10,25,50,100]] });
                            } else if (retries > 0) {
                                setTimeout(function(){ initModifyTable(retries - 1); }, 200);
                            } else {
                                console.warn('DataTables not available for modify table.');
                            }
                        }
                        if (document.readyState === 'complete' || document.readyState === 'interactive') init(); else document.addEventListener('DOMContentLoaded', init);
                    })();
                    </script>
                {% endif %}
                </div>
            </div>
    <script>
        // Modal open/close logic
        (function(){
            var addBtn = document.getElementById('add_button');
            var modal = document.getElementById('modifyModal');
            var modalClose = document.getElementById('modalClose');
            var modalOverlay = document.getElementById('modalOverlay');
            var modalCancel = document.getElementById('modalCancel');

            function openModal(){
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden','false');
                // prevent background scrolling
                document.body.style.overflow = 'hidden';
                // focus first input
                var firstInput = modal.querySelector('input, select, button');
                if(firstInput) firstInput.focus();
            }
            function closeModal(){
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            addBtn && addBtn.addEventListener('click', openModal);
            modalClose && modalClose.addEventListener('click', closeModal);
            modalOverlay && modalOverlay.addEventListener('click', closeModal);
            modalCancel && modalCancel.addEventListener('click', closeModal);

            // Modify modal handlers
            var modifyBtn = document.getElementById('modify_button');
            var modalChange = document.getElementById('modifyModalChange');
            var modalCloseChange = document.getElementById('modalCloseChange');
            var modalOverlayChange = document.getElementById('modalOverlayChange');
            var modalCancelChange = document.getElementById('modalCancelChange');

            function openChangeModal(){
                modalChange.style.display = 'block';
                modalChange.setAttribute('aria-hidden','false');
                document.body.style.overflow = 'hidden';
                var firstInput = modalChange.querySelector('input, select, button');
                if(firstInput) firstInput.focus();
            }
            function closeChangeModal(){
                modalChange.style.display = 'none';
                modalChange.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            modifyBtn && modifyBtn.addEventListener('click', openChangeModal);
            modalCloseChange && modalCloseChange.addEventListener('click', closeChangeModal);
            modalOverlayChange && modalOverlayChange.addEventListener('click', closeChangeModal);
            modalCancelChange && modalCancelChange.addEventListener('click', closeChangeModal);
            // close on escape
            document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeModal(); });
        })();
    </script>
    <style>
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; }
        .modal-overlay { position: absolute; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4); }
        .modal-content { position: relative; max-width: 760px; margin: 60px auto; background: #fff; border-radius: 6px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 2010; }
        .modal-close { position: absolute; right: 10px; top: 8px; font-size: 24px; background: transparent; border: none; cursor: pointer; }
        /* Ensure form layout inside modal looks consistent */
        .modal-content .form-group { margin-bottom: 14px; }
    </style>
</body>
</html>