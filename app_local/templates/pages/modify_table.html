<!DOCTYPE html>
<html>
<head>
    <title>Modify {{ title }}</title>
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .form-group label {
            flex: 1 1 33%;
            max-width: 33%;
            min-width: 120px;
            text-align: left;
            margin-right: 12px;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"] {
            flex: 2 1 67%;
            max-width: 67%;
            min-width: 0;
        }
        .container {
            padding: 24px 0 0 0;
        }
        /* Page flex layout: top 20%, table 80% */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);
            box-sizing: border-box;
        }
        .page-top {
            flex: 0 0 20vh; /* top area 20% */
            box-sizing: border-box;
            padding: 24px 0 0 0;
        }
        .table-container {
            flex: 0 0 80vh; /* table area 80% */
            box-sizing: border-box;
            padding: 0 24px 24px 24px;
            overflow: auto;
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    <div class="page-wrapper">
        <div class="page-top">
            <div class="container">
                <h1>{{ title }}</h1>
                <!-- Add and Modify buttons to trigger modal popups -->
                <button id="add_button" type="button">Add</button>
                {% if table_name == 'human_resource_cost' or table_name == 'capex_forecasts' %}
                <button id="modify_button" type="button">Modify</button>
                {% endif %}

        <!-- <form method="POST" name="Modify_{{ table_name }}">
            <input type="hidden" name="table_name" value="{{ table_name }}">
            {% for field in fields %}
                <div class="form-group">
                    <label for="{{ field.name }}">{{ field.label }}</label>
                    {% if field.type == 'select' %}
                        <select name="{{ field.name }}" id="{{ field.name }}" required>
                            <option value="" disabled selected>Select an option</option>
                            {% for option in field.options %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                        <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}" required{% if field.type == 'number' %} step="0.1" onblur="if(this.value!==''){this.value = parseFloat(this.value).toFixed(1)}"{% endif %}>
                    {% endif %}
                </div>
            {% endfor %}
            <button type="submit">Submit</button>
        </form> -->
        <!-- Modal structure: hidden by default -->
        <div id="modifyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal-content" role="document">
                <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
                <h2 id="modalTitle">Modify {{ title }}</h2>
                <form method="POST" name="Modify_{{ table_name }}" id="modifyForm">
                    <input type="hidden" name="table_name" value="{{ table_name }}">
                    {% for field in fields %}
                        <div class="form-group">
                            <label for="{{ field.name }}">{{ field.label }}</label>
                            {% if field.type == 'select' %}
                                <select name="{{ field.name }}" id="{{ field.name }}" required>
                                    <option value="" disabled selected>Select an option</option>
                                    {% for option in field.options %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}"{% if not (table_name == 'ios' and (field.name|lower in ['io','io_num','io number','io_number'])) %} required{% endif %}>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="modalCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

                    <!-- Modify modal: single instance that submits to /change_staff_cost (render only for staff cost page) -->
            {% if table_name == 'human_resource_cost' or table_name == 'capex_forecasts' %}
                    <div id="modifyModalChange" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitleChange">
                        <div class="modal-overlay" id="modalOverlayChange"></div>
                        <div class="modal-content" role="document">
                            <button class="modal-close" id="modalCloseChange" aria-label="Close">&times;</button>
                            <h2 id="modalTitleChange">Modify {{ title }}</h2>
                    <form method="POST"
                        action="{% if table_name == 'human_resource_cost' %}{{ url_for('modify_tables.change_staff_cost') }}{% elif table_name == 'capex_forecasts' %}{{ url_for('modify_tables.change_capex_forecast') }}{% endif %}"
                                  name="Change_{{ table_name }}" id="changeForm">
                                <input type="hidden" name="table_name" value="{{ table_name }}">
                                {% for field in fields %}
                                    <div class="form-group">
                                        <label for="change_{{ field.name }}">{{ field.label }}</label>
                                        {% if field.type == 'select' %}
                                            <select name="{{ field.name }}" id="change_{{ field.name }}" required>
                                                <option value="" disabled selected>Select an option</option>
                                                {% for option in field.options %}
                                                    <option value="{{ option }}">{{ option }}</option>
                                                {% endfor %}
                                            </select>
                                        {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                            <input type="{{ field.type }}" name="{{ field.name }}" id="change_{{ field.name }}" required>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                <div style="margin-top:12px;">
                                    <button type="submit">Submit</button>
                                    <button type="button" id="modalCancelChange">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                <!-- table container area -->
                <div class="table-container">
                {% if columns and data %}
                    <h3>Current table data</h3>
                    <table id="modify_data_table" class="display" style="width:100%" border="1">
                        <thead>
                            <tr>
                                {% for col in columns %}
                                <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr>
                                {% for item in row %}
                                {% set colname = columns[loop.index0] if columns|length > loop.index0 else '' %}
                                {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname == 'PO' or colname == 'IO' or colname == 'IO number' or colname == 'IO Number' or colname|lower == 'po' or colname|lower == 'io' or colname|lower == 'io number' or colname == 'Fiscal Year' or colname|lower == 'fiscal year' or colname|lower == 'fiscal_year' or colname == 'Capital Year' or colname|lower == 'capital year' or colname|lower == 'capital_year' or colname == 'Year' or colname|lower == 'year') %}
                                    <td>{{ item|as_int }}</td>
                                {% else %}
                                    <td>{{ item|one_decimal }}</td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- jQuery and DataTables JS (CDN with local fallback) -->
                    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
                    <script>
                        if (typeof jQuery === 'undefined') {
                            var s = document.createElement('script');
                            s.src = "{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}";
                            document.head.appendChild(s);
                        }
                    </script>
                    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
                    <script>
                        (function ensureDataTables(){
                            if (window.jQuery && (!jQuery.fn || !jQuery.fn.dataTable)) {
                                var s = document.createElement('script');
                                s.src = "{{ url_for('static', filename='vendor/jquery.dataTables.min.js') }}";
                                document.head.appendChild(s);
                            }
                        })();
                    </script>
                    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
                    <script>
                    (function initModifyTable(retries){
                        retries = retries || 20;
                        function init(){
                            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.dataTable) {
                                $('#modify_data_table').DataTable({ paging: true, searching: true, ordering: true, lengthMenu: [[10,25,50,100],[10,25,50,100]] });
                            } else if (retries > 0) {
                                setTimeout(function(){ initModifyTable(retries - 1); }, 200);
                            } else {
                                console.warn('DataTables not available for modify table.');
                            }
                        }
                        if (document.readyState === 'complete' || document.readyState === 'interactive') init(); else document.addEventListener('DOMContentLoaded', init);
                    })();
                    </script>
                {% endif %}
                </div>
            </div>
    <script>
        // Modal open/close logic
        (function(){
            var addBtn = document.getElementById('add_button');
            var modal = document.getElementById('modifyModal');
            var modalClose = document.getElementById('modalClose');
            var modalOverlay = document.getElementById('modalOverlay');
            var modalCancel = document.getElementById('modalCancel');

            function openModal(){
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden','false');
                // prevent background scrolling
                document.body.style.overflow = 'hidden';
                // focus first input
                var firstInput = modal.querySelector('input, select, button');
                if(firstInput) firstInput.focus();
            }
            function closeModal(){
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            addBtn && addBtn.addEventListener('click', openModal);
            modalClose && modalClose.addEventListener('click', closeModal);
            modalOverlay && modalOverlay.addEventListener('click', closeModal);
            modalCancel && modalCancel.addEventListener('click', closeModal);

            // Modify modal handlers
            var modifyBtn = document.getElementById('modify_button');
            var modalChange = document.getElementById('modifyModalChange');
            var modalCloseChange = document.getElementById('modalCloseChange');
            var modalOverlayChange = document.getElementById('modalOverlayChange');
            var modalCancelChange = document.getElementById('modalCancelChange');

            function openChangeModal(){
                modalChange.style.display = 'block';
                modalChange.setAttribute('aria-hidden','false');
                document.body.style.overflow = 'hidden';
                var firstInput = modalChange.querySelector('input, select, button');
                if(firstInput) firstInput.focus();
            }
            function closeChangeModal(){
                modalChange.style.display = 'none';
                modalChange.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            modifyBtn && modifyBtn.addEventListener('click', openChangeModal);
            modalCloseChange && modalCloseChange.addEventListener('click', closeChangeModal);
            modalOverlayChange && modalOverlayChange.addEventListener('click', closeChangeModal);
            modalCancelChange && modalCancelChange.addEventListener('click', closeChangeModal);
            // close on escape
            document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeModal(); });
        })();
    </script>
    <script>
        // When selects inside modify modal change (PO, Department, Cap Year, Project), notify server so module-level vars update
        (function () {
            var modal = document.getElementById('modifyModal');
            function attachChangeHandlers() {
                if (!modal) return;
                // PO
                var poSelects = modal.querySelectorAll('select[name="po"], select[id="po"], select[name="PO"], select[id="PO"]');
                poSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        // notify server of PO selection (module-level state)
                        fetch('/capex_forecast/po_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ po: val }) }).catch(function () { });

                        // After notifying server, request updated department list filtered by this PO
                        try {
                            var url = '/capex_forecast/department_update?po=' + encodeURIComponent(val);
                            fetch(url).then(function (res) {
                                if (!res.ok) return null;
                                return res.json();
                            }).then(function (data) {
                                if (!data || !data.departments) return;
                                // rebuild department selects inside the modal
                                var deptSelects = modal.querySelectorAll('select[name="department"], select[id="department"], select[name="Department"], select[id="Department"]');
                                deptSelects.forEach(function (dsel) {
                                    // preserve a default placeholder option
                                    dsel.innerHTML = '';
                                    var placeholder = document.createElement('option');
                                    placeholder.value = '';
                                    placeholder.disabled = true;
                                    placeholder.selected = true;
                                    placeholder.textContent = 'Select an option';
                                    dsel.appendChild(placeholder);
                                    data.departments.forEach(function (opt) {
                                        var o = document.createElement('option');
                                        o.value = opt;
                                        o.textContent = opt;
                                        dsel.appendChild(o);
                                    });
                                });
                            }).catch(function () { /* ignore */ });
                        } catch (e) {
                            /* ignore */
                        }
                    });
                });

                // Department
                var deptSelects = modal.querySelectorAll('select[name="department"], select[id="department"], select[name="Department"], select[id="Department"]');
                deptSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        fetch('/capex_forecast/department_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ department: val }) }).catch(function () { });
                        // attempt to refresh projects if PO, Department and Cap Year are selected
                        try {
                            var currentPO = (modal.querySelector('select[name="po"]') || modal.querySelector('select[id="po"]'))?.value || '';
                            var currentDept = val;
                            var currentFY = (modal.querySelector('select[name="cap_year"]') || modal.querySelector('select[id="cap_year"]'))?.value || '';
                            if (currentPO && currentDept && currentFY) {
                                var url = '/capex_forecast/project_update?po=' + encodeURIComponent(currentPO) + '&department=' + encodeURIComponent(currentDept) + '&fiscal_year=' + encodeURIComponent(currentFY);
                                fetch(url).then(function (res) {
                                    if (!res.ok) return null;
                                    return res.json();
                                }).then(function (data) {
                                    if (!data || !data.projects) return;
                                    var projSelects = modal.querySelectorAll('select[name="project_name"], select[id="project_name"], select[name="Project Name"], select[id="Project Name"]');
                                    projSelects.forEach(function (ps) {
                                        ps.innerHTML = '';
                                        var placeholder = document.createElement('option');
                                        placeholder.value = '';
                                        placeholder.disabled = true;
                                        placeholder.selected = true;
                                        placeholder.textContent = 'Select an option';
                                        ps.appendChild(placeholder);
                                        data.projects.forEach(function (opt) {
                                            var o = document.createElement('option');
                                            o.value = opt;
                                            o.textContent = opt;
                                            ps.appendChild(o);
                                        });
                                    });
                                }).catch(function () { });
                            }
                        } catch (e) { /* ignore */ }
                    });
                });

                // Cap Year
                var capYearSelects = modal.querySelectorAll('select[name="cap_year"], select[id="cap_year"], select[name="CapYear"], select[id="CapYear"]');
                capYearSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        fetch('/capex_forecast/cap_year_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cap_year: val }) }).catch(function () { });
                        // when cap year changes, try to refresh projects if PO & Department are set
                        try {
                            var currentPO = (modal.querySelector('select[name="po"]') || modal.querySelector('select[id="po"]'))?.value || '';
                            var currentDept = (modal.querySelector('select[name="department"]') || modal.querySelector('select[id="department"]'))?.value || '';
                            var currentFY = val;
                            if (currentPO && currentDept && currentFY) {
                                var url = '/capex_forecast/project_update?po=' + encodeURIComponent(currentPO) + '&department=' + encodeURIComponent(currentDept) + '&fiscal_year=' + encodeURIComponent(currentFY);
                                fetch(url).then(function (res) {
                                    if (!res.ok) return null;
                                    return res.json();
                                }).then(function (data) {
                                    if (!data || !data.projects) return;
                                    var projSelects = modal.querySelectorAll('select[name="project_name"], select[id="project_name"], select[name="Project Name"], select[id="Project Name"]');
                                    projSelects.forEach(function (ps) {
                                        ps.innerHTML = '';
                                        var placeholder = document.createElement('option');
                                        placeholder.value = '';
                                        placeholder.disabled = true;
                                        placeholder.selected = true;
                                        placeholder.textContent = 'Select an option';
                                        ps.appendChild(placeholder);
                                        data.projects.forEach(function (opt) {
                                            var o = document.createElement('option');
                                            o.value = opt;
                                            o.textContent = opt;
                                            ps.appendChild(o);
                                        });
                                    });
                                }).catch(function () { });
                            }
                        } catch (e) { /* ignore */ }
                    });
                });

                // Project Name
                var projSelects = modal.querySelectorAll('select[name="project_name"], select[id="project_name"], select[name="Project Name"], select[id="Project Name"]');
                projSelects.forEach(function (sel) {
                    sel.addEventListener('change', function () {
                        var val = sel.value || '';
                        fetch('/capex_forecast/project_selection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: val }) }).catch(function () { });
                    });
                });
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') attachChangeHandlers(); else document.addEventListener('DOMContentLoaded', attachChangeHandlers);
            // Also attach when modal opens (in case fields are re-rendered)
            var addBtn = document.getElementById('add_button');
            if (addBtn) addBtn.addEventListener('click', function () { setTimeout(attachChangeHandlers, 30); });
        })();
    </script>
    {% if table_name == 'projects' %}
    <script>
        // For Modify Project: filter Department options by selected PO within the Add modal
        (function(){
            var modal = document.getElementById('modifyModal');
            if (!modal) return;
            function attachHandlers(){
                var poSel = modal.querySelector('select[name="po"], #po');
                var deptSel = modal.querySelector('select[name="department"], #department');
                if (!poSel || !deptSel) return;
                function rebuildDeptOptions(list){
                    try{
                        while (deptSel.firstChild) deptSel.removeChild(deptSel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.disabled = true;
                        placeholder.selected = true;
                        placeholder.textContent = 'Select an option';
                        deptSel.appendChild(placeholder);
                        (list || []).forEach(function(name){
                            var opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            deptSel.appendChild(opt);
                        });
                    }catch(e){}
                }
                function fetchDepartments(){
                    var val = poSel.value || '';
                    if (!val) { rebuildDeptOptions([]); return; }
                    fetch('/modify_project/departments?po=' + encodeURIComponent(val))
                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                        .then(function(json){ rebuildDeptOptions(json && json.departments ? json.departments : []); })
                        .catch(function(){ rebuildDeptOptions([]); });
                }
                poSel.addEventListener('change', fetchDepartments);
                // initialize once in case a PO is preselected
                fetchDepartments();
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') attachHandlers(); else document.addEventListener('DOMContentLoaded', attachHandlers);
            // Also attach when Add modal opens
            var addBtn = document.getElementById('add_button');
            if (addBtn) addBtn.addEventListener('click', function(){ setTimeout(function(){ attachHandlers(); }, 30); });
        })();
    </script>
    {% endif %}
    {% if table_name == 'human_resource_cost' %}
    <script>
        // For Staff Cost: filter Staff Category options by selected PO within both Add and Modify modals
        (function(){
            function rebuildOptions(selectEl, values){
                if (!selectEl) return;
                try {
                    while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);
                    var placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    placeholder.textContent = 'Select an option';
                    selectEl.appendChild(placeholder);
                    (values || []).forEach(function(v){
                        var o = document.createElement('option');
                        o.value = v;
                        o.textContent = v;
                        selectEl.appendChild(o);
                    });
                } catch(e) {}
            }
            function attachHandlersForModal(modalEl){
                if (!modalEl) return;
                var poSel = modalEl.querySelector('select[name="po"]');
                var catSel = modalEl.querySelector('select[name="staff_category"]');
                if (!poSel || !catSel) return;
                function refreshCategories(){
                    var po = poSel.value || '';
                    if (!po){ rebuildOptions(catSel, []); return; }
                    fetch('/modify_staff_cost/categories?po=' + encodeURIComponent(po))
                        .then(function(res){ return res.ok ? res.json() : { categories: [] }; })
                        .then(function(json){ rebuildOptions(catSel, (json && json.categories) ? json.categories : []); })
                        .catch(function(){ rebuildOptions(catSel, []); });
                }
                poSel.addEventListener('change', refreshCategories);
                // Initialize once in case a PO is preselected
                refreshCategories();
            }
            function onReady(){
                attachHandlersForModal(document.getElementById('modifyModal'));
                attachHandlersForModal(document.getElementById('modifyModalChange'));
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') onReady(); else document.addEventListener('DOMContentLoaded', onReady);
            var addBtn = document.getElementById('add_button');
            var modifyBtn = document.getElementById('modify_button');
            if (addBtn) addBtn.addEventListener('click', function(){ setTimeout(onReady, 30); });
            if (modifyBtn) modifyBtn.addEventListener('click', function(){ setTimeout(onReady, 30); });
        })();
    </script>
    {% endif %}
    <style>
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; }
        .modal-overlay { position: absolute; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4); }
        .modal-content { position: relative; max-width: 760px; margin: 60px auto; background: #fff; border-radius: 6px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 2010; }
        .modal-close { position: absolute; right: 10px; top: 8px; font-size: 24px; background: transparent; border: none; cursor: pointer; }
        /* Ensure form layout inside modal looks consistent */
        .modal-content .form-group { margin-bottom: 14px; }
    </style>
</body>
</html>