<!DOCTYPE html>
<html>
<head>
    <title>Modify Project & IO</title>
    <style>
        .form-group { display: flex; align-items: center; margin-bottom: 14px; }
        .form-group label { flex: 1 1 33%; max-width: 33%; min-width: 120px; text-align: left; margin-right: 12px; }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"] { flex: 2 1 67%; max-width: 67%; min-width: 0; }
        .container { padding: 24px 0 0 0; }
        .page-wrapper { display: flex; flex-direction: column; height: calc(100vh - 0px); box-sizing: border-box; }
        .page-top { flex: 0 0 auto; box-sizing: border-box; padding: 24px 24px 0 24px; }
        .tables-row { display: flex; gap: 24px; padding: 12px 24px 24px 24px; box-sizing: border-box; }
        .table-half { flex: 1 1 50%; overflow: auto; }
        .button-row { display: flex; gap: 12px; align-items: center; }
        .button-row button { padding: 6px 12px; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; }
        .modal-overlay { position: absolute; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4); }
        .modal-content { position: relative; max-width: 760px; margin: 60px auto; background: #fff; border-radius: 6px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 2010; }
        .modal-close { position: absolute; right: 10px; top: 8px; font-size: 24px; background: transparent; border: none; cursor: pointer; }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}
    <div class="page-wrapper">
        <div class="page-top">
            <div class="container">
                <h1>Project & IO Management</h1>
                <div class="button-row">
                    <button id="add_project_button" type="button">Add new project</button>
                    <button id="modify_project_button" type="button">Modify existing project</button>
                </div>
            </div>
        </div>

        <!-- Project Add/Modify Modal -->
        <div id="projectModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="projectModalTitle">
            <div class="modal-overlay" id="projectOverlay"></div>
            <div class="modal-content" role="document">
                <button class="modal-close" id="projectClose" aria-label="Close">&times;</button>
                <h2 id="projectModalTitle">Project</h2>
                <form method="POST" name="Modify_projects" id="projectForm">
                    <input type="hidden" name="form_kind" value="project">
                    <input type="hidden" name="table_name" value="projects">
                    <input type="hidden" name="edit_mode" id="proj_edit_mode" value="0">
                    <input type="hidden" name="project_id" id="proj_project_id" value="">
                    <!-- Existing project selector (shown only in edit mode) -->
                    <div class="form-group" id="proj_existing_container" style="display:none;">
                        <label for="proj_existing_project">Existing Project</label>
                        <select name="existing_project" id="proj_existing_project">
                            <option value="" disabled selected>Select a project</option>
                            {% for p in project_names %}
                                <option value="{{ p.name }}" data-id="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% for field in project_fields %}
                        <div class="form-group">
                            <label for="proj_{{ field.name }}">{{ field.label }}</label>
                            {% if field.type == 'select' %}
                                <select name="{{ field.name }}" id="proj_{{ field.name }}" required>
                                    <option value="" disabled selected>Select an option</option>
                                    {% for option in field.options %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                                <input type="{{ field.type }}" name="{{ field.name }}" id="proj_{{ field.name }}" required>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <!-- IO numbers for merged add flow (supports multiple) -->
                    <div class="form-group" id="proj_io_group">
                        <label>IO Number(s)</label>
                        <div id="ioInputs" style="display:flex;flex-direction:column;gap:8px;">
                            <div class="io-row" style="display:flex;gap:8px;align-items:center;">
                                <input type="number" name="IO" class="proj_io_input" placeholder="Optional: IO number for this project">
                                <button type="button" class="io-add">+</button>
                                <button type="button" class="io-del">-</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:12px;">
                        <button type="submit">Submit</button>
                        <button type="button" id="projectCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

    
        
            <!-- Interactive generic tables (Projects & IOs) -->
            <div class="tables-row">
                <div class="table-half">
                    <h3>Projects</h3>
                    <div id="gt-projects" style="height:300px;"></div>
                </div>
                <div class="table-half">
                    <h3>IOs</h3>
                    <div id="gt-ios" style="height:300px;"></div>
                </div>
            </div>
    </div>

        <!-- Generic table module -->
        <script src="{{ url_for('static', filename='js/genericTable.js') }}"></script>

    <!-- IO Modify Modal (reintroduced for IO row click edits) -->
    <div id="ioModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="ioModalTitle">
        <div class="modal-overlay" id="ioOverlay"></div>
        <div class="modal-content" role="document">
            <button class="modal-close" id="ioClose" aria-label="Close">&times;</button>
            <h2 id="ioModalTitle">Modify IO</h2>
            <form method="POST" name="Modify_ios" id="ioForm" action="/modify_io/change_io">
                <input type="hidden" name="form_kind" value="io">
                <input type="hidden" name="table_name" value="ios">
                <input type="hidden" name="io_edit_mode" id="io_edit_mode" value="1">
                <input type="hidden" name="io_id" id="io_id" value="">
                {% for field in io_fields %}
                    <div class="form-group">
                        <label for="io_{{ field.name }}">{{ field.label }}</label>
                        {% if field.type == 'select' %}
                            <select name="{{ field.name }}" id="io_{{ field.name }}" required>
                                <option value="" disabled selected>Select an option</option>
                                {% for option in field.options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        {% elif field.type == 'text' or field.type == 'password' or field.type == 'number' %}
                            <input type="{{ field.type }}" name="{{ field.name }}" id="io_{{ field.name }}"{% if not (field.name|lower in ['io','io_num','io number','io_number']) %} required{% endif %}>
                        {% endif %}
                    </div>
                {% endfor %}
                <div style="margin-top:12px;">
                    <button type="submit">Submit</button>
                    <button type="button" id="ioCancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Basic modal open/close wiring
        (function(){
            function open(modal){ modal.style.display='block'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
                var firstInput = modal.querySelector('input,select,button'); if(firstInput) firstInput.focus(); }
            function close(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

            var projModal = document.getElementById('projectModal');
            var addProjBtn = document.getElementById('add_project_button');
            var modProjBtn = document.getElementById('modify_project_button');
            var projClose = document.getElementById('projectClose');
            var projOverlay = document.getElementById('projectOverlay');
            var projCancel = document.getElementById('projectCancel');
            function setIoFieldVisible(visible){
                var grp = document.getElementById('proj_io_group');
                if(grp) grp.style.display = visible ? '' : 'none';
            }
            // Add mode
            addProjBtn && addProjBtn.addEventListener('click', function(){
                // Reset edit mode
                var form = document.getElementById('projectForm');
                document.getElementById('proj_edit_mode').value = '0';
                document.getElementById('proj_project_id').value = '';
                var existC = document.getElementById('proj_existing_container');
                if (existC) existC.style.display = 'none';
                // reset form action to default (post back to same route)
                form.removeAttribute('action');
                // clear fields
                try { form.reset(); } catch(e){}
                // Show IO field in add mode
                setIoFieldVisible(true);
                // Reset IO inputs to a single empty row
                try { if (window.IOInputs && typeof window.IOInputs.reset === 'function') window.IOInputs.reset(); } catch(e){}
                open(projModal);
            });
            // Edit mode
            modProjBtn && modProjBtn.addEventListener('click', function(){
                var form = document.getElementById('projectForm');
                document.getElementById('proj_edit_mode').value = '1';
                var existC = document.getElementById('proj_existing_container');
                if (existC) existC.style.display = '';
                // set form action to change endpoint
                form.action = '/modify_project/change_project';
                // Show IO field in edit mode (IO can be added/removed)
                setIoFieldVisible(true);
                open(projModal);
            });
            [projClose, projOverlay, projCancel].forEach(function(el){ el && el.addEventListener('click', function(){ close(projModal); }); });

            // IO modification is integrated into the Project modal
        })();
    </script>

    <script>
        // Mount generic tables and wire row-click to open the existing edit modals
        (function(){
            function fetchJSON(url){
                return fetch(url).then(function(r){ return r.ok ? r.json() : {columns:[], rows:[]}; }).catch(function(){ return {columns:[], rows:[]}; });
            }
            function mountTable(elId, title, listUrl, onRowClick){
                var el = document.getElementById(elId);
                if(!el) return;
                fetchJSON(listUrl).then(function(data){
                    if(!window.GenericTable || !GenericTable.create) return;
                    GenericTable.create(el, {
                        title: title,
                        columns: data.columns || [],
                        rows: data.rows || [],
                        onRowClick: onRowClick
                    });
                });
            }

            function openProjectEdit(row){
                try{
                    // Switch to edit mode (triggers showing existing project selector)
                    var modBtn = document.getElementById('modify_project_button');
                    if(modBtn) modBtn.click();
                    // Set existing project and trigger details fetch (handled by existing change listener)
                    var existSel = document.getElementById('proj_existing_project');
                    if(existSel && row && row.Project){
                        existSel.value = row.Project;
                        existSel.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }catch(e){}
            }

            function openIoEdit(row){
                try{
                    var modal = document.getElementById('ioModal');
                    var overlay = document.getElementById('ioOverlay');
                    var closeBtn = document.getElementById('ioClose');
                    var cancelBtn = document.getElementById('ioCancel');
                    function open(){
                        modal.style.display='block';
                        modal.setAttribute('aria-hidden','false');
                        document.body.style.overflow='hidden';
                        var first = modal.querySelector('input,select,button'); if(first) first.focus();
                    }
                    function close(){
                        modal.style.display='none';
                        modal.setAttribute('aria-hidden','true');
                        document.body.style.overflow='';
                    }
                    [overlay, closeBtn, cancelBtn].forEach(function(el){ if(el) el.onclick = close; });

                    // Prefill fields using the IO value from the row
                    var ioInput = document.getElementById('io_IO');
                    var projSel = document.getElementById('io_project_name');
                    var hid = document.getElementById('io_id');
                    var editMode = document.getElementById('io_edit_mode');
                    if (editMode) editMode.value = '1';
                    if (ioInput && row && row.IO != null) ioInput.value = String(row.IO);
                    // Fetch additional details by IO number to set hidden id and project
                    if (row && row.IO != null){
                        fetch('/modify_io/details?io=' + encodeURIComponent(row.IO))
                            .then(function(res){ return res.ok ? res.json() : null; })
                            .then(function(info){
                                if(!info) return;
                                try{
                                    if (hid && info.id != null) hid.value = String(info.id);
                                    if (projSel && info.project_name != null) projSel.value = String(info.project_name);
                                }catch(e){}
                            })
                            .catch(function(){});
                    }
                    open();
                }catch(e){}
            }

            // Mount both tables
            mountTable('gt-projects', 'Projects', "{{ url_for('modify_tables.list_projects') }}", openProjectEdit);
            mountTable('gt-ios', 'IOs', "{{ url_for('modify_tables.list_ios') }}", openIoEdit);
        })();
    </script>

    <script>
        // Filter Department options by selected PO within the Project modal
        (function(){
            var modal = document.getElementById('projectModal');
            if (!modal) return;
            function attachHandlers(){
                var poSel = modal.querySelector('select[name="po"], #proj_po');
                var deptSel = modal.querySelector('select[name="department"], #proj_department');
                var existSel = document.getElementById('proj_existing_project');
                if (!poSel || !deptSel) return;
                function rebuildDeptOptions(list){
                    try{
                        while (deptSel.firstChild) deptSel.removeChild(deptSel.firstChild);
                        var placeholder = document.createElement('option');
                        placeholder.value = ''; placeholder.disabled = true; placeholder.selected = true; placeholder.textContent = 'Select an option';
                        deptSel.appendChild(placeholder);
                        (list || []).forEach(function(name){
                            var opt = document.createElement('option'); opt.value = name; opt.textContent = name; deptSel.appendChild(opt);
                        });
                    }catch(e){}
                }
                function fetchDepartments(){
                    var val = poSel.value || '';
                    if (!val) { rebuildDeptOptions([]); return; }
                    fetch('/modify_project/departments?po=' + encodeURIComponent(val))
                        .then(function(res){ return res.ok ? res.json() : { departments: [] }; })
                                            .then(function(json){ rebuildDeptOptions(json && json.departments ? json.departments : []); })
                        .catch(function(){ rebuildDeptOptions([]); });
                }
                poSel.addEventListener('change', fetchDepartments);
                fetchDepartments();

                // When existing project is selected, fetch details and prefill form
                if (existSel) {
                    existSel.addEventListener('change', function(){
                        var name = existSel.value || '';
                        if (!name) return;
                        fetch('/modify_project/details?name=' + encodeURIComponent(name))
                            .then(function(res){ return res.ok ? res.json() : null; })
                            .then(function(info){
                                if (!info) return;
                                try {
                                    // set hidden id
                                    var hid = document.getElementById('proj_project_id');
                                    if (hid) hid.value = info.id || '';
                                    // Fill fields: name, category, po, then dept after options refreshed, fiscal_year
                                    var nameInput = document.getElementById('proj_name');
                                    if (nameInput && info.name != null) nameInput.value = info.name;
                                    var catSel = document.getElementById('proj_category');
                                    if (catSel && info.category != null) catSel.value = info.category;
                                    if (poSel && info.po != null) {
                                        poSel.value = info.po;
                                        // refresh departments then set department
                                        fetch('/modify_project/departments?po=' + encodeURIComponent(info.po))
                                            .then(function(res){ return res.ok ? res.json() : {departments: []}; })
                                            .then(function(json){
                                                rebuildDeptOptions(json && json.departments ? json.departments : []);
                                                if (deptSel && info.department != null) {
                                                    deptSel.value = info.department;
                                                }
                                            })
                                            .catch(function(){
                                                if (deptSel && info.department != null) deptSel.value = info.department;
                                            });
                                    }
                                    var fySel = document.getElementById('proj_fiscal_year');
                                    if (fySel && info.fiscal_year != null) fySel.value = String(info.fiscal_year);
                                    // Prefill IO inputs with existing IOs for this project
                                    try {
                                        var pid = (hid && hid.value) ? hid.value : null;
                                        if (pid) {
                                            fetch('/modify_project/project_ios?project_id=' + encodeURIComponent(pid))
                                                .then(function(r){ return r.ok ? r.json() : { ios: [] }; })
                                                .then(function(json){
                                                    var ios = (json && Array.isArray(json.ios)) ? json.ios : [];
                                                    if (window.IOInputs && typeof window.IOInputs.reset === 'function') {
                                                        window.IOInputs.reset();
                                                        var container = document.getElementById('ioInputs');
                                                        if (container) {
                                                            var firstInput = container.querySelector('input.proj_io_input');
                                                            if (ios.length > 0) {
                                                                if (firstInput) firstInput.value = ios[0];
                                                                for (var i = 1; i < ios.length; i++) {
                                                                    if (window.IOInputs.addRow) window.IOInputs.addRow(String(ios[i]));
                                                                }
                                                            }
                                                        }
                                                    }
                                                })
                                                .catch(function(){});
                                        }
                                    } catch(e){}
                                } catch(e) {}
                            })
                            .catch(function(){});
                    });
                }
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') attachHandlers(); else document.addEventListener('DOMContentLoaded', attachHandlers);
        })();
    </script>

    <script>
        // Dynamic add/remove IO input rows for the Project modal (supports multiple IOs)
        (function(){
            function getContainer(){ return document.getElementById('ioInputs'); }
            function addRow(prefill){
                var container = getContainer();
                if(!container) return;
                var row = document.createElement('div');
                row.className = 'io-row';
                row.style.display = 'flex';
                row.style.gap = '8px';
                row.style.alignItems = 'center';
                var input = document.createElement('input');
                input.type = 'number';
                input.name = 'IO';
                input.className = 'proj_io_input';
                input.placeholder = 'Optional: IO number for this project';
                if(prefill != null) input.value = prefill;
                var addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'io-add';
                addBtn.textContent = '+';
                var delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'io-del';
                delBtn.textContent = '-';
                row.appendChild(input);
                row.appendChild(addBtn);
                row.appendChild(delBtn);
                container.appendChild(row);
            }
            function reset(){
                var container = getContainer();
                if(!container) return;
                container.innerHTML = '';
                addRow();
            }
            function onClick(e){
                var t = e.target;
                if(t.classList && t.classList.contains('io-add')){
                    e.preventDefault();
                    addRow();
                }
                if(t.classList && t.classList.contains('io-del')){
                    e.preventDefault();
                    var row = t.closest('.io-row');
                    if(row && row.parentNode){ row.parentNode.removeChild(row); }
                }
            }
            document.addEventListener('DOMContentLoaded', function(){
                var container = getContainer();
                if(!container) return;
                container.addEventListener('click', onClick);
            });
            // Expose minimal API for other scripts
            window.IOInputs = { addRow: addRow, reset: reset };
        })();
    </script>

    <script>
        // Prefill IO modal fields when selecting an existing IO in edit mode
        (function(){
            var ioModal = document.getElementById('ioModal');
            if (!ioModal) return;
            function attachHandlers(){
                var existSel = document.getElementById('io_existing_select');
                var ioInput = document.getElementById('io_IO');
                var projSel = document.getElementById('io_project_name');
                if (!existSel || !projSel) return;
                existSel.addEventListener('change', function(){
                    var id = existSel.value || '';
                    if (!id) return;
                    fetch('/modify_io/details?id=' + encodeURIComponent(id))
                        .then(function(res){ return res.ok ? res.json() : null; })
                        .then(function(info){
                            if (!info) return;
                            try {
                                var hid = document.getElementById('io_id');
                                if (hid) hid.value = info.id || '';
                                if (ioInput && info.io != null) ioInput.value = info.io;
                                if (projSel && info.project_name != null) projSel.value = info.project_name;
                            } catch(e){}
                        })
                        .catch(function(){});
                });
            }
            if (document.readyState === 'complete' || document.readyState === 'interactive') attachHandlers(); else document.addEventListener('DOMContentLoaded', attachHandlers);
        })();
    </script>
</body>
</html>
