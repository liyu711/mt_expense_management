{% extends 'basic_page.html' %}
{% block title %}Select Data{% endblock %}
{% block head %}
    {# GenericTable injects its own minimal styles; no external CSS needed #}
{% endblock %}
{% block page_title %}Select Data{% endblock %}
{% block content %}
    <div>
        <form method="POST" id="table_name">
            <label for="table_name">Table Name:</label>
            <select id="table_name" name="table_name">
                {% for option in options %}
                    {% set label = display_names[option] if display_names is defined and option in display_names else option %}
                    <option value="{{ option }}" {% if option == selected_option %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit">Retrieve Data</button>
        </form>
        <!-- canvas for plotting the data, currently removed -->
        <!-- {% if data %}
            {% set chart_tables = [
                'budgets', 'expenses', 'fundings', 'human_resource_expense', 'project_forecasts_nonpc', 'project_forecasts_pc',
                'capex_forecasts', 'capex_budgets', 'capex_expenses'] %}
            {% if selected_option in chart_tables %}
                <form id="chart-form" method="POST">
                    <input type="hidden" name="table_name" value="{{ selected_option }}">
                    <label for="x_col">X Axis:</label>
                    <select name="x_col" id="x_col">
                        {% for col in columns %}
                        <option value="{{ col }}" {% if col == request.form.x_col %}selected{% endif %}>{{ col }}</option>
                        {% endfor %}
                    </select>
                    <label for="y_col">Y Axis:</label>
                    <select name="y_col" id="y_col">
                        {% for col in columns %}
                        <option value="{{ col }}" {% if col == request.form.y_col %}selected{% endif %}>{{ col }}</option>
                        {% endfor %}
                    </select>
                    <label for="plot_type">Plot Type:</label>
                    <select name="plot_type" id="plot_type">
                        <option value="bar" {% if request.form.plot_type == 'bar' %}selected{% endif %}>Bar Chart</option>
                        <option value="line" {% if request.form.plot_type == 'line' %}selected{% endif %}>Line Chart</option>
                    </select>
                    <button type="submit">Plot</button>
                </form>
                <div>
                    <canvas id="chartCanvas" width="600" height="400"></canvas>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script id="chart-data-json" type="application/json">{{ data|tojson|safe }}</script>
                <script id="chart-columns-json" type="application/json">{{ columns|tojson|safe }}</script>
                <script>
                const xCol = "{{ request.form.x_col|default('') }}";
                const yCol = "{{ request.form.y_col|default('') }}";
                const plotType = "{{ request.form.plot_type|default('bar') }}";
                const chartData = JSON.parse(document.getElementById('chart-data-json').textContent);
                const chartColumns = JSON.parse(document.getElementById('chart-columns-json').textContent);
                if (xCol && yCol && chartColumns.includes(xCol) && chartColumns.includes(yCol)) {
                    const xIdx = chartColumns.indexOf(xCol);
                    const yIdx = chartColumns.indexOf(yCol);
                    // Group by xCol and sum yCol
                    const groupMap = {};
                    chartData.forEach(row => {
                        const xVal = row[xIdx];
                        let yVal = row[yIdx];
                        // Try to convert yVal to number
                        yVal = typeof yVal === 'number' ? yVal : parseFloat(yVal);
                        if (!isNaN(yVal)) {
                            if (groupMap[xVal] === undefined) {
                                groupMap[xVal] = 0;
                            }
                            groupMap[xVal] += yVal;
                        }
                    });
                    const labels = Object.keys(groupMap);
                    const values = labels.map(l => groupMap[l]);
                    const ctx = document.getElementById('chartCanvas').getContext('2d');
                    new Chart(ctx, {
                        type: plotType,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: yCol + ' (sum) by ' + xCol,
                                data: values,
                                backgroundColor: plotType === 'bar' ? 'rgba(54, 162, 235, 0.5)' : 'rgba(255, 99, 132, 0.2)',
                                borderColor: plotType === 'bar' ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
                </script>
            {% endif %} -->
            <div id="gt-select" style="height:600px;"
                 data-cols='{{ (columns or [])|tojson|safe }}'
                 data-rows='{{ (data or [])|tojson|safe }}'></div>
            <script src="{{ url_for('static', filename='js/genericTable.js') }}"></script>
            <script>
                (function(){
                    function mount(){
                        var el = document.getElementById('gt-select');
                        if(!el || !window.GenericTable || !GenericTable.create) return;
                        try{
                            var cols = JSON.parse(el.getAttribute('data-cols') || '[]');
                            var raw = JSON.parse(el.getAttribute('data-rows') || '[]');
                            // Map array rows (from server) into objects keyed by column names
                            var rows = (raw || []).map(function(r){
                                if (r && typeof r === 'object' && !Array.isArray(r)) return r; // already an object
                                var o = {}; (cols || []).forEach(function(c, i){ o[c] = (Array.isArray(r) ? r[i] : null); });
                                return o;
                            });
                            GenericTable.create(el, {
                                columns: cols,
                                rows: rows,
                                defaultPageSize: 25
                            });
                        }catch(e){ console.warn('Failed to mount select table', e); }
                    }
                    if (document.readyState === 'complete' || document.readyState === 'interactive') mount(); else document.addEventListener('DOMContentLoaded', mount);
                })();
            </script>
        {% endif %}
    </div>
{% endblock %}