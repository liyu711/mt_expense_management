<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Data</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body>
    {% include 'sidebar.html' %}
    <div style="margin-left:50px;">
        <form method="POST" id="table_name">
            <label for="table_name">Table Name:</label>
            <select id="table_name" name="table_name">
                {% for option in options %}
                    {% set label = display_names[option] if display_names is defined and option in display_names else option %}
                    <option value="{{ option }}" {% if option == selected_option %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit">Retrieve Data</button>
        </form>
        <!-- canvas for plotting the data, currently removed -->
        <!-- {% if data %}
            {% set chart_tables = [
                'budgets', 'expenses', 'fundings', 'human_resource_expense', 'project_forecasts_nonpc', 'project_forecasts_pc',
                'capex_forecasts', 'capex_budgets', 'capex_expenses'] %}
            {% if selected_option in chart_tables %}
                <form id="chart-form" method="POST">
                    <input type="hidden" name="table_name" value="{{ selected_option }}">
                    <label for="x_col">X Axis:</label>
                    <select name="x_col" id="x_col">
                        {% for col in columns %}
                        <option value="{{ col }}" {% if col == request.form.x_col %}selected{% endif %}>{{ col }}</option>
                        {% endfor %}
                    </select>
                    <label for="y_col">Y Axis:</label>
                    <select name="y_col" id="y_col">
                        {% for col in columns %}
                        <option value="{{ col }}" {% if col == request.form.y_col %}selected{% endif %}>{{ col }}</option>
                        {% endfor %}
                    </select>
                    <label for="plot_type">Plot Type:</label>
                    <select name="plot_type" id="plot_type">
                        <option value="bar" {% if request.form.plot_type == 'bar' %}selected{% endif %}>Bar Chart</option>
                        <option value="line" {% if request.form.plot_type == 'line' %}selected{% endif %}>Line Chart</option>
                    </select>
                    <button type="submit">Plot</button>
                </form>
                <div>
                    <canvas id="chartCanvas" width="600" height="400"></canvas>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script id="chart-data-json" type="application/json">{{ data|tojson|safe }}</script>
                <script id="chart-columns-json" type="application/json">{{ columns|tojson|safe }}</script>
                <script>
                const xCol = "{{ request.form.x_col|default('') }}";
                const yCol = "{{ request.form.y_col|default('') }}";
                const plotType = "{{ request.form.plot_type|default('bar') }}";
                const chartData = JSON.parse(document.getElementById('chart-data-json').textContent);
                const chartColumns = JSON.parse(document.getElementById('chart-columns-json').textContent);
                if (xCol && yCol && chartColumns.includes(xCol) && chartColumns.includes(yCol)) {
                    const xIdx = chartColumns.indexOf(xCol);
                    const yIdx = chartColumns.indexOf(yCol);
                    // Group by xCol and sum yCol
                    const groupMap = {};
                    chartData.forEach(row => {
                        const xVal = row[xIdx];
                        let yVal = row[yIdx];
                        // Try to convert yVal to number
                        yVal = typeof yVal === 'number' ? yVal : parseFloat(yVal);
                        if (!isNaN(yVal)) {
                            if (groupMap[xVal] === undefined) {
                                groupMap[xVal] = 0;
                            }
                            groupMap[xVal] += yVal;
                        }
                    });
                    const labels = Object.keys(groupMap);
                    const values = labels.map(l => groupMap[l]);
                    const ctx = document.getElementById('chartCanvas').getContext('2d');
                    new Chart(ctx, {
                        type: plotType,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: yCol + ' (sum) by ' + xCol,
                                data: values,
                                backgroundColor: plotType === 'bar' ? 'rgba(54, 162, 235, 0.5)' : 'rgba(255, 99, 132, 0.2)',
                                borderColor: plotType === 'bar' ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
                </script>
            {% endif %} -->
            <table border="1" id="data_table" class="display" style="width:100%">
                <thead>
                    <tr>
                        {% for col in columns %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        {# Empty footer cells - DataTables will populate these with select filters #}
                        {% for col in columns %}
                        <th></th>
                        {% endfor %}
                    </tr>
                </tfoot>
                <tbody>
                    {% for row in data %}
                    <tr>
                    {% for item in row %}
                    {% set colname = columns[loop.index0] if columns|length > loop.index0 else '' %}
                    {% if colname and (colname|lower == 'id' or (colname|lower)[-3:] == '_id' or (colname|lower)[-2:] == 'id' or colname == 'PO' or colname == 'IO' or colname|lower == 'po' or colname|lower == 'io' or colname == 'Month' or colname|lower == 'month' or colname == 'Fiscal Year' or colname|lower == 'fiscal year' or colname|lower == 'fiscal_year') %}
                        <td>{{ item|as_int }}</td>
                    {% else %}
                        <td>{{ item|one_decimal }}</td>
                    {% endif %}
                    {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- jQuery and DataTables JS (CDN with local fallback) -->
            <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
            <script>
                // If CDN jQuery fails (no network), load local fallback if present
                if (typeof jQuery === 'undefined') {
                    var s = document.createElement('script');
                    s.src = "{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}";
                    document.head.appendChild(s);
                }
            </script>
            <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
            <script>
                // If CDN DataTables fails, load local fallback
                (function ensureDataTables(){
                    if (window.jQuery && (!jQuery.fn || !jQuery.fn.dataTable)) {
                        var s = document.createElement('script');
                        s.src = "{{ url_for('static', filename='vendor/jquery.dataTables.min.js') }}";
                        document.head.appendChild(s);
                    }
                })();
            </script>
            <!-- DataTables CSS (CDN with local fallback) -->
            <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
            <script>
            // Resilient init: wait until jQuery and DataTables are available, then initialize
            (function initDataTableRetry(retries){
                retries = retries || 20; // try for ~4 seconds (20 * 200ms)
                function init(){
                    if (window.jQuery && window.jQuery.fn && window.jQuery.fn.dataTable) {
                        (function($){
                            var table = $('#data_table').DataTable({
                                paging: true,
                                searching: true,
                                ordering: true,
                                lengthMenu: [ [10, 25, 50, 100], [10, 25, 50, 100] ],
                                initComplete: function () {
                                    // Whitelist of columns that should get a select filter
                                    var allowedCols = ['fiscal_year', 'cap_year', 'department', 'PO', 'category', 'category_id', 'Department', 'IO', 'Project Category'];
                                    // For each column, add a select filter in the footer only if the column is in the whitelist
                                    this.api().columns().every(function () {
                                        var column = this;
                                        var colTitle = $(column.header()).text().trim();
                                        // If this column is not in the allowed list, leave the footer cell empty
                                        if (allowedCols.indexOf(colTitle) === -1) {
                                            $(column.footer()).empty();
                                            return;
                                        }

                                        var footerCell = $(column.footer());
                                        // Create a select element
                                        var select = $('<select><option value="">(All)</option></select>')
                                            .appendTo(footerCell.empty())
                                            .on('change', function () {
                                                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                                // Use exact match when possible
                                                column.search(val ? '^' + val + '$' : '', true, false).draw();
                                            });

                                        // Populate the select with unique, sorted values from the column
                                        column.data().unique().sort().each(function (d, j) {
                                            if (d === null || d === undefined) d = '';
                                            var text = (typeof d === 'object') ? JSON.stringify(d) : d;
                                            select.append('<option value="' + text + '">' + text + '</option>');
                                        });
                                    });
                                }
                            });
                        })(jQuery);
                    } else if (retries > 0) {
                        setTimeout(function(){ initDataTableRetry(retries - 1); }, 200);
                    } else {
                        console.warn('DataTables not available; table will not be enhanced.');
                    }
                }
                // Kick off after DOM ready
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    init();
                } else {
                    document.addEventListener('DOMContentLoaded', init);
                }
            })();
            </script>
        {% endif %}
    </div>
</body>
</html>